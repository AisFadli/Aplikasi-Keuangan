<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceFlow Pro - Sistem Akuntansi Bisnis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#06b6d4',
                        dark: '#0f172a',
                        'dark-light': '#1e293b'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white">
    <!-- Navigation -->
    <nav class="glass-effect p-4 mb-4 md:mb-8">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-4 md:mb-0">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm md:text-lg">FF</span>
                    </div>
                    <h1 class="text-lg md:text-2xl font-bold bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">
                        FinanceFlow Pro
                    </h1>
                </div>
                <button onclick="toggleMobileMenu()" class="md:hidden text-white p-2">
                    <span id="hamburger">‚ò∞</span>
                </button>
            </div>
            <div id="mobileMenu" class="hidden md:flex md:justify-center md:space-x-6">
                <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-6 w-full md:w-auto">
                    <button onclick="showSection('dashboard')" class="nav-btn px-4 py-3 md:py-2 rounded-lg hover:bg-white/10 transition-all active text-left md:text-center">Dashboard</button>
                    <button onclick="showSection('transactions')" class="nav-btn px-4 py-3 md:py-2 rounded-lg hover:bg-white/10 transition-all text-left md:text-center">Transaksi</button>
                    <button onclick="showSection('ledger')" class="nav-btn px-4 py-3 md:py-2 rounded-lg hover:bg-white/10 transition-all text-left md:text-center">Buku Besar</button>
                    <button onclick="showSection('reconciliation')" class="nav-btn px-4 py-3 md:py-2 rounded-lg hover:bg-white/10 transition-all text-left md:text-center">Rekonsiliasi Bank</button>
                    <button onclick="showSection('assets')" class="nav-btn px-4 py-3 md:py-2 rounded-lg hover:bg-white/10 transition-all text-left md:text-center">Aset</button>
                    <button onclick="showSection('reports')" class="nav-btn px-4 py-3 md:py-2 rounded-lg hover:bg-white/10 transition-all text-left md:text-center">Laporan</button>
                    <button onclick="showSection('settings')" class="nav-btn px-4 py-3 md:py-2 rounded-lg hover:bg-white/10 transition-all text-left md:text-center">Pengaturan</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
                <!-- Summary Cards -->
                <div class="glass-effect p-4 md:p-6 rounded-xl card-hover">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-300 text-xs md:text-sm">Total Aset</p>
                            <p class="text-lg md:text-2xl font-bold text-green-400 truncate" id="totalAssets">Rp 0</p>
                        </div>
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-green-500/20 rounded-lg flex items-center justify-center ml-3">
                            <span class="text-green-400 text-lg md:text-xl">üí∞</span>
                        </div>
                    </div>
                </div>
                
                <div class="glass-effect p-4 md:p-6 rounded-xl card-hover">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-300 text-xs md:text-sm">Total Liabilitas</p>
                            <p class="text-lg md:text-2xl font-bold text-red-400 truncate" id="totalLiabilities">Rp 0</p>
                        </div>
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-red-500/20 rounded-lg flex items-center justify-center ml-3">
                            <span class="text-red-400 text-lg md:text-xl">üìä</span>
                        </div>
                    </div>
                </div>
                
                <div class="glass-effect p-4 md:p-6 rounded-xl card-hover">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-300 text-xs md:text-sm">Modal</p>
                            <p class="text-lg md:text-2xl font-bold text-blue-400 truncate" id="totalEquity">Rp 0</p>
                        </div>
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-500/20 rounded-lg flex items-center justify-center ml-3">
                            <span class="text-blue-400 text-lg md:text-xl">üè¶</span>
                        </div>
                    </div>
                </div>
                
                <div class="glass-effect p-4 md:p-6 rounded-xl card-hover">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-300 text-xs md:text-sm">Laba Bulan Ini</p>
                            <p class="text-lg md:text-2xl font-bold text-purple-400 truncate" id="monthlyProfit">Rp 0</p>
                        </div>
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-purple-500/20 rounded-lg flex items-center justify-center ml-3">
                            <span class="text-purple-400 text-lg md:text-xl">üìà</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="glass-effect p-4 md:p-6 rounded-xl mb-6 md:mb-8">
                <h3 class="text-lg md:text-xl font-semibold mb-4">Transaksi Terbaru</h3>
                <div class="overflow-x-auto -mx-4 md:mx-0">
                    <table class="w-full min-w-[600px]">
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="text-left py-2 md:py-3 px-2 md:px-4 text-sm md:text-base">Tanggal</th>
                                <th class="text-left py-2 md:py-3 px-2 md:px-4 text-sm md:text-base">Deskripsi</th>
                                <th class="text-left py-2 md:py-3 px-2 md:px-4 text-sm md:text-base">Akun</th>
                                <th class="text-right py-2 md:py-3 px-2 md:px-4 text-sm md:text-base">Debit</th>
                                <th class="text-right py-2 md:py-3 px-2 md:px-4 text-sm md:text-base">Kredit</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactions">
                            <tr class="border-b border-gray-700">
                                <td class="py-2 md:py-3 px-2 md:px-4 text-gray-300 text-sm md:text-base" colspan="5">Belum ada transaksi</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div id="transactions" class="section hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                <h2 class="text-2xl md:text-3xl font-bold">Pencatatan Transaksi</h2>
                <button onclick="showTransactionForm()" class="bg-gradient-to-r from-primary to-secondary px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold hover:shadow-lg transition-all text-sm md:text-base w-full sm:w-auto">
                    + Transaksi Baru
                </button>
            </div>

            <!-- Transaction Form -->
            <div id="transactionForm" class="glass-effect p-6 rounded-xl mb-8 hidden">
                <h3 class="text-xl font-semibold mb-4">Jurnal Umum</h3>
                <form onsubmit="addTransaction(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Tanggal</label>
                            <input type="date" id="transactionDate" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">No. Referensi</label>
                            <input type="text" id="transactionRef" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" placeholder="REF001">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Deskripsi</label>
                        <input type="text" id="transactionDesc" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" placeholder="Deskripsi transaksi" required>
                    </div>
                    
                    <div id="journalEntries">
                        <div class="journal-entry grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-3 md:p-4 bg-dark-light/50 rounded-lg">
                            <div class="sm:col-span-2 lg:col-span-1">
                                <label class="block text-sm font-medium mb-2">Akun</label>
                                <select class="account-select w-full p-2 md:p-3 bg-dark border border-gray-600 rounded-lg text-white text-sm md:text-base" required>
                                    <option value="">Pilih Akun</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Debit</label>
                                <input type="number" class="debit-amount w-full p-2 md:p-3 bg-dark border border-gray-600 rounded-lg text-white text-sm md:text-base" placeholder="0" min="0" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Kredit</label>
                                <input type="number" class="credit-amount w-full p-2 md:p-3 bg-dark border border-gray-600 rounded-lg text-white text-sm md:text-base" placeholder="0" min="0" step="0.01">
                            </div>
                            <div class="flex items-end sm:col-span-2 lg:col-span-1">
                                <button type="button" onclick="removeJournalEntry(this)" class="w-full p-2 md:p-3 bg-red-600 hover:bg-red-700 rounded-lg transition-all text-sm md:text-base">Hapus</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <button type="button" onclick="addJournalEntry()" class="bg-accent hover:bg-accent/80 px-4 py-2 rounded-lg transition-all">+ Tambah Baris</button>
                        <div class="text-right">
                            <p class="text-sm text-gray-300">Total Debit: <span id="totalDebit" class="font-semibold">Rp 0</span></p>
                            <p class="text-sm text-gray-300">Total Kredit: <span id="totalCredit" class="font-semibold">Rp 0</span></p>
                            <p class="text-sm" id="balanceStatus">Status: Belum Seimbang</p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="submit" class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            Simpan Transaksi
                        </button>
                        <button type="button" onclick="hideTransactionForm()" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold transition-all">
                            Batal
                        </button>
                    </div>
                </form>
            </div>

            <!-- Transaction List -->
            <div class="glass-effect p-6 rounded-xl">
                <h3 class="text-xl font-semibold mb-4">Daftar Transaksi</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="text-left py-3 px-4">Tanggal</th>
                                <th class="text-left py-3 px-4">Ref</th>
                                <th class="text-left py-3 px-4">Deskripsi</th>
                                <th class="text-left py-3 px-4">Akun</th>
                                <th class="text-right py-3 px-4">Debit</th>
                                <th class="text-right py-3 px-4">Kredit</th>
                                <th class="text-center py-3 px-4">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="transactionList">
                            <tr>
                                <td class="py-3 px-4 text-gray-300" colspan="7">Belum ada transaksi</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bank Reconciliation Section -->
        <div id="reconciliation" class="section hidden">
            <h2 class="text-2xl md:text-3xl font-bold mb-6">Rekonsiliasi Bank</h2>
            
            <!-- Bank Selection & Period -->
            <div class="glass-effect p-6 rounded-xl mb-6">
                <h3 class="text-xl font-semibold mb-4">Pilih Bank & Periode</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Akun Bank</label>
                        <select id="reconciliationBankSelect" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" onchange="loadBankTransactions()">
                            <option value="">Pilih Akun Bank</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tanggal Mulai</label>
                        <input type="date" id="reconciliationStartDate" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" onchange="loadBankTransactions()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tanggal Akhir</label>
                        <input type="date" id="reconciliationEndDate" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" onchange="loadBankTransactions()">
                    </div>
                    <div class="flex items-end">
                        <button onclick="downloadBankTemplate()" class="w-full bg-gradient-to-r from-green-600 to-green-700 px-4 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            üìä Download Template
                        </button>
                    </div>
                </div>
                
                <!-- Import Bank Statement -->
                <div class="border-t border-gray-600 pt-4">
                    <h4 class="font-semibold mb-3">Import Mutasi Bank</h4>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <input type="file" id="bankStatementFile" accept=".csv,.xlsx,.xls" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-white hover:file:bg-primary/80">
                        </div>
                        <button onclick="importBankStatement()" class="bg-accent hover:bg-accent/80 px-6 py-3 rounded-lg font-semibold transition-all">
                            üì§ Import Data
                        </button>
                    </div>
                    <p class="text-sm text-gray-400 mt-2">
                        Format yang didukung: CSV, Excel (.xlsx, .xls). Gunakan template yang telah disediakan untuk format yang benar.
                    </p>
                </div>
            </div>

            <!-- Reconciliation Summary -->
            <div id="reconciliationSummary" class="glass-effect p-6 rounded-xl mb-6 hidden">
                <h3 class="text-xl font-semibold mb-4">Ringkasan Rekonsiliasi</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-dark-light/50 p-4 rounded-lg">
                        <p class="text-gray-300 text-sm">Saldo Buku</p>
                        <p class="text-xl font-bold text-blue-400" id="bookBalance">Rp 0</p>
                    </div>
                    <div class="bg-dark-light/50 p-4 rounded-lg">
                        <p class="text-gray-300 text-sm">Saldo Bank</p>
                        <p class="text-xl font-bold text-green-400" id="bankBalance">Rp 0</p>
                    </div>
                    <div class="bg-dark-light/50 p-4 rounded-lg">
                        <p class="text-gray-300 text-sm">Selisih</p>
                        <p class="text-xl font-bold text-red-400" id="balanceDifference">Rp 0</p>
                    </div>
                    <div class="bg-dark-light/50 p-4 rounded-lg">
                        <p class="text-gray-300 text-sm">Status</p>
                        <p class="text-lg font-bold" id="reconciliationStatus">Belum Selesai</p>
                    </div>
                </div>
            </div>

            <!-- Reconciliation Content -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Book Transactions -->
                <div class="glass-effect p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Transaksi Buku</h3>
                        <button onclick="showManualTransactionForm()" class="bg-primary hover:bg-primary/80 px-4 py-2 rounded-lg transition-all text-sm">
                            + Manual Entry
                        </button>
                    </div>
                    
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-dark-light">
                                <tr class="border-b border-gray-600">
                                    <th class="text-left py-2 px-2">‚úì</th>
                                    <th class="text-left py-2 px-2">Tanggal</th>
                                    <th class="text-left py-2 px-2">Deskripsi</th>
                                    <th class="text-right py-2 px-2">Jumlah</th>
                                </tr>
                            </thead>
                            <tbody id="bookTransactionsList">
                                <tr>
                                    <td class="py-4 px-2 text-center text-gray-400" colspan="4">
                                        Pilih akun bank untuk melihat transaksi
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bank Statement -->
                <div class="glass-effect p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Mutasi Bank</h3>
                        <div class="text-sm text-gray-300" id="bankStatementInfo">
                            Import data mutasi bank
                        </div>
                    </div>
                    
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-dark-light">
                                <tr class="border-b border-gray-600">
                                    <th class="text-left py-2 px-2">‚úì</th>
                                    <th class="text-left py-2 px-2">Tanggal</th>
                                    <th class="text-left py-2 px-2">Deskripsi</th>
                                    <th class="text-right py-2 px-2">Jumlah</th>
                                    <th class="text-center py-2 px-2">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="bankStatementList">
                                <tr>
                                    <td class="py-4 px-2 text-center text-gray-400" colspan="5">
                                        Import file mutasi bank untuk memulai rekonsiliasi
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Quick Create From Bank Modal -->
                    <div id="quickCreateFromBank" class="hidden fixed inset-0 z-50 items-center justify-center">
                        <div class="absolute inset-0 bg-black/60"></div>
                        <div class="relative bg-slate-900 w-full max-w-2xl mx-4 rounded-xl border border-gray-700 shadow-2xl">
                            <div class="flex items-center justify-between p-4 border-b border-gray-700">
                                <h4 class="font-semibold text-lg">Buat Jurnal dari Mutasi Bank</h4>
                                <button onclick="closeQuickCreateFromBank()" class="text-gray-300 hover:text-white">‚úï</button>
                            </div>
                            <div class="p-4 space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm mb-1">Tanggal</label>
                                        <input id="qcbDate" type="date" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white"/>
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1">Referensi</label>
                                        <input id="qcbRef" type="text" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" placeholder="AUTO"/>
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1">Jumlah</label>
                                        <input id="qcbAmount" type="number" step="0.01" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white"/>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm mb-1">Deskripsi</label>
                                    <input id="qcbDesc" type="text" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white"/>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm mb-1">Akun Bank</label>
                                        <select id="qcbBank" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white"></select>
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1">Akun Lawan (kode - nama)</label>
                                        <select id="qcbCounter" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white"></select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm mb-1">Jenis</label>
                                        <select id="qcbType" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white">
                                            <option value="debit">Debit (Kas Masuk)</option>
                                            <option value="credit">Kredit (Kas Keluar)</option>
                                        </select>
                                    </div>
                                    <div class="flex items-end">
                                        <button onclick="toggleQcbAdvanced()" class="w-full bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg">Opsi Lanjutan</button>
                                    </div>
                                </div>
                                <div id="qcbAdvanced" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm mb-1">Kode Akun (manual, opsional)</label>
                                        <input id="qcbManualCode" type="text" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" placeholder="contoh: 5100"/>
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1">Nominal (override, opsional)</label>
                                        <input id="qcbManualAmount" type="number" step="0.01" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" placeholder="Biarkan kosong untuk pakai jumlah di atas"/>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border-t border-gray-700 flex justify-between gap-3">
                                <button onclick="saveQcbAsDraft()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-3 rounded-lg font-semibold">Simpan sebagai Draft</button>
                                <div class="flex gap-2">
                                    <button onclick="createJournalFromQcb()" class="bg-green-600 hover:bg-green-700 px-5 py-3 rounded-lg font-semibold">Buat Jurnal</button>
                                    <button onclick="closeQuickCreateFromBank()" class="bg-gray-600 hover:bg-gray-700 px-5 py-3 rounded-lg font-semibold">Batal</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Transaction Form -->
            <div id="manualTransactionForm" class="glass-effect p-6 rounded-xl mt-6 hidden">
                <h3 class="text-xl font-semibold mb-4">Input Transaksi Manual</h3>
                <form onsubmit="addManualTransaction(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Tanggal</label>
                            <input type="date" id="manualTransactionDate" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Referensi</label>
                            <input type="text" id="manualTransactionRef" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" placeholder="REF001">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Deskripsi</label>
                            <input type="text" id="manualTransactionDesc" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" placeholder="Deskripsi transaksi" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Jumlah</label>
                            <input type="number" id="manualTransactionAmount" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" step="0.01" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Tipe Transaksi</label>
                            <select id="manualTransactionType" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required>
                                <option value="">Pilih Tipe</option>
                                <option value="debit">Debit (Masuk)</option>
                                <option value="credit">Kredit (Keluar)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Akun Lawan</label>
                            <select id="manualTransactionAccount" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required>
                                <option value="">Pilih Akun</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            Simpan Transaksi
                        </button>
                        <button type="button" onclick="hideManualTransactionForm()" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold transition-all">
                            Batal
                        </button>
                    </div>
                </form>
            </div>

            <!-- Reconciliation Actions -->
            <div id="reconciliationActions" class="glass-effect p-6 rounded-xl mt-6 hidden">
                <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
                    <div>
                        <h4 class="font-semibold">Aksi Rekonsiliasi</h4>
                        <p class="text-sm text-gray-300">Selesaikan proses rekonsiliasi bank</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="autoMatchTransactions()" class="bg-accent hover:bg-accent/80 px-4 py-2 rounded-lg transition-all">
                            üîÑ Auto Match
                        </button>
                        <button onclick="completeReconciliation()" class="bg-gradient-to-r from-primary to-secondary px-4 py-2 rounded-lg font-semibold hover:shadow-lg transition-all">
                            ‚úÖ Selesaikan
                        </button>
                        <button onclick="exportReconciliation()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition-all">
                            üìä Export
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- General Ledger Section -->
        <div id="ledger" class="section hidden">
            <h2 class="text-2xl md:text-3xl font-bold mb-6">Buku Besar</h2>
            
            <!-- Filter Section -->
            <div class="glass-effect p-6 rounded-xl mb-6">
                <h3 class="text-xl font-semibold mb-4">Filter & Pencarian</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Pilih Akun</label>
                        <select id="ledgerAccountSelect" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" onchange="filterLedger()">
                            <option value="">Semua Akun</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Jenis Akun</label>
                        <select id="ledgerAccountType" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" onchange="filterLedger()">
                            <option value="">Semua Jenis</option>
                            <option value="Aset">Aset</option>
                            <option value="Liabilitas">Liabilitas</option>
                            <option value="Modal">Modal</option>
                            <option value="Pendapatan">Pendapatan</option>
                            <option value="Beban">Beban</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tanggal Awal</label>
                        <input type="date" id="ledgerStartDate" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" onchange="filterLedger()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tanggal Akhir</label>
                        <input type="date" id="ledgerEndDate" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" onchange="filterLedger()">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium mb-2">Cari Nama Akun</label>
                        <input type="text" id="ledgerSearchInput" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" placeholder="Ketik nama akun..." oninput="filterLedger()">
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="resetLedgerFilter()" class="bg-gray-600 hover:bg-gray-700 px-4 py-3 rounded-lg transition-all">
                            üîÑ Reset
                        </button>
                        <button onclick="exportLedger()" class="bg-gradient-to-r from-green-600 to-green-700 px-4 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            üìä Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ledger Summary -->
            <div id="ledgerSummary" class="glass-effect p-6 rounded-xl mb-6 hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-dark-light/50 p-4 rounded-lg">
                        <p class="text-gray-300 text-sm">Total Transaksi</p>
                        <p class="text-xl font-bold text-blue-400" id="totalTransactions">0</p>
                    </div>
                    <div class="bg-dark-light/50 p-4 rounded-lg">
                        <p class="text-gray-300 text-sm">Total Debit</p>
                        <p class="text-xl font-bold text-green-400" id="totalDebitAmount">Rp 0</p>
                    </div>
                    <div class="bg-dark-light/50 p-4 rounded-lg">
                        <p class="text-gray-300 text-sm">Total Kredit</p>
                        <p class="text-xl font-bold text-red-400" id="totalCreditAmount">Rp 0</p>
                    </div>
                    <div class="bg-dark-light/50 p-4 rounded-lg">
                        <p class="text-gray-300 text-sm">Saldo Akhir</p>
                        <p class="text-xl font-bold text-purple-400" id="finalBalance">Rp 0</p>
                    </div>
                </div>
            </div>

            <!-- Ledger Content -->
            <div class="glass-effect p-6 rounded-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Riwayat Transaksi</h3>
                    <div class="text-sm text-gray-300" id="ledgerInfo">
                        Pilih akun untuk melihat riwayat transaksi
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[800px]">
                        <thead>
                            <tr class="border-b-2 border-gray-600">
                                <th class="text-left py-3 px-4">Tanggal</th>
                                <th class="text-left py-3 px-4">Ref</th>
                                <th class="text-left py-3 px-4">Deskripsi</th>
                                <th class="text-left py-3 px-4">Akun</th>
                                <th class="text-right py-3 px-4">Debit</th>
                                <th class="text-right py-3 px-4">Kredit</th>
                                <th class="text-right py-3 px-4">Saldo</th>
                            </tr>
                        </thead>
                        <tbody id="ledgerTableBody">
                            <tr>
                                <td class="py-8 px-4 text-center text-gray-400" colspan="7">
                                    <div class="flex flex-col items-center">
                                        <span class="text-4xl mb-2">üìö</span>
                                        <span>Pilih akun atau gunakan filter untuk melihat buku besar</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Assets Section -->
        <div id="assets" class="section hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                <h2 class="text-2xl md:text-3xl font-bold">Manajemen Aset</h2>
                <button onclick="showAssetForm()" class="bg-gradient-to-r from-primary to-secondary px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold hover:shadow-lg transition-all text-sm md:text-base w-full sm:w-auto">
                    + Aset Baru
                </button>
            </div>

            <!-- Asset Form -->
            <div id="assetForm" class="glass-effect p-6 rounded-xl mb-8 hidden">
                <h3 class="text-xl font-semibold mb-4">Tambah Aset Tetap</h3>
                <form onsubmit="addAsset(event)">
                    <input type="hidden" id="editAssetId" value="">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nama Aset</label>
                            <input type="text" id="assetName" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Kategori</label>
                            <select id="assetCategory" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required>
                                <option value="">Pilih Kategori</option>
                                <option value="Bangunan">Bangunan</option>
                                <option value="Kendaraan">Kendaraan</option>
                                <option value="Peralatan">Peralatan</option>
                                <option value="Furniture">Furniture</option>
                                <option value="Elektronik">Elektronik</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Harga Perolehan</label>
                            <input type="number" id="assetCost" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required min="0" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Tanggal Perolehan</label>
                            <input type="date" id="assetDate" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Umur Ekonomis (Tahun)</label>
                            <input type="number" id="assetLife" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required min="1">
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="flex items-center mb-3">
                            <input type="checkbox" id="assetDepreciable" class="w-4 h-4 text-primary bg-dark border-gray-600 rounded mr-3" checked onchange="toggleDepreciationFields()">
                            <label class="text-sm font-medium">Aset ini dikenakan penyusutan</label>
                        </div>
                        <p class="text-xs text-gray-400 mb-3">
                            ‚úì Aset tetap seperti bangunan, kendaraan, peralatan<br>
                            ‚úó Tanah, investasi, aset tidak berwujud tertentu
                        </p>
                    </div>
                    
                    <div id="depreciationFields" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nilai Residu</label>
                            <input type="number" id="assetResidual" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" min="0" step="0.01" value="0">
                            <p class="text-xs text-gray-400 mt-1">Nilai aset di akhir masa manfaat</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Metode Penyusutan</label>
                            <select id="assetDepreciationMethod" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white">
                                <option value="straight-line">Garis Lurus</option>
                                <option value="declining-balance">Saldo Menurun</option>
                                <option value="sum-of-years">Jumlah Angka Tahun</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            Simpan Aset
                        </button>
                        <button type="button" onclick="hideAssetForm()" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold transition-all">
                            Batal
                        </button>
                    </div>
                </form>
            </div>

            <!-- Asset List -->
            <div class="glass-effect p-6 rounded-xl">
                <h3 class="text-xl font-semibold mb-4">Daftar Aset</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="text-left py-3 px-4">Nama Aset</th>
                                <th class="text-left py-3 px-4">Kategori</th>
                                <th class="text-right py-3 px-4">Harga Perolehan</th>
                                <th class="text-right py-3 px-4">Akum. Penyusutan</th>
                                <th class="text-right py-3 px-4">Nilai Buku</th>
                                <th class="text-left py-3 px-4">Metode</th>
                                <th class="text-center py-3 px-4">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="assetList">
                            <tr>
                                <td class="py-3 px-4 text-gray-300" colspan="7">Belum ada aset</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="section hidden">
            <h2 class="text-2xl md:text-3xl font-bold mb-6">Laporan Keuangan</h2>
            
            <!-- Period Selection Controls -->
            <div class="glass-effect p-6 rounded-xl mb-6">
                <h3 class="text-xl font-semibold mb-4">üìÖ Periode Laporan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Tanggal Awal</label>
                        <input type="date" id="reportStartDate" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" onchange="validateReportPeriod()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tanggal Akhir</label>
                        <input type="date" id="reportEndDate" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" onchange="validateReportPeriod()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Periode Cepat</label>
                        <select id="quickPeriod" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" onchange="setQuickPeriod()">
                            <option value="">Pilih Periode</option>
                            <option value="today">Hari Ini</option>
                            <option value="this-week">Minggu Ini</option>
                            <option value="this-month">Bulan Ini</option>
                            <option value="last-month">Bulan Lalu</option>
                            <option value="this-quarter">Kuartal Ini</option>
                            <option value="last-quarter">Kuartal Lalu</option>
                            <option value="this-year">Tahun Ini</option>
                            <option value="last-year">Tahun Lalu</option>
                            <option value="ytd">Year to Date</option>
                            <option value="all-time">Semua Periode</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="refreshReports()" class="w-full bg-accent hover:bg-accent/80 px-4 py-3 rounded-lg font-semibold transition-all">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                <div id="periodValidation" class="text-sm text-gray-300">
                    Pilih periode untuk menghasilkan laporan yang akurat
                </div>
            </div>

            <!-- Report Type Selection -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
                <button onclick="generateReport('balance-sheet')" class="glass-effect p-6 rounded-xl card-hover text-left">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-3">‚öñÔ∏è</span>
                        <h3 class="text-xl font-semibold">Neraca</h3>
                    </div>
                    <p class="text-gray-300 text-sm">Posisi keuangan perusahaan</p>
                    <p class="text-xs text-gray-400 mt-1">Aset = Kewajiban + Ekuitas</p>
                </button>
                <button onclick="generateReport('income-statement')" class="glass-effect p-6 rounded-xl card-hover text-left">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-3">üìà</span>
                        <h3 class="text-xl font-semibold">Laba Rugi</h3>
                    </div>
                    <p class="text-gray-300 text-sm">Pendapatan dan beban</p>
                    <p class="text-xs text-gray-400 mt-1">Periode spesifik</p>
                </button>
                <button onclick="generateReport('cash-flow')" class="glass-effect p-6 rounded-xl card-hover text-left">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-3">üí∞</span>
                        <h3 class="text-xl font-semibold">Arus Kas</h3>
                    </div>
                    <p class="text-gray-300 text-sm">Metode langsung</p>
                    <p class="text-xs text-gray-400 mt-1">Operasi, Investasi, Pendanaan</p>
                </button>
                <button onclick="generateReport('trial-balance')" class="glass-effect p-6 rounded-xl card-hover text-left">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-3">üìä</span>
                        <h3 class="text-xl font-semibold">Neraca Saldo</h3>
                    </div>
                    <p class="text-gray-300 text-sm">Daftar saldo akun</p>
                    <p class="text-xs text-gray-400 mt-1">Debit = Kredit</p>
                </button>
            </div>

            <!-- Report Content -->
            <div id="reportContent" class="glass-effect p-6 rounded-xl hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h3 id="reportTitle" class="text-xl font-semibold"></h3>
                        <p id="reportPeriod" class="text-sm text-gray-300"></p>
                        <p id="reportTimestamp" class="text-xs text-gray-400"></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportReport()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition-all text-sm">
                            üìä Export CSV
                        </button>
                        <button onclick="printReport()" class="bg-primary hover:bg-primary/80 px-4 py-2 rounded-lg transition-all text-sm">
                            üñ®Ô∏è Cetak
                        </button>
                    </div>
                </div>
                
                <!-- Balance Status Alert -->
                <div id="balanceAlert" class="hidden mb-4 p-4 rounded-lg border-l-4">
                    <div class="flex items-center">
                        <span id="balanceIcon" class="text-2xl mr-3"></span>
                        <div>
                            <p id="balanceMessage" class="font-semibold"></p>
                            <p id="balanceDetail" class="text-sm opacity-80"></p>
                        </div>
                    </div>
                </div>
                
                <div id="reportData"></div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section hidden">
            <h2 class="text-2xl md:text-3xl font-bold mb-6">Pengaturan Sistem</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                <!-- Company Settings -->
                <div class="glass-effect p-6 rounded-xl">
                    <h3 class="text-xl font-semibold mb-4">Informasi Perusahaan</h3>
                    <form onsubmit="saveCompanySettings(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Nama Perusahaan *</label>
                                <input type="text" id="companyName" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" value="PT. Contoh Bisnis" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Alamat Lengkap *</label>
                                <textarea id="companyAddress" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" rows="3" required>Jl. Contoh No. 123, Jakarta Pusat 10110</textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Nomor Telepon</label>
                                    <input type="tel" id="companyPhone" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" placeholder="+62 21 1234567">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email Bisnis</label>
                                    <input type="email" id="companyEmail" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" placeholder="info@perusahaan.com">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">NPWP</label>
                                    <input type="text" id="companyNPWP" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" placeholder="01.234.567.8-901.000">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Jenis Bisnis *</label>
                                    <select id="businessType" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required>
                                        <option value="">Pilih Jenis Bisnis</option>
                                        <option value="retail">Retail/Eceran</option>
                                        <option value="wholesale">Grosir/Distributor</option>
                                        <option value="manufacturing">Manufaktur/Produksi</option>
                                        <option value="service">Jasa/Layanan</option>
                                        <option value="trading">Trading/Perdagangan</option>
                                        <option value="restaurant">Restoran/F&B</option>
                                        <option value="construction">Konstruksi</option>
                                        <option value="technology">Teknologi/IT</option>
                                        <option value="healthcare">Kesehatan</option>
                                        <option value="education">Pendidikan</option>
                                        <option value="other">Lainnya</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Mata Uang *</label>
                                    <select id="currency" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required>
                                        <option value="IDR">Rupiah (IDR)</option>
                                        <option value="USD">US Dollar (USD)</option>
                                        <option value="EUR">Euro (EUR)</option>
                                        <option value="SGD">Singapore Dollar (SGD)</option>
                                        <option value="MYR">Malaysian Ringgit (MYR)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Tahun Pajak *</label>
                                    <select id="taxYear" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                        <option value="2025">2025</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Tanggal Mulai Periode *</label>
                                    <input type="date" id="periodStart" class="w-full p-3 bg-dark-light border border-gray-600 rounded-lg text-white" required>
                                </div>
                            </div>
                            
                            <div class="bg-dark-light/50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2 text-accent">Informasi Tambahan</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Website</label>
                                        <input type="url" id="companyWebsite" class="w-full p-3 bg-dark border border-gray-600 rounded-lg text-white" placeholder="https://www.perusahaan.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Direktur/Pemilik</label>
                                        <input type="text" id="companyOwner" class="w-full p-3 bg-dark border border-gray-600 rounded-lg text-white" placeholder="Nama Direktur">
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium mb-2">Deskripsi Bisnis</label>
                                    <textarea id="businessDescription" class="w-full p-3 bg-dark border border-gray-600 rounded-lg text-white" rows="2" placeholder="Deskripsi singkat tentang bisnis Anda..."></textarea>
                                </div>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button type="submit" class="bg-gradient-to-r from-primary to-secondary px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                                    üíæ Simpan Pengaturan
                                </button>
                                <button type="button" onclick="resetCompanySettings()" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold transition-all">
                                    üîÑ Reset ke Default
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Chart of Accounts -->
                <div class="glass-effect p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Chart of Accounts</h3>
                        <button onclick="showAccountForm()" class="bg-accent hover:bg-accent/80 px-4 py-2 rounded-lg transition-all">+ Akun Baru</button>
                    </div>
                    
                    <div id="accountForm" class="mb-4 p-4 bg-dark-light/50 rounded-lg hidden">
                        <h4 class="font-semibold mb-3" id="accountFormTitle">Tambah Akun Baru</h4>
                        <form onsubmit="addAccount(event)">
                            <input type="hidden" id="editAccountId" value="">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Tipe Akun *</label>
                                    <select id="accountType" class="w-full p-2 bg-dark border border-gray-600 rounded text-white" required onchange="generateAccountCode()">
                                        <option value="">Pilih Tipe</option>
                                        <option value="Aset">Aset</option>
                                        <option value="Liabilitas">Liabilitas</option>
                                        <option value="Modal">Modal</option>
                                        <option value="Pendapatan">Pendapatan</option>
                                        <option value="Beban">Beban</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Kode Akun *</label>
                                    <div class="flex">
                                        <input type="text" id="accountCode" class="flex-1 p-2 bg-dark border border-gray-600 rounded-l text-white" required readonly>
                                        <button type="button" onclick="toggleCodeEdit()" class="px-3 bg-accent hover:bg-accent/80 border border-l-0 border-gray-600 rounded-r text-white text-sm">
                                            ‚úèÔ∏è
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Kode otomatis berdasarkan tipe akun</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Nama Akun *</label>
                                    <input type="text" id="accountName" class="w-full p-2 bg-dark border border-gray-600 rounded text-white" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Saldo Awal</label>
                                    <input type="number" id="accountBalance" class="w-full p-2 bg-dark border border-gray-600 rounded text-white" step="0.01" value="0">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Deskripsi (Opsional)</label>
                                <textarea id="accountDescription" class="w-full p-2 bg-dark border border-gray-600 rounded text-white" rows="2" placeholder="Deskripsi akun..."></textarea>
                            </div>
                            <div class="flex space-x-2">
                                <button type="submit" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded transition-all" id="accountSubmitBtn">Simpan</button>
                                <button type="button" onclick="hideAccountForm()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded transition-all">Batal</button>
                            </div>
                        </form>
                    </div>

                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-600">
                                    <th class="text-left py-2">Kode</th>
                                    <th class="text-left py-2">Nama Akun</th>
                                    <th class="text-left py-2">Tipe</th>
                                    <th class="text-right py-2">Saldo</th>
                                    <th class="text-center py-2">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="accountList">
                                <!-- Default accounts will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tax Settings -->
            <div class="glass-effect p-6 rounded-xl mt-8">
                <h3 class="text-xl font-semibold mb-4">‚öñÔ∏è Pengaturan Pajak Penghasilan</h3>
                
                <!-- Tax Application Toggle -->
                <div class="mb-6 p-4 bg-blue-900/20 rounded-lg border-l-4 border-blue-400">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="font-semibold text-blue-400 mb-2">Penerapan Pajak Penghasilan</h4>
                            <p class="text-sm text-gray-300">Aktifkan untuk menghitung pajak penghasilan pada Laporan Laba Rugi</p>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="enableIncomeTax" class="w-5 h-5 text-blue-600 bg-dark border-gray-600 rounded mr-3" onchange="toggleTaxSettings()">
                            <label for="enableIncomeTax" class="font-medium text-blue-400">Aktifkan Pajak</label>
                        </div>
                    </div>
                    
                    <div id="taxEnabledInfo" class="hidden">
                        <div class="bg-green-900/20 p-3 rounded border-l-2 border-green-400">
                            <p class="text-sm text-green-400">‚úÖ Pajak penghasilan akan dihitung otomatis pada Laporan Laba Rugi</p>
                        </div>
                    </div>
                    
                    <div id="taxDisabledInfo">
                        <div class="bg-gray-900/20 p-3 rounded border-l-2 border-gray-400">
                            <p class="text-sm text-gray-400">‚ÑπÔ∏è Pajak penghasilan tidak akan dihitung pada Laporan Laba Rugi</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tax Rate Configuration -->
                <div id="taxRateSettings" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Corporate Tax Rate -->
                        <div class="bg-dark-light/50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-orange-400">üìä Tarif Pajak Badan</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Tarif Pajak Efektif (%)</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="corporateTaxRate" class="flex-1 p-3 bg-dark border border-gray-600 rounded text-white" 
                                               value="25" min="0" max="100" step="0.1" onchange="updateTaxPreview()">
                                        <span class="text-gray-400">%</span>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Tarif pajak yang berlaku untuk perusahaan</p>
                                </div>
                                
                                <div class="bg-orange-900/20 p-3 rounded border border-orange-400/30">
                                    <h5 class="text-sm font-medium text-orange-300 mb-2">Referensi Tarif Pajak Indonesia:</h5>
                                    <div class="text-xs text-gray-300 space-y-1">
                                        <p>‚Ä¢ PT dengan omzet ‚â§ 4.8M: 0.5% dari omzet</p>
                                        <p>‚Ä¢ PT dengan omzet > 4.8M: 25% dari laba kena pajak</p>
                                        <p>‚Ä¢ PT Go Public: 22% (berlaku 2022)</p>
                                        <p>‚Ä¢ UMKM (PP 23/2018): 0.5% dari omzet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tax Calculation Method -->
                        <div class="bg-dark-light/50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-purple-400">‚öôÔ∏è Metode Perhitungan</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Basis Perhitungan Pajak</label>
                                    <select id="taxCalculationBasis" class="w-full p-3 bg-dark border border-gray-600 rounded text-white" onchange="updateTaxPreview()">
                                        <option value="income-before-tax">Laba Sebelum Pajak (EBT)</option>
                                        <option value="operating-income">Laba Operasional (EBIT)</option>
                                        <option value="gross-profit">Laba Kotor</option>
                                        <option value="revenue">Total Pendapatan</option>
                                    </select>
                                    <p class="text-xs text-gray-400 mt-1">Pilih basis untuk menghitung pajak penghasilan</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2">Minimum Taxable Income</label>
                                    <input type="number" id="minimumTaxableIncome" class="w-full p-3 bg-dark border border-gray-600 rounded text-white" 
                                           value="0" min="0" step="1000000" onchange="updateTaxPreview()">
                                    <p class="text-xs text-gray-400 mt-1">Batas minimum laba yang dikenakan pajak</p>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="roundTaxAmount" class="w-4 h-4 text-purple-600 bg-dark border-gray-600 rounded mr-3" checked>
                                    <label class="text-sm">Bulatkan jumlah pajak ke ribuan terdekat</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Tax Settings -->
                    <div class="bg-dark-light/30 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold mb-3 text-cyan-400">üîß Pengaturan Lanjutan</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Akun Beban Pajak</label>
                                <select id="taxExpenseAccount" class="w-full p-3 bg-dark border border-gray-600 rounded text-white">
                                    <option value="">Pilih Akun Beban Pajak</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Akun untuk mencatat beban pajak penghasilan</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Akun Utang Pajak</label>
                                <select id="taxPayableAccount" class="w-full p-3 bg-dark border border-gray-600 rounded text-white">
                                    <option value="">Pilih Akun Utang Pajak</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Akun untuk mencatat utang pajak penghasilan</p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="autoCreateTaxEntry" class="w-4 h-4 text-cyan-600 bg-dark border-gray-600 rounded mr-3">
                                <label class="text-sm font-medium">Buat jurnal pajak otomatis saat generate laporan</label>
                            </div>
                            <p class="text-xs text-gray-400 ml-7">Otomatis membuat jurnal beban pajak berdasarkan perhitungan laba rugi</p>
                        </div>
                    </div>
                    
                    <!-- Tax Preview -->
                    <div id="taxPreview" class="bg-gradient-to-r from-green-900/20 to-blue-900/20 p-4 rounded-lg border border-green-400/30">
                        <h4 class="font-semibold mb-3 text-green-400">üìä Preview Perhitungan Pajak</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div class="bg-dark-light/50 p-3 rounded">
                                <p class="text-gray-400 mb-1">Basis Perhitungan:</p>
                                <p class="font-semibold text-white" id="previewTaxBasis">Rp 0</p>
                            </div>
                            <div class="bg-dark-light/50 p-3 rounded">
                                <p class="text-gray-400 mb-1">Tarif Pajak:</p>
                                <p class="font-semibold text-orange-400" id="previewTaxRate">25%</p>
                            </div>
                            <div class="bg-dark-light/50 p-3 rounded">
                                <p class="text-gray-400 mb-1">Estimasi Pajak:</p>
                                <p class="font-semibold text-green-400" id="previewTaxAmount">Rp 0</p>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-gray-400">
                            <p>üí° Preview berdasarkan data transaksi saat ini. Nilai aktual akan dihitung saat generate Laporan Laba Rugi.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Save Tax Settings -->
                <div class="flex justify-between items-center pt-4 border-t border-gray-600">
                    <div class="text-sm text-gray-400">
                        <p>‚ö†Ô∏è Perubahan pengaturan pajak akan berlaku untuk laporan yang dibuat setelah penyimpanan</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="resetTaxSettings()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg font-semibold transition-all">
                            üîÑ Reset Default
                        </button>
                        <button onclick="saveTaxSettings()" class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                            üíæ Simpan Pengaturan Pajak
                        </button>
                    </div>
                </div>
            </div>

            <!-- Depreciation Settings -->
            <div class="glass-effect p-6 rounded-xl mt-8">
                <h3 class="text-xl font-semibold mb-4">Pengaturan Penyusutan</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="p-4 bg-dark-light/50 rounded-lg">
                        <h4 class="font-semibold mb-2">Metode Garis Lurus</h4>
                        <p class="text-sm text-gray-300">Penyusutan sama setiap periode</p>
                        <p class="text-xs text-gray-400 mt-2">Formula: (Harga Perolehan - Nilai Residu) / Umur Ekonomis</p>
                    </div>
                    <div class="p-4 bg-dark-light/50 rounded-lg">
                        <h4 class="font-semibold mb-2">Saldo Menurun</h4>
                        <p class="text-sm text-gray-300">Penyusutan menurun setiap periode</p>
                        <div class="mt-2">
                            <label class="block text-xs text-gray-400 mb-1">Rate Penyusutan (%)</label>
                            <input type="number" id="decliningRate" class="w-full p-2 bg-dark border border-gray-600 rounded text-white text-sm" value="20" min="1" max="100">
                        </div>
                    </div>
                    <div class="p-4 bg-dark-light/50 rounded-lg">
                        <h4 class="font-semibold mb-2">Jumlah Angka Tahun</h4>
                        <p class="text-sm text-gray-300">Berdasarkan proporsi tahun</p>
                        <p class="text-xs text-gray-400 mt-2">Penyusutan lebih besar di awal periode</p>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="glass-effect p-6 rounded-xl mt-8">
                <h3 class="text-xl font-semibold mb-4">üóÑÔ∏è Manajemen Data</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Backup Section -->
                    <div class="bg-blue-900/20 p-6 rounded-lg border-l-4 border-blue-400">
                        <h4 class="font-semibold text-lg mb-3 text-blue-400">üíæ Backup Data</h4>
                        <p class="text-sm text-gray-300 mb-4">
                            Backup semua data aplikasi termasuk transaksi, akun, aset, dan pengaturan perusahaan.
                        </p>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="backupTransactions" checked class="w-4 h-4 text-blue-600 bg-dark border-gray-600 rounded mr-3">
                                <label class="text-sm">Transaksi & Jurnal (<span id="transactionCount">0</span> item)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="backupAccounts" checked class="w-4 h-4 text-blue-600 bg-dark border-gray-600 rounded mr-3">
                                <label class="text-sm">Chart of Accounts (<span id="accountCount">0</span> item)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="backupAssets" checked class="w-4 h-4 text-blue-600 bg-dark border-gray-600 rounded mr-3">
                                <label class="text-sm">Aset Tetap (<span id="assetCount">0</span> item)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="backupSettings" checked class="w-4 h-4 text-blue-600 bg-dark border-gray-600 rounded mr-3">
                                <label class="text-sm">Pengaturan Perusahaan</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="backupReconciliation" checked class="w-4 h-4 text-blue-600 bg-dark border-gray-600 rounded mr-3">
                                <label class="text-sm">Riwayat Rekonsiliasi</label>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button onclick="createBackup()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold transition-all flex-1">
                                üì¶ Buat Backup
                            </button>
                            <button onclick="createAutoBackup()" class="bg-blue-800 hover:bg-blue-900 px-4 py-2 rounded-lg font-semibold transition-all flex-1">
                                ‚ö° Auto Backup
                            </button>
                        </div>
                        
                        <div class="mt-3 text-xs text-gray-400">
                            <p>üí° Tips: Lakukan backup secara berkala untuk keamanan data</p>
                            <p id="lastBackupInfo" class="mt-1"></p>
                        </div>
                    </div>
                    
                    <!-- Restore Section -->
                    <div class="bg-green-900/20 p-6 rounded-lg border-l-4 border-green-400">
                        <h4 class="font-semibold text-lg mb-3 text-green-400">üì• Restore Data</h4>
                        <p class="text-sm text-gray-300 mb-4">
                            Pulihkan data dari file backup yang telah dibuat sebelumnya.
                        </p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Pilih File Backup</label>
                                <input type="file" id="restoreFile" accept=".json,.bak" 
                                       class="w-full p-3 bg-dark border border-gray-600 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-green-600 file:text-white hover:file:bg-green-700">
                            </div>
                            
                            <div class="bg-yellow-900/20 p-3 rounded border-l-2 border-yellow-400">
                                <p class="text-xs text-yellow-300">
                                    ‚ö†Ô∏è <strong>Peringatan:</strong> Restore akan mengganti semua data yang ada. 
                                    Pastikan Anda telah membuat backup data saat ini.
                                </p>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="radio" id="restoreMerge" name="restoreMode" value="merge" checked class="w-4 h-4 text-green-600 bg-dark border-gray-600 mr-3">
                                    <label class="text-sm">Gabung dengan data existing</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="restoreReplace" name="restoreMode" value="replace" class="w-4 h-4 text-green-600 bg-dark border-gray-600 mr-3">
                                    <label class="text-sm">Ganti semua data (hapus existing)</label>
                                </div>
                            </div>
                            
                            <button onclick="restoreData()" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold transition-all">
                                üîÑ Restore Data
                            </button>
                        </div>
                        
                        <div class="mt-3 text-xs text-gray-400">
                            <p>üí° Tips: Validasi file backup sebelum restore</p>
                        </div>
                    </div>
                </div>
                
                <!-- Data Statistics -->
                <div class="mt-6 bg-gray-900/20 p-4 rounded-lg">
                    <h5 class="font-semibold mb-3 text-gray-300">üìä Statistik Data Aplikasi</h5>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="text-2xl font-bold text-blue-400" id="totalTransactionsStat">0</p>
                            <p class="text-xs text-gray-400">Total Transaksi</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-green-400" id="totalAccountsStat">0</p>
                            <p class="text-xs text-gray-400">Total Akun</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-purple-400" id="totalAssetsStat">0</p>
                            <p class="text-xs text-gray-400">Total Aset</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-orange-400" id="dataSize">0 KB</p>
                            <p class="text-xs text-gray-400">Ukuran Data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let accounts = [];
        let transactions = [];
        let assets = [];
        let bankStatements = [];
        let reconciliationData = {};
        let currentSection = 'dashboard';

        // Initialize default accounts
        function initializeDefaultAccounts() {
            const defaultAccounts = [
                {code: '1100', name: 'Kas', type: 'Aset', balance: 0, description: 'Kas di tangan perusahaan', isDefault: true},
                {code: '1200', name: 'Bank', type: 'Aset', balance: 0, description: 'Rekening bank perusahaan', isDefault: true},
                {code: '1300', name: 'Piutang Dagang', type: 'Aset', balance: 0, description: 'Tagihan kepada pelanggan', isDefault: true},
                {code: '1400', name: 'Persediaan', type: 'Aset', balance: 0, description: 'Barang dagangan', isDefault: true},
                {code: '1500', name: 'Peralatan', type: 'Aset', balance: 0, description: 'Peralatan operasional', isDefault: true},
                {code: '1600', name: 'Akumulasi Penyusutan Peralatan', type: 'Aset', balance: 0, description: 'Akumulasi penyusutan peralatan', isDefault: true},
                {code: '2100', name: 'Utang Dagang', type: 'Liabilitas', balance: 0, description: 'Utang kepada supplier', isDefault: true},
                {code: '2200', name: 'Utang Bank', type: 'Liabilitas', balance: 0, description: 'Pinjaman bank', isDefault: true},
                {code: '3100', name: 'Modal Saham', type: 'Modal', balance: 0, description: 'Modal disetor pemegang saham', isDefault: true},
                {code: '3200', name: 'Laba Ditahan', type: 'Modal', balance: 0, description: 'Akumulasi laba yang ditahan', isDefault: true},
                {code: '4100', name: 'Penjualan', type: 'Pendapatan', balance: 0, description: 'Pendapatan dari penjualan', isDefault: true},
                {code: '5100', name: 'Harga Pokok Penjualan', type: 'Beban', balance: 0, description: 'Biaya langsung produksi', isDefault: true},
                {code: '5200', name: 'Beban Gaji', type: 'Beban', balance: 0, description: 'Gaji karyawan', isDefault: true},
                {code: '5300', name: 'Beban Sewa', type: 'Beban', balance: 0, description: 'Biaya sewa tempat usaha', isDefault: true},
                {code: '5400', name: 'Beban Penyusutan', type: 'Beban', balance: 0, description: 'Penyusutan aset tetap', isDefault: true},
                {code: '5500', name: 'Beban Pajak Penghasilan', type: 'Beban', balance: 0, description: 'Beban pajak penghasilan badan', isDefault: true},
                {code: '2300', name: 'Utang Pajak Penghasilan', type: 'Liabilitas', balance: 0, description: 'Utang pajak penghasilan yang belum dibayar', isDefault: true}
            ];
            
            accounts = [...defaultAccounts];
            updateAccountList();
            updateAccountSelects();
        }

        // Account code generation
        function generateAccountCode() {
            const accountType = document.getElementById('accountType').value;
            const editId = document.getElementById('editAccountId').value;
            
            if (!accountType) {
                document.getElementById('accountCode').value = '';
                return;
            }
            
            // Don't auto-generate if editing existing account
            if (editId) return;
            
            const codeRanges = {
                'Aset': { start: 1000, prefix: '1' },
                'Liabilitas': { start: 2000, prefix: '2' },
                'Modal': { start: 3000, prefix: '3' },
                'Pendapatan': { start: 4000, prefix: '4' },
                'Beban': { start: 5000, prefix: '5' }
            };
            
            const range = codeRanges[accountType];
            if (!range) return;
            
            // Find next available code
            const existingCodes = accounts
                .filter(acc => acc.code.startsWith(range.prefix))
                .map(acc => parseInt(acc.code))
                .sort((a, b) => a - b);
            
            let nextCode = range.start;
            for (const code of existingCodes) {
                if (code === nextCode) {
                    nextCode += 100; // Increment by 100 for sub-categories
                } else {
                    break;
                }
            }
            
            document.getElementById('accountCode').value = nextCode.toString();
        }

        function toggleCodeEdit() {
            const codeInput = document.getElementById('accountCode');
            const button = event.target;
            
            if (codeInput.readOnly) {
                codeInput.readOnly = false;
                codeInput.focus();
                codeInput.select();
                button.textContent = 'üîí';
                button.title = 'Kunci kode otomatis';
            } else {
                codeInput.readOnly = true;
                button.textContent = '‚úèÔ∏è';
                button.title = 'Edit kode manual';
            }
        }

        // Navigation functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburger = document.getElementById('hamburger');
            
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
                hamburger.textContent = '‚úï';
            } else {
                mobileMenu.classList.add('hidden');
                hamburger.textContent = '‚ò∞';
            }
        }

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-white/20');
            });
            
            document.getElementById(sectionName).classList.remove('hidden');
            event.target.classList.add('bg-white/20');
            currentSection = sectionName;
            
            // Hide mobile menu after selection
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburger = document.getElementById('hamburger');
            if (window.innerWidth < 768) {
                mobileMenu.classList.add('hidden');
                hamburger.textContent = '‚ò∞';
            }
            
            if (sectionName === 'dashboard') {
                updateDashboard();
            }
        }

        // Transaction functions
        function showTransactionForm() {
            document.getElementById('transactionForm').classList.remove('hidden');
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
        }

        function hideTransactionForm() {
            document.getElementById('transactionForm').classList.add('hidden');
            document.getElementById('transactionForm').querySelector('form').reset();
            resetJournalEntries();
        }

        function addJournalEntry() {
            const entriesContainer = document.getElementById('journalEntries');
            const newEntry = document.createElement('div');
            newEntry.className = 'journal-entry grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-3 md:p-4 bg-dark-light/50 rounded-lg';
            newEntry.innerHTML = `
                <div class="sm:col-span-2 lg:col-span-1">
                    <label class="block text-sm font-medium mb-2">Akun</label>
                    <select class="account-select w-full p-2 md:p-3 bg-dark border border-gray-600 rounded-lg text-white text-sm md:text-base" required>
                        <option value="">Pilih Akun</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Debit</label>
                    <input type="number" class="debit-amount w-full p-2 md:p-3 bg-dark border border-gray-600 rounded-lg text-white text-sm md:text-base" placeholder="0" min="0" step="0.01">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Kredit</label>
                    <input type="number" class="credit-amount w-full p-2 md:p-3 bg-dark border border-gray-600 rounded-lg text-white text-sm md:text-base" placeholder="0" min="0" step="0.01">
                </div>
                <div class="flex items-end sm:col-span-2 lg:col-span-1">
                    <button type="button" onclick="removeJournalEntry(this)" class="w-full p-2 md:p-3 bg-red-600 hover:bg-red-700 rounded-lg transition-all text-sm md:text-base">Hapus</button>
                </div>
            `;
            entriesContainer.appendChild(newEntry);
            updateAccountSelects();
            attachAmountListeners();
        }

        function removeJournalEntry(button) {
            const entries = document.querySelectorAll('.journal-entry');
            if (entries.length > 1) {
                button.closest('.journal-entry').remove();
                updateTotals();
            }
        }

        function resetJournalEntries() {
            const entriesContainer = document.getElementById('journalEntries');
            entriesContainer.innerHTML = `
                <div class="journal-entry grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-3 md:p-4 bg-dark-light/50 rounded-lg">
                    <div class="sm:col-span-2 lg:col-span-1">
                        <label class="block text-sm font-medium mb-2">Akun</label>
                        <select class="account-select w-full p-2 md:p-3 bg-dark border border-gray-600 rounded-lg text-white text-sm md:text-base" required>
                            <option value="">Pilih Akun</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Debit</label>
                        <input type="number" class="debit-amount w-full p-2 md:p-3 bg-dark border border-gray-600 rounded-lg text-white text-sm md:text-base" placeholder="0" min="0" step="0.01">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Kredit</label>
                        <input type="number" class="credit-amount w-full p-2 md:p-3 bg-dark border border-gray-600 rounded-lg text-white text-sm md:text-base" placeholder="0" min="0" step="0.01">
                    </div>
                    <div class="flex items-end sm:col-span-2 lg:col-span-1">
                        <button type="button" onclick="removeJournalEntry(this)" class="w-full p-2 md:p-3 bg-red-600 hover:bg-red-700 rounded-lg transition-all text-sm md:text-base">Hapus</button>
                    </div>
                </div>
            `;
            updateAccountSelects();
            attachAmountListeners();
        }

        function attachAmountListeners() {
            document.querySelectorAll('.debit-amount, .credit-amount').forEach(input => {
                input.addEventListener('input', updateTotals);
            });
        }

        function updateTotals() {
            let totalDebit = 0;
            let totalCredit = 0;
            
            document.querySelectorAll('.debit-amount').forEach(input => {
                totalDebit += parseFloat(input.value) || 0;
            });
            
            document.querySelectorAll('.credit-amount').forEach(input => {
                totalCredit += parseFloat(input.value) || 0;
            });
            
            document.getElementById('totalDebit').textContent = formatCurrency(totalDebit);
            document.getElementById('totalCredit').textContent = formatCurrency(totalCredit);
            
            const balanceStatus = document.getElementById('balanceStatus');
            if (totalDebit === totalCredit && totalDebit > 0) {
                balanceStatus.textContent = 'Status: Seimbang ‚úì';
                balanceStatus.className = 'text-sm text-green-400';
            } else {
                balanceStatus.textContent = 'Status: Belum Seimbang';
                balanceStatus.className = 'text-sm text-red-400';
            }
        }

        function addTransaction(event) {
            event.preventDefault();
            
            const date = document.getElementById('transactionDate').value;
            const ref = document.getElementById('transactionRef').value;
            const desc = document.getElementById('transactionDesc').value;
            
            const entries = [];
            document.querySelectorAll('.journal-entry').forEach(entry => {
                const account = entry.querySelector('.account-select').value;
                const debit = parseFloat(entry.querySelector('.debit-amount').value) || 0;
                const credit = parseFloat(entry.querySelector('.credit-amount').value) || 0;
                
                if (account && (debit > 0 || credit > 0)) {
                    entries.push({account, debit, credit});
                }
            });
            
            if (entries.length === 0) {
                alert('Minimal harus ada satu entry transaksi');
                return;
            }
            
            const totalDebit = entries.reduce((sum, entry) => sum + entry.debit, 0);
            const totalCredit = entries.reduce((sum, entry) => sum + entry.credit, 0);
            
            if (totalDebit !== totalCredit) {
                alert('Total debit dan kredit harus sama');
                return;
            }
            
            const transaction = {
                id: Date.now(),
                date,
                ref,
                desc,
                entries
            };
            
            transactions.push(transaction);
            updateAccountBalances(entries);
            updateTransactionList();
            updateDashboard();
            updateDataStatistics();
            saveDataToLocalStorage();
            hideTransactionForm();
            
            alert('Transaksi berhasil disimpan!');
        }

        function updateAccountBalances(entries) {
            entries.forEach(entry => {
                const account = accounts.find(acc => acc.code === entry.account);
                if (account) {
                    if (['Aset', 'Beban'].includes(account.type)) {
                        account.balance += entry.debit - entry.credit;
                    } else {
                        account.balance += entry.credit - entry.debit;
                    }
                }
            });
            updateAccountList();
        }

        function updateTransactionList() {
            const tbody = document.getElementById('transactionList');
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td class="py-3 px-4 text-gray-300" colspan="7">Belum ada transaksi</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            transactions.forEach(transaction => {
                transaction.entries.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700';
                    row.innerHTML = `
                        <td class="py-3 px-4">${index === 0 ? transaction.date : ''}</td>
                        <td class="py-3 px-4">${index === 0 ? transaction.ref : ''}</td>
                        <td class="py-3 px-4">${index === 0 ? transaction.desc : ''}</td>
                        <td class="py-3 px-4">${getAccountName(entry.account)}</td>
                        <td class="py-3 px-4 text-right">${entry.debit > 0 ? formatCurrency(entry.debit) : ''}</td>
                        <td class="py-3 px-4 text-right">${entry.credit > 0 ? formatCurrency(entry.credit) : ''}</td>
                        <td class="py-3 px-4 text-center">
                            ${index === 0 ? `<button onclick="deleteTransaction(${transaction.id})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
            
            // Update recent transactions on dashboard
            updateRecentTransactions();
        }

        function updateRecentTransactions() {
            const tbody = document.getElementById('recentTransactions');
            const recentTransactions = transactions.slice(-5).reverse();
            
            if (recentTransactions.length === 0) {
                tbody.innerHTML = '<tr class="border-b border-gray-700"><td class="py-3 px-4 text-gray-300" colspan="5">Belum ada transaksi</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            recentTransactions.forEach(transaction => {
                transaction.entries.forEach(entry => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700';
                    row.innerHTML = `
                        <td class="py-3 px-4">${transaction.date}</td>
                        <td class="py-3 px-4">${transaction.desc}</td>
                        <td class="py-3 px-4">${getAccountName(entry.account)}</td>
                        <td class="py-3 px-4 text-right">${entry.debit > 0 ? formatCurrency(entry.debit) : ''}</td>
                        <td class="py-3 px-4 text-right">${entry.credit > 0 ? formatCurrency(entry.credit) : ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        function deleteTransaction(id) {
            if (confirm('Yakin ingin menghapus transaksi ini?')) {
                const transactionIndex = transactions.findIndex(t => t.id === id);
                if (transactionIndex !== -1) {
                    const transaction = transactions[transactionIndex];
                    // Reverse the account balance changes
                    transaction.entries.forEach(entry => {
                        const account = accounts.find(acc => acc.code === entry.account);
                        if (account) {
                            if (['Aset', 'Beban'].includes(account.type)) {
                                account.balance -= entry.debit - entry.credit;
                            } else {
                                account.balance -= entry.credit - entry.debit;
                            }
                        }
                    });
                    
                    transactions.splice(transactionIndex, 1);
                    updateTransactionList();
                    updateAccountList();
                    updateDashboard();
                    updateDataStatistics();
                    saveDataToLocalStorage();
                }
            }
        }

        // Asset functions
        function showAssetForm() {
            document.getElementById('assetForm').classList.remove('hidden');
            document.getElementById('assetDate').value = new Date().toISOString().split('T')[0];
        }

        function hideAssetForm() {
            document.getElementById('assetForm').classList.add('hidden');
            document.getElementById('assetForm').querySelector('form').reset();
        }

        function toggleDepreciationFields() {
            const isDepreciable = document.getElementById('assetDepreciable').checked;
            const depreciationFields = document.getElementById('depreciationFields');
            const lifeField = document.getElementById('assetLife');
            
            if (isDepreciable) {
                depreciationFields.style.display = 'grid';
                lifeField.required = true;
                document.getElementById('assetDepreciationMethod').required = true;
            } else {
                depreciationFields.style.display = 'none';
                lifeField.required = false;
                document.getElementById('assetDepreciationMethod').required = false;
                
                // Clear depreciation fields
                document.getElementById('assetResidual').value = '0';
                document.getElementById('assetDepreciationMethod').value = 'straight-line';
            }
        }

        function addAsset(event) {
            event.preventDefault();
            
            const isDepreciable = document.getElementById('assetDepreciable').checked;
            
            const asset = {
                id: Date.now(),
                name: document.getElementById('assetName').value,
                category: document.getElementById('assetCategory').value,
                cost: parseFloat(document.getElementById('assetCost').value),
                date: document.getElementById('assetDate').value,
                life: isDepreciable ? parseInt(document.getElementById('assetLife').value) : null,
                residual: isDepreciable ? (parseFloat(document.getElementById('assetResidual').value) || 0) : 0,
                method: isDepreciable ? document.getElementById('assetDepreciationMethod').value : null,
                accumulatedDepreciation: 0,
                isDepreciable: isDepreciable
            };
            
            // Validation for depreciable assets
            if (isDepreciable) {
                if (!asset.life || asset.life <= 0) {
                    alert('Umur ekonomis harus lebih dari 0 tahun untuk aset yang dapat disusutkan');
                    return;
                }
                
                if (asset.residual >= asset.cost) {
                    alert('Nilai residu tidak boleh lebih besar atau sama dengan harga perolehan');
                    return;
                }
            }
            
            assets.push(asset);
            updateAssetList();
            updateDataStatistics();
            saveDataToLocalStorage();
            hideAssetForm();
            
            const depreciationStatus = isDepreciable ? 'dengan penyusutan' : 'tanpa penyusutan';
            alert(`‚úÖ Aset berhasil ditambahkan ${depreciationStatus}!`);
        }

        function updateAssetList() {
            const tbody = document.getElementById('assetList');
            if (assets.length === 0) {
                tbody.innerHTML = '<tr><td class="py-3 px-4 text-gray-300" colspan="7">Belum ada aset</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            assets.forEach(asset => {
                const bookValue = asset.cost - asset.accumulatedDepreciation;
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-dark-light/30';
                
                const depreciationInfo = asset.isDepreciable 
                    ? getDepreciationMethodName(asset.method)
                    : '<span class="text-gray-400 text-sm">Tidak Disusutkan</span>';
                
                row.innerHTML = `
                    <td class="py-3 px-4">
                        <div class="flex items-center">
                            <span>${asset.name}</span>
                            ${!asset.isDepreciable ? '<span class="ml-2 px-2 py-1 bg-gray-900/30 text-gray-400 text-xs rounded">Non-Depreciable</span>' : ''}
                        </div>
                    </td>
                    <td class="py-3 px-4">${asset.category}</td>
                    <td class="py-3 px-4 text-right">${formatCurrency(asset.cost)}</td>
                    <td class="py-3 px-4 text-right">${asset.isDepreciable ? formatCurrency(asset.accumulatedDepreciation) : '-'}</td>
                    <td class="py-3 px-4 text-right font-semibold">${formatCurrency(bookValue)}</td>
                    <td class="py-3 px-4">${depreciationInfo}</td>
                    <td class="py-3 px-4 text-center">
                        <div class="flex justify-center space-x-1">
                            ${asset.isDepreciable ? `
                                <button onclick="calculateDepreciation(${asset.id})" 
                                        class="text-blue-400 hover:text-blue-300 p-1 rounded hover:bg-blue-900/20" 
                                        title="Hitung penyusutan">
                                    üìä
                                </button>
                            ` : ''}
                            <button onclick="deleteAsset(${asset.id})" 
                                    class="text-red-400 hover:text-red-300 p-1 rounded hover:bg-red-900/20" 
                                    title="Hapus aset">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function calculateDepreciation(assetId) {
            const asset = assets.find(a => a.id === assetId);
            if (!asset || !asset.isDepreciable) {
                alert('Aset ini tidak dapat disusutkan');
                return;
            }
            
            const currentDate = new Date();
            const assetDate = new Date(asset.date);
            const monthsElapsed = (currentDate.getFullYear() - assetDate.getFullYear()) * 12 + 
                                (currentDate.getMonth() - assetDate.getMonth());
            
            if (monthsElapsed < 0) {
                alert('Tanggal perolehan aset tidak boleh di masa depan');
                return;
            }
            
            let annualDepreciation = 0;
            const depreciableAmount = asset.cost - asset.residual;
            const yearsElapsed = monthsElapsed / 12;
            
            switch (asset.method) {
                case 'straight-line':
                    annualDepreciation = depreciableAmount / asset.life;
                    break;
                case 'declining-balance':
                    const rate = parseFloat(document.getElementById('decliningRate').value) / 100;
                    const remainingValue = asset.cost - asset.accumulatedDepreciation;
                    annualDepreciation = Math.max(0, remainingValue * rate);
                    // Ensure we don't depreciate below residual value
                    annualDepreciation = Math.min(annualDepreciation, remainingValue - asset.residual);
                    break;
                case 'sum-of-years':
                    const sumOfYears = (asset.life * (asset.life + 1)) / 2;
                    const currentYear = Math.min(Math.floor(yearsElapsed) + 1, asset.life);
                    const remainingYears = Math.max(0, asset.life - currentYear + 1);
                    annualDepreciation = (depreciableAmount * remainingYears) / sumOfYears;
                    break;
            }
            
            // Calculate total depreciation up to current date
            const monthlyDepreciation = annualDepreciation / 12;
            let totalDepreciation = 0;
            
            if (asset.method === 'straight-line' || asset.method === 'sum-of-years') {
                totalDepreciation = Math.min(monthlyDepreciation * monthsElapsed, depreciableAmount);
            } else if (asset.method === 'declining-balance') {
                // For declining balance, calculate year by year
                const rate = parseFloat(document.getElementById('decliningRate').value) / 100;
                let bookValue = asset.cost;
                const fullYears = Math.floor(yearsElapsed);
                
                for (let year = 0; year < fullYears; year++) {
                    const yearlyDepreciation = Math.min(bookValue * rate, bookValue - asset.residual);
                    totalDepreciation += yearlyDepreciation;
                    bookValue -= yearlyDepreciation;
                }
                
                // Add partial year depreciation
                const partialYear = yearsElapsed - fullYears;
                if (partialYear > 0) {
                    const partialYearDepreciation = Math.min(bookValue * rate * partialYear, bookValue - asset.residual);
                    totalDepreciation += partialYearDepreciation;
                }
                
                totalDepreciation = Math.min(totalDepreciation, depreciableAmount);
            }
            
            // Update asset
            const previousDepreciation = asset.accumulatedDepreciation;
            asset.accumulatedDepreciation = totalDepreciation;
            updateAssetList();
            saveDataToLocalStorage();
            
            // Show detailed calculation
            const bookValue = asset.cost - totalDepreciation;
            const depreciationAdded = totalDepreciation - previousDepreciation;
            
            alert(`‚úÖ Penyusutan berhasil dihitung!\n\n` +
                  `üìä Detail Perhitungan:\n` +
                  `‚Ä¢ Metode: ${getDepreciationMethodName(asset.method)}\n` +
                  `‚Ä¢ Periode: ${Math.floor(monthsElapsed)} bulan (${yearsElapsed.toFixed(1)} tahun)\n` +
                  `‚Ä¢ Penyusutan per tahun: ${formatCurrency(annualDepreciation)}\n` +
                  `‚Ä¢ Penyusutan ditambahkan: ${formatCurrency(depreciationAdded)}\n` +
                  `‚Ä¢ Total akumulasi penyusutan: ${formatCurrency(totalDepreciation)}\n` +
                  `‚Ä¢ Nilai buku saat ini: ${formatCurrency(bookValue)}`);
        }

        function deleteAsset(id) {
            if (confirm('Yakin ingin menghapus aset ini?')) {
                const index = assets.findIndex(a => a.id === id);
                if (index !== -1) {
                    assets.splice(index, 1);
                    updateAssetList();
                    updateDataStatistics();
                    saveDataToLocalStorage();
                }
            }
        }

        function getDepreciationMethodName(method) {
            const methods = {
                'straight-line': 'Garis Lurus',
                'declining-balance': 'Saldo Menurun',
                'sum-of-years': 'Jumlah Angka Tahun'
            };
            return methods[method] || method;
        }

        // Account functions
        function showAccountForm() {
            document.getElementById('accountForm').classList.remove('hidden');
        }

        function hideAccountForm() {
            document.getElementById('accountForm').classList.add('hidden');
            document.getElementById('accountForm').querySelector('form').reset();
            
            // Reset form state
            document.getElementById('editAccountId').value = '';
            document.getElementById('accountFormTitle').textContent = 'Tambah Akun Baru';
            document.getElementById('accountSubmitBtn').textContent = 'Simpan';
            document.getElementById('accountCode').readOnly = true;
            
            // Reset code edit button
            const editButton = document.querySelector('button[onclick="toggleCodeEdit()"]');
            if (editButton) {
                editButton.textContent = '‚úèÔ∏è';
                editButton.title = 'Edit kode manual';
            }
        }

        function addAccount(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editAccountId').value;
            const code = document.getElementById('accountCode').value;
            const name = document.getElementById('accountName').value;
            const type = document.getElementById('accountType').value;
            const balance = parseFloat(document.getElementById('accountBalance').value) || 0;
            const description = document.getElementById('accountDescription').value;
            
            // Validation
            if (!code || !name || !type) {
                alert('Mohon lengkapi semua field yang wajib diisi');
                return;
            }
            
            // Check for duplicate code (except when editing)
            const existingAccount = accounts.find(acc => acc.code === code);
            if (existingAccount && (!editId || existingAccount.code !== editId)) {
                alert('Kode akun sudah ada! Gunakan kode yang berbeda.');
                return;
            }
            
            if (editId) {
                // Edit existing account
                const accountIndex = accounts.findIndex(acc => acc.code === editId);
                if (accountIndex >= 0) {
                    accounts[accountIndex] = {
                        ...accounts[accountIndex],
                        code,
                        name,
                        type,
                        balance,
                        description: description || accounts[accountIndex].description
                    };
                    alert('‚úÖ Akun berhasil diperbarui!');
                }
            } else {
                // Add new account
                const newAccount = {
                    code,
                    name,
                    type,
                    balance,
                    description: description || '',
                    isDefault: false
                };
                
                accounts.push(newAccount);
                alert('‚úÖ Akun berhasil ditambahkan!');
            }
            
            accounts.sort((a, b) => a.code.localeCompare(b.code));
            
            updateAccountList();
            updateAccountSelects();
            updateDataStatistics();
            saveDataToLocalStorage();
            hideAccountForm();
        }

        function editAccount(code) {
            const account = accounts.find(acc => acc.code === code);
            if (!account) return;
            
            // Fill form with account data
            document.getElementById('editAccountId').value = code;
            document.getElementById('accountCode').value = account.code;
            document.getElementById('accountName').value = account.name;
            document.getElementById('accountType').value = account.type;
            document.getElementById('accountBalance').value = account.balance;
            document.getElementById('accountDescription').value = account.description || '';
            
            // Update form title and button
            document.getElementById('accountFormTitle').textContent = 'Edit Akun';
            document.getElementById('accountSubmitBtn').textContent = 'Update';
            
            // Make code field editable for editing
            document.getElementById('accountCode').readOnly = false;
            
            showAccountForm();
        }

        function deleteAccount(code) {
            const account = accounts.find(acc => acc.code === code);
            if (!account) return;
            
            // Check if account is used in transactions
            const isUsed = transactions.some(transaction => 
                transaction.entries.some(entry => entry.account === code)
            );
            
            if (isUsed) {
                alert('‚ùå Akun tidak dapat dihapus karena sudah digunakan dalam transaksi.\n\nUntuk menghapus akun ini, hapus terlebih dahulu semua transaksi yang menggunakan akun ini.');
                return;
            }
            
            // Prevent deletion of default accounts with balance
            if (account.isDefault && account.balance !== 0) {
                alert('‚ùå Akun default dengan saldo tidak dapat dihapus.\n\nKosongkan saldo terlebih dahulu atau buat jurnal penyesuaian.');
                return;
            }
            
            const confirmMessage = account.isDefault 
                ? `‚ö†Ô∏è Anda akan menghapus akun default:\n\n${code} - ${account.name}\n\nAkun default yang dihapus dapat mempengaruhi laporan keuangan. Yakin ingin melanjutkan?`
                : `Yakin ingin menghapus akun:\n\n${code} - ${account.name}?`;
                
            if (confirm(confirmMessage)) {
                const index = accounts.findIndex(acc => acc.code === code);
                if (index >= 0) {
                    accounts.splice(index, 1);
                    updateAccountList();
                    updateAccountSelects();
                    updateDataStatistics();
                    saveDataToLocalStorage();
                    alert('‚úÖ Akun berhasil dihapus!');
                }
            }
        }

        function updateAccountList() {
            const tbody = document.getElementById('accountList');
            tbody.innerHTML = '';
            
            accounts.forEach(account => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-dark-light/30';
                
                const isUsedInTransactions = transactions.some(transaction => 
                    transaction.entries.some(entry => entry.account === account.code)
                );
                
                row.innerHTML = `
                    <td class="py-2 font-mono">${account.code}</td>
                    <td class="py-2">
                        <div class="flex items-center">
                            <span>${account.name}</span>
                            ${account.isDefault ? '<span class="ml-2 px-2 py-1 bg-blue-900/30 text-blue-400 text-xs rounded">Default</span>' : ''}
                            ${isUsedInTransactions ? '<span class="ml-2 px-2 py-1 bg-green-900/30 text-green-400 text-xs rounded">Aktif</span>' : ''}
                        </div>
                        ${account.description ? `<p class="text-xs text-gray-400 mt-1">${account.description}</p>` : ''}
                    </td>
                    <td class="py-2">
                        <span class="px-2 py-1 rounded text-xs ${
                            account.type === 'Aset' ? 'bg-green-900/30 text-green-400' :
                            account.type === 'Liabilitas' ? 'bg-red-900/30 text-red-400' :
                            account.type === 'Modal' ? 'bg-blue-900/30 text-blue-400' :
                            account.type === 'Pendapatan' ? 'bg-purple-900/30 text-purple-400' :
                            'bg-orange-900/30 text-orange-400'
                        }">
                            ${account.type}
                        </span>
                    </td>
                    <td class="py-2 text-right font-mono">${formatCurrency(account.balance)}</td>
                    <td class="py-2 text-center">
                        <div class="flex justify-center space-x-1">
                            <button onclick="editAccount('${account.code}')" 
                                    class="text-blue-400 hover:text-blue-300 p-1 rounded hover:bg-blue-900/20" 
                                    title="Edit akun">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deleteAccount('${account.code}')" 
                                    class="text-red-400 hover:text-red-300 p-1 rounded hover:bg-red-900/20" 
                                    title="Hapus akun"
                                    ${isUsedInTransactions ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAccountSelects() {
            document.querySelectorAll('.account-select').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Pilih Akun</option>';
                
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.code;
                    option.textContent = `${account.code} - ${account.name}`;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
            
            // Update ledger account select
            updateLedgerAccountSelect();
            
            // Update reconciliation bank select
            updateReconciliationBankSelect();
            
            // Update manual transaction account select
            updateManualTransactionAccountSelect();
            
            // Update tax account selects
            updateTaxAccountSelects();
        }

        function updateReconciliationBankSelect() {
            const bankSelect = document.getElementById('reconciliationBankSelect');
            if (bankSelect) {
                const currentValue = bankSelect.value;
                bankSelect.innerHTML = '<option value="">Pilih Akun Bank</option>';
                
                // Filter only bank accounts (typically codes starting with 12xx)
                const bankAccounts = accounts.filter(account => 
                    account.name.toLowerCase().includes('bank') || 
                    account.code.startsWith('12')
                );
                
                bankAccounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.code;
                    option.textContent = `${account.code} - ${account.name}`;
                    bankSelect.appendChild(option);
                });
                
                bankSelect.value = currentValue;
            }
        }

        function updateManualTransactionAccountSelect() {
            const accountSelect = document.getElementById('manualTransactionAccount');
            if (accountSelect) {
                const currentValue = accountSelect.value;
                accountSelect.innerHTML = '<option value="">Pilih Akun</option>';
                
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.code;
                    option.textContent = `${account.code} - ${account.name}`;
                    accountSelect.appendChild(option);
                });
                
                accountSelect.value = currentValue;
            }
        }

        function updateLedgerAccountSelect() {
            const ledgerSelect = document.getElementById('ledgerAccountSelect');
            if (ledgerSelect) {
                const currentValue = ledgerSelect.value;
                ledgerSelect.innerHTML = '<option value="">Semua Akun</option>';
                
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.code;
                    option.textContent = `${account.code} - ${account.name}`;
                    ledgerSelect.appendChild(option);
                });
                
                ledgerSelect.value = currentValue;
            }
        }

        function getAccountName(code) {
            const account = accounts.find(acc => acc.code === code);
            return account ? account.name : code;
        }

        // Report functions
        let currentReportType = '';
        let currentReportData = {};

        function validateReportPeriod() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const validation = document.getElementById('periodValidation');
            
            if (startDate && endDate) {
                if (new Date(startDate) > new Date(endDate)) {
                    validation.textContent = '‚ö†Ô∏è Tanggal awal tidak boleh lebih besar dari tanggal akhir';
                    validation.className = 'text-sm text-red-400';
                    return false;
                } else {
                    const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
                    validation.textContent = `‚úÖ Periode valid: ${daysDiff + 1} hari (${formatDate(startDate)} - ${formatDate(endDate)})`;
                    validation.className = 'text-sm text-green-400';
                    return true;
                }
            } else if (startDate || endDate) {
                validation.textContent = '‚ö†Ô∏è Mohon lengkapi tanggal awal dan akhir';
                validation.className = 'text-sm text-yellow-400';
                return false;
            } else {
                validation.textContent = 'Pilih periode untuk menghasilkan laporan yang akurat';
                validation.className = 'text-sm text-gray-300';
                return false;
            }
        }

        function setQuickPeriod() {
            const quickPeriod = document.getElementById('quickPeriod').value;
            const today = new Date();
            let startDate, endDate;
            
            switch (quickPeriod) {
                case 'today':
                    startDate = endDate = today;
                    break;
                case 'this-week':
                    startDate = new Date(today.setDate(today.getDate() - today.getDay()));
                    endDate = new Date(today.setDate(today.getDate() - today.getDay() + 6));
                    break;
                case 'this-month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'last-month':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'this-quarter':
                    const quarterStart = Math.floor(today.getMonth() / 3) * 3;
                    startDate = new Date(today.getFullYear(), quarterStart, 1);
                    endDate = new Date(today.getFullYear(), quarterStart + 3, 0);
                    break;
                case 'last-quarter':
                    const lastQuarterStart = Math.floor(today.getMonth() / 3) * 3 - 3;
                    startDate = new Date(today.getFullYear(), lastQuarterStart, 1);
                    endDate = new Date(today.getFullYear(), lastQuarterStart + 3, 0);
                    break;
                case 'this-year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
                case 'last-year':
                    startDate = new Date(today.getFullYear() - 1, 0, 1);
                    endDate = new Date(today.getFullYear() - 1, 11, 31);
                    break;
                case 'ytd':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date();
                    break;
                case 'all-time':
                    // Find earliest transaction date
                    if (transactions.length > 0) {
                        const dates = transactions.map(t => new Date(t.date));
                        startDate = new Date(Math.min(...dates));
                        endDate = new Date();
                    } else {
                        startDate = new Date(today.getFullYear(), 0, 1);
                        endDate = new Date();
                    }
                    break;
                default:
                    return;
            }
            
            document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
            validateReportPeriod();
        }

        function refreshReports() {
            if (currentReportType) {
                generateReport(currentReportType);
            }
        }

        function generateReport(reportType) {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            // Validate period if dates are provided
            if ((startDate || endDate) && !validateReportPeriod()) {
                return;
            }
            
            // Check if there are transactions in the selected period
            if (startDate && endDate) {
                const periodTransactions = transactions.filter(transaction => 
                    transaction.date >= startDate && transaction.date <= endDate
                );
                
                if (periodTransactions.length === 0) {
                    const proceed = confirm(`‚ö†Ô∏è Tidak ada transaksi dalam periode ${formatDate(startDate)} - ${formatDate(endDate)}.\n\nApakah Anda ingin tetap membuat laporan?`);
                    if (!proceed) return;
                }
            }
            
            currentReportType = reportType;
            const reportContent = document.getElementById('reportContent');
            const reportTitle = document.getElementById('reportTitle');
            const reportPeriod = document.getElementById('reportPeriod');
            const reportTimestamp = document.getElementById('reportTimestamp');
            const reportData = document.getElementById('reportData');
            
            reportContent.classList.remove('hidden');
            
            // Set period info with transaction count
            if (startDate && endDate) {
                const periodTransactions = transactions.filter(transaction => 
                    transaction.date >= startDate && transaction.date <= endDate
                );
                reportPeriod.textContent = `Periode: ${formatDate(startDate)} - ${formatDate(endDate)} (${periodTransactions.length} transaksi)`;
            } else {
                reportPeriod.textContent = `Periode: Semua Transaksi (${transactions.length} transaksi)`;
            }
            
            reportTimestamp.textContent = `Dibuat: ${new Date().toLocaleString('id-ID')}`;
            
            switch (reportType) {
                case 'balance-sheet':
                    reportTitle.textContent = '‚öñÔ∏è NERACA (BALANCE SHEET)';
                    generateBalanceSheet(reportData, startDate, endDate);
                    break;
                case 'income-statement':
                    reportTitle.textContent = 'üìà LAPORAN LABA RUGI (INCOME STATEMENT)';
                    generateIncomeStatement(reportData, startDate, endDate);
                    break;
                case 'cash-flow':
                    reportTitle.textContent = 'üí∞ LAPORAN ARUS KAS (CASH FLOW STATEMENT)';
                    generateCashFlowStatement(reportData, startDate, endDate);
                    break;
                case 'trial-balance':
                    reportTitle.textContent = 'üìä NERACA SALDO (TRIAL BALANCE)';
                    generateTrialBalance(reportData, startDate, endDate);
                    break;
            }
        }

        function generateBalanceSheet(container, startDate, endDate) {
            // Calculate period-specific balances
            const periodBalances = calculatePeriodBalances(startDate, endDate);
            
            // Calculate comprehensive income statement data
            const incomeData = calculateComprehensiveIncome(startDate, endDate);
            const netIncome = incomeData.netIncome;
            const totalRevenue = incomeData.totalRevenue;
            const totalExpenses = incomeData.totalExpenses;
            const grossProfit = incomeData.grossProfit;
            const operatingIncome = incomeData.operatingIncome;
            
            // Classify assets with proper accounting structure
            const currentAssets = accounts.filter(acc => 
                acc.type === 'Aset' && 
                (acc.name.toLowerCase().includes('kas') || 
                 acc.name.toLowerCase().includes('bank') || 
                 acc.name.toLowerCase().includes('piutang') || 
                 acc.name.toLowerCase().includes('persediaan') ||
                 acc.name.toLowerCase().includes('investasi jangka pendek') ||
                 acc.name.toLowerCase().includes('biaya dibayar dimuka')) &&
                periodBalances[acc.code] !== 0
            );
            
            const fixedAssets = accounts.filter(acc => 
                acc.type === 'Aset' && 
                !currentAssets.includes(acc) &&
                periodBalances[acc.code] !== 0
            );
            
            // Classify liabilities with proper accounting structure
            const currentLiabilities = accounts.filter(acc => 
                acc.type === 'Liabilitas' && 
                (acc.name.toLowerCase().includes('utang dagang') || 
                 acc.name.toLowerCase().includes('utang gaji') ||
                 acc.name.toLowerCase().includes('utang pajak') ||
                 acc.name.toLowerCase().includes('utang jangka pendek') ||
                 acc.name.toLowerCase().includes('biaya yang masih harus dibayar')) &&
                periodBalances[acc.code] !== 0
            );
            
            const longTermLiabilities = accounts.filter(acc => 
                acc.type === 'Liabilitas' && 
                !currentLiabilities.includes(acc) &&
                periodBalances[acc.code] !== 0
            );
            
            // Equity accounts with retained earnings integration
            const paidInCapital = accounts.filter(acc => 
                acc.type === 'Modal' && 
                (acc.name.toLowerCase().includes('modal saham') ||
                 acc.name.toLowerCase().includes('modal disetor') ||
                 acc.name.toLowerCase().includes('agio saham')) &&
                periodBalances[acc.code] !== 0
            );
            
            const retainedEarnings = accounts.filter(acc => 
                acc.type === 'Modal' && 
                (acc.name.toLowerCase().includes('laba ditahan') ||
                 acc.name.toLowerCase().includes('saldo laba')) &&
                periodBalances[acc.code] !== 0
            );
            
            const otherEquity = accounts.filter(acc => 
                acc.type === 'Modal' && 
                !paidInCapital.includes(acc) && 
                !retainedEarnings.includes(acc) &&
                periodBalances[acc.code] !== 0
            );
            
            // Calculate totals with proper accounting principles
            const totalCurrentAssets = currentAssets.reduce((sum, acc) => sum + Math.abs(periodBalances[acc.code]), 0);
            const totalFixedAssets = fixedAssets.reduce((sum, acc) => sum + Math.abs(periodBalances[acc.code]), 0);
            const totalAssets = totalCurrentAssets + totalFixedAssets;
            
            const totalCurrentLiabilities = currentLiabilities.reduce((sum, acc) => sum + Math.abs(periodBalances[acc.code]), 0);
            const totalLongTermLiabilities = longTermLiabilities.reduce((sum, acc) => sum + Math.abs(periodBalances[acc.code]), 0);
            const totalLiabilities = totalCurrentLiabilities + totalLongTermLiabilities;
            
            const totalPaidInCapital = paidInCapital.reduce((sum, acc) => sum + Math.abs(periodBalances[acc.code]), 0);
            const totalRetainedEarnings = retainedEarnings.reduce((sum, acc) => sum + Math.abs(periodBalances[acc.code]), 0);
            const totalOtherEquity = otherEquity.reduce((sum, acc) => sum + Math.abs(periodBalances[acc.code]), 0);
            
            // Add current period net income to retained earnings
            const adjustedRetainedEarnings = totalRetainedEarnings + netIncome;
            const totalEquity = totalPaidInCapital + adjustedRetainedEarnings + totalOtherEquity;
            
            // Professional balance validation - Assets = Liabilities + Equity
            const balanceDifference = totalAssets - (totalLiabilities + totalEquity);
            const isBalanced = Math.abs(balanceDifference) < 0.01;
            
            // Calculate financial ratios for analysis
            const currentRatio = totalCurrentLiabilities > 0 ? totalCurrentAssets / totalCurrentLiabilities : 0;
            const debtToEquityRatio = totalEquity > 0 ? totalLiabilities / totalEquity : 0;
            const assetTurnover = totalAssets > 0 ? totalRevenue / totalAssets : 0;
            const roe = totalEquity > 0 ? (netIncome / totalEquity) * 100 : 0;
            
            // Show comprehensive balance alert
            showBalanceAlert(isBalanced, balanceDifference, totalAssets, totalLiabilities + totalEquity, 'balance-sheet');
            
            // Store comprehensive report data for export
            currentReportData = {
                type: 'balance-sheet',
                totalAssets,
                totalCurrentAssets,
                totalFixedAssets,
                totalLiabilities,
                totalCurrentLiabilities,
                totalLongTermLiabilities,
                totalEquity,
                totalPaidInCapital,
                totalRetainedEarnings: adjustedRetainedEarnings,
                netIncome,
                totalRevenue,
                totalExpenses,
                grossProfit,
                operatingIncome,
                isBalanced,
                balanceDifference,
                currentRatio,
                debtToEquityRatio,
                assetTurnover,
                roe
            };
            
            container.innerHTML = `
                <!-- Period Information Alert -->
                <div class="mb-4 p-4 rounded-lg border-l-4 border-blue-400 bg-blue-900/20">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üìÖ</span>
                        <div>
                            <h3 class="font-bold text-lg text-blue-400">PERIODE LAPORAN</h3>
                            <p class="text-sm text-gray-300">
                                ${startDate && endDate 
                                    ? `Data berdasarkan transaksi periode ${formatDate(startDate)} - ${formatDate(endDate)}`
                                    : 'Data berdasarkan semua transaksi yang tersedia'
                                }
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Balance Sheet Status Alert -->
                <div class="mb-6 p-4 rounded-lg border-l-4 ${isBalanced ? 'border-green-400 bg-green-900/20' : 'border-red-400 bg-red-900/20'}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${isBalanced ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            <div>
                                <h3 class="font-bold text-lg ${isBalanced ? 'text-green-400' : 'text-red-400'}">
                                    STATUS NERACA: ${isBalanced ? 'SEIMBANG' : 'TIDAK SEIMBANG'}
                                </h3>
                                <p class="text-sm text-gray-300">
                                    ${isBalanced 
                                        ? 'Aset = Kewajiban + Ekuitas - Neraca telah seimbang sesuai prinsip akuntansi' 
                                        : `Selisih: ${formatCurrency(Math.abs(balanceDifference))} - Periksa pencatatan transaksi`
                                    }
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400">Laba Bersih Periode:</p>
                            <p class="font-bold ${netIncome >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(netIncome)}</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- ASSETS SECTION -->
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-bold text-xl mb-4 text-green-400 border-b-2 border-green-400 pb-2">
                                üí∞ ASET (ASSETS)
                            </h4>
                            
                            <!-- Current Assets -->
                            <div class="mb-6">
                                <h5 class="font-semibold text-lg mb-3 text-green-300">Aset Lancar (Current Assets)</h5>
                                ${currentAssets.length > 0 ? currentAssets.map(acc => `
                                    <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                        <span class="text-gray-300">${acc.name}</span>
                                        <span class="font-mono">${formatCurrency(Math.abs(periodBalances[acc.code]))}</span>
                                    </div>
                                `).join('') : '<div class="text-gray-400 text-sm py-2 px-3">Tidak ada aset lancar</div>'}
                                <div class="flex justify-between py-2 px-3 font-semibold border-t border-green-300 mt-2">
                                    <span>Total Aset Lancar</span>
                                    <span class="font-mono">${formatCurrency(totalCurrentAssets)}</span>
                                </div>
                            </div>
                            
                            <!-- Fixed Assets -->
                            <div class="mb-6">
                                <h5 class="font-semibold text-lg mb-3 text-green-300">Aset Tetap (Fixed Assets)</h5>
                                ${fixedAssets.length > 0 ? fixedAssets.map(acc => `
                                    <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                        <span class="text-gray-300">${acc.name}</span>
                                        <span class="font-mono">${formatCurrency(Math.abs(periodBalances[acc.code]))}</span>
                                    </div>
                                `).join('') : '<div class="text-gray-400 text-sm py-2 px-3">Tidak ada aset tetap</div>'}
                                <div class="flex justify-between py-2 px-3 font-semibold border-t border-green-300 mt-2">
                                    <span>Total Aset Tetap</span>
                                    <span class="font-mono">${formatCurrency(totalFixedAssets)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-900/20 p-4 rounded-lg border-l-4 border-green-400">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-xl">TOTAL ASET</span>
                                <span class="font-bold text-xl font-mono text-green-400">${formatCurrency(totalAssets)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- LIABILITIES & EQUITY SECTION -->
                    <div class="space-y-6">
                        <!-- LIABILITIES -->
                        <div>
                            <h4 class="font-bold text-xl mb-4 text-red-400 border-b-2 border-red-400 pb-2">
                                üìä KEWAJIBAN (LIABILITIES)
                            </h4>
                            
                            <!-- Current Liabilities -->
                            <div class="mb-6">
                                <h5 class="font-semibold text-lg mb-3 text-red-300">Kewajiban Lancar (Current Liabilities)</h5>
                                ${currentLiabilities.length > 0 ? currentLiabilities.map(acc => `
                                    <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                        <span class="text-gray-300">${acc.name}</span>
                                        <span class="font-mono">${formatCurrency(Math.abs(periodBalances[acc.code]))}</span>
                                    </div>
                                `).join('') : '<div class="text-gray-400 text-sm py-2 px-3">Tidak ada kewajiban lancar</div>'}
                                <div class="flex justify-between py-2 px-3 font-semibold border-t border-red-300 mt-2">
                                    <span>Total Kewajiban Lancar</span>
                                    <span class="font-mono">${formatCurrency(totalCurrentLiabilities)}</span>
                                </div>
                            </div>
                            
                            <!-- Long-term Liabilities -->
                            ${longTermLiabilities.length > 0 ? `
                            <div class="mb-6">
                                <h5 class="font-semibold text-lg mb-3 text-red-300">Kewajiban Jangka Panjang (Long-term Liabilities)</h5>
                                ${longTermLiabilities.map(acc => `
                                    <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                        <span class="text-gray-300">${acc.name}</span>
                                        <span class="font-mono">${formatCurrency(Math.abs(periodBalances[acc.code]))}</span>
                                    </div>
                                `).join('')}
                                <div class="flex justify-between py-2 px-3 font-semibold border-t border-red-300 mt-2">
                                    <span>Total Kewajiban Jangka Panjang</span>
                                    <span class="font-mono">${formatCurrency(totalLongTermLiabilities)}</span>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="bg-red-900/20 p-4 rounded-lg border-l-4 border-red-400">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">TOTAL KEWAJIBAN</span>
                                <span class="font-bold text-lg font-mono text-red-400">${formatCurrency(totalLiabilities)}</span>
                            </div>
                        </div>
                        
                        <!-- EQUITY -->
                        <div>
                            <h4 class="font-bold text-xl mb-4 text-blue-400 border-b-2 border-blue-400 pb-2">
                                üèõÔ∏è EKUITAS (EQUITY)
                            </h4>
                            
                            <!-- Paid-in Capital -->
                            ${paidInCapital.length > 0 ? `
                            <div class="mb-4">
                                <h6 class="font-medium text-blue-300 mb-2">Modal Disetor (Paid-in Capital)</h6>
                                ${paidInCapital.map(acc => `
                                    <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                        <span class="text-gray-300">${acc.name}</span>
                                        <span class="font-mono">${formatCurrency(Math.abs(periodBalances[acc.code]))}</span>
                                    </div>
                                `).join('')}
                                <div class="flex justify-between py-1 px-3 text-sm border-t border-blue-400/30 mt-1">
                                    <span class="text-blue-300">Subtotal Modal Disetor</span>
                                    <span class="font-mono text-blue-300">${formatCurrency(totalPaidInCapital)}</span>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Retained Earnings -->
                            <div class="mb-4">
                                <h6 class="font-medium text-blue-300 mb-2">Laba Ditahan (Retained Earnings)</h6>
                                ${retainedEarnings.map(acc => `
                                    <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                        <span class="text-gray-300">${acc.name}</span>
                                        <span class="font-mono">${formatCurrency(Math.abs(periodBalances[acc.code]))}</span>
                                    </div>
                                `).join('')}
                                
                                <!-- Current Period Net Income Integration -->
                                ${netIncome !== 0 ? `
                                <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded bg-yellow-900/10 border-l-2 border-yellow-400">
                                    <span class="text-gray-300">
                                        ${netIncome >= 0 ? 'Laba Bersih Periode Ini' : 'Rugi Bersih Periode Ini'}
                                        <span class="text-xs text-yellow-400 ml-2">(dari Laporan L/R)</span>
                                    </span>
                                    <span class="font-mono ${netIncome >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(netIncome)}</span>
                                </div>
                                ` : ''}
                                
                                <div class="flex justify-between py-1 px-3 text-sm border-t border-blue-400/30 mt-1">
                                    <span class="text-blue-300">Subtotal Laba Ditahan</span>
                                    <span class="font-mono text-blue-300">${formatCurrency(adjustedRetainedEarnings)}</span>
                                </div>
                            </div>
                            
                            <!-- Other Equity -->
                            ${otherEquity.length > 0 ? `
                            <div class="mb-4">
                                <h6 class="font-medium text-blue-300 mb-2">Ekuitas Lainnya</h6>
                                ${otherEquity.map(acc => `
                                    <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                        <span class="text-gray-300">${acc.name}</span>
                                        <span class="font-mono">${formatCurrency(Math.abs(periodBalances[acc.code]))}</span>
                                    </div>
                                `).join('')}
                                <div class="flex justify-between py-1 px-3 text-sm border-t border-blue-400/30 mt-1">
                                    <span class="text-blue-300">Subtotal Ekuitas Lainnya</span>
                                    <span class="font-mono text-blue-300">${formatCurrency(totalOtherEquity)}</span>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="flex justify-between py-2 px-3 font-semibold border-t-2 border-blue-300 mt-2">
                                <span>TOTAL EKUITAS</span>
                                <span class="font-mono">${formatCurrency(totalEquity)}</span>
                            </div>
                        </div>
                        
                        <div class="bg-blue-900/20 p-4 rounded-lg border-l-4 border-blue-400">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">TOTAL KEWAJIBAN + EKUITAS</span>
                                <span class="font-bold text-lg font-mono text-blue-400">${formatCurrency(totalLiabilities + totalEquity)}</span>
                            </div>
                        </div>
                        
                        <!-- Professional Balance Equation -->
                        <div class="bg-gradient-to-r from-purple-900/30 to-indigo-900/30 p-4 rounded-lg border border-purple-400">
                            <div class="text-center">
                                <p class="text-sm text-gray-300 mb-2">Persamaan Dasar Akuntansi:</p>
                                <p class="font-mono text-lg mb-2">
                                    <span class="text-green-400 font-bold">${formatCurrency(totalAssets)}</span>
                                    <span class="text-white mx-2 font-bold">=</span>
                                    <span class="text-red-400 font-bold">${formatCurrency(totalLiabilities)}</span>
                                    <span class="text-white mx-2 font-bold">+</span>
                                    <span class="text-blue-400 font-bold">${formatCurrency(totalEquity)}</span>
                                </p>
                                <p class="text-xs text-gray-400">ASET = KEWAJIBAN + EKUITAS</p>
                                <div class="mt-3 pt-3 border-t border-purple-400/30">
                                    <p class="text-xs text-purple-300">
                                        Status: <span class="font-semibold ${isBalanced ? 'text-green-400' : 'text-red-400'}">
                                            ${isBalanced ? '‚úì SEIMBANG' : '‚úó TIDAK SEIMBANG'}
                                        </span>
                                        ${!isBalanced ? ` (Selisih: ${formatCurrency(Math.abs(balanceDifference))})` : ''}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Financial Ratios & Analysis -->
                <div class="mt-8 bg-gray-900/20 p-6 rounded-lg border border-gray-600">
                    <h4 class="font-bold text-lg mb-4 text-gray-300">üìä Analisis Rasio Keuangan</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-900/20 p-3 rounded border-l-2 border-blue-400">
                            <p class="text-xs text-blue-300 mb-1">Current Ratio</p>
                            <p class="font-bold text-blue-400">${currentRatio.toFixed(2)}</p>
                            <p class="text-xs text-gray-400">${currentRatio >= 2 ? 'Baik' : currentRatio >= 1 ? 'Cukup' : 'Perlu Perhatian'}</p>
                        </div>
                        <div class="bg-red-900/20 p-3 rounded border-l-2 border-red-400">
                            <p class="text-xs text-red-300 mb-1">Debt to Equity</p>
                            <p class="font-bold text-red-400">${debtToEquityRatio.toFixed(2)}</p>
                            <p class="text-xs text-gray-400">${debtToEquityRatio <= 1 ? 'Baik' : debtToEquityRatio <= 2 ? 'Cukup' : 'Tinggi'}</p>
                        </div>
                        <div class="bg-green-900/20 p-3 rounded border-l-2 border-green-400">
                            <p class="text-xs text-green-300 mb-1">Asset Turnover</p>
                            <p class="font-bold text-green-400">${assetTurnover.toFixed(2)}x</p>
                            <p class="text-xs text-gray-400">${assetTurnover >= 1 ? 'Efisien' : 'Perlu Ditingkatkan'}</p>
                        </div>
                        <div class="bg-purple-900/20 p-3 rounded border-l-2 border-purple-400">
                            <p class="text-xs text-purple-300 mb-1">ROE (%)</p>
                            <p class="font-bold text-purple-400">${roe.toFixed(2)}%</p>
                            <p class="text-xs text-gray-400">${roe >= 15 ? 'Sangat Baik' : roe >= 10 ? 'Baik' : roe >= 5 ? 'Cukup' : 'Rendah'}</p>
                        </div>
                    </div>
                    <div class="mt-4 text-xs text-gray-400">
                        <p>üí° <strong>Catatan:</strong> Rasio keuangan memberikan gambaran kesehatan finansial perusahaan. 
                        Current Ratio mengukur likuiditas, Debt to Equity mengukur leverage, Asset Turnover mengukur efisiensi, 
                        dan ROE mengukur profitabilitas terhadap ekuitas.</p>
                    </div>
                </div>
            `;
        }

        function generateIncomeStatement(container, startDate, endDate) {
            // Use comprehensive income calculation
            const incomeData = calculateComprehensiveIncome(startDate, endDate);
            
            // Extract all components
            const {
                totalRevenue,
                totalOperatingRevenue,
                totalNonOperatingRevenue,
                totalCOGS,
                grossProfit,
                totalOperatingExpenses,
                operatingIncome,
                totalNonOperatingExpenses,
                incomeBeforeTax,
                taxExpense,
                netIncome,
                totalExpenses,
                grossMargin,
                operatingMargin,
                netMargin,
                operatingRevenue,
                nonOperatingRevenue,
                cogs,
                operatingExpenses,
                nonOperatingExpenses
            } = incomeData;
            
            // Calculate additional metrics for professional analysis
            const ebitda = operatingIncome; // Simplified EBITDA (would need depreciation/amortization details)
            const interestCoverage = operatingIncome > 0 && totalNonOperatingExpenses > 0 ? operatingIncome / totalNonOperatingExpenses : 0;
            const taxRate = incomeBeforeTax > 0 ? (taxExpense / incomeBeforeTax) * 100 : 0;
            
            // Store comprehensive report data for export and balance sheet integration
            currentReportData = {
                type: 'income-statement',
                totalRevenue,
                totalOperatingRevenue,
                totalNonOperatingRevenue,
                totalCOGS,
                grossProfit,
                totalOperatingExpenses,
                operatingIncome,
                totalNonOperatingExpenses,
                incomeBeforeTax,
                taxExpense,
                netIncome,
                totalExpenses,
                grossMargin,
                operatingMargin,
                netMargin,
                ebitda,
                interestCoverage,
                taxRate
            };
            
            container.innerHTML = `
                <!-- Period Information Alert -->
                <div class="mb-4 p-4 rounded-lg border-l-4 border-blue-400 bg-blue-900/20">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üìÖ</span>
                        <div>
                            <h3 class="font-bold text-lg text-blue-400">PERIODE LAPORAN</h3>
                            <p class="text-sm text-gray-300">
                                ${startDate && endDate 
                                    ? `Pendapatan dan beban periode ${formatDate(startDate)} - ${formatDate(endDate)}`
                                    : 'Pendapatan dan beban dari semua transaksi yang tersedia'
                                }
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Income Statement Integration Notice -->
                <div class="mb-6 p-4 rounded-lg border-l-4 border-yellow-400 bg-yellow-900/20">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üîó</span>
                        <div>
                            <h3 class="font-bold text-lg text-yellow-400">INTEGRASI DENGAN NERACA</h3>
                            <p class="text-sm text-gray-300">
                                Laba/Rugi bersih periode ini akan otomatis terintegrasi ke dalam Laba Ditahan di Neraca
                            </p>
                        </div>
                        <div class="ml-auto text-right">
                            <p class="text-xs text-gray-400">Dampak ke Neraca:</p>
                            <p class="font-bold ${netIncome >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${netIncome >= 0 ? '+' : ''}${formatCurrency(netIncome)}
                            </p>
                        </div>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- OPERATING REVENUE SECTION -->
                    <div class="bg-green-900/20 p-6 rounded-lg border-l-4 border-green-400">
                        <h4 class="font-bold text-xl mb-4 text-green-400">üìà PENDAPATAN OPERASIONAL</h4>
                        
                        ${operatingRevenue.length > 0 ? operatingRevenue.map(acc => `
                            <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                <span class="text-gray-300">${acc.name}</span>
                                <span class="font-mono">${formatCurrency(acc.amount)}</span>
                            </div>
                        `).join('') : '<div class="text-gray-400 text-sm py-2 px-3">Tidak ada pendapatan operasional</div>'}
                        
                        <div class="bg-green-800/30 p-3 rounded border-t-2 border-green-400 mt-4">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">TOTAL PENDAPATAN OPERASIONAL</span>
                                <span class="font-bold text-lg font-mono text-green-400">${formatCurrency(totalOperatingRevenue)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- COST OF GOODS SOLD -->
                    ${cogs.length > 0 ? `
                    <div class="bg-orange-900/20 p-6 rounded-lg border-l-4 border-orange-400">
                        <h4 class="font-bold text-xl mb-4 text-orange-400">üì¶ HARGA POKOK PENJUALAN (COGS)</h4>
                        ${cogs.map(acc => `
                            <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                <span class="text-gray-300">${acc.name}</span>
                                <span class="font-mono">${formatCurrency(acc.amount)}</span>
                            </div>
                        `).join('')}
                        <div class="bg-orange-800/30 p-3 rounded border-t-2 border-orange-400 mt-4">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">TOTAL HARGA POKOK PENJUALAN</span>
                                <span class="font-bold text-lg font-mono text-orange-400">${formatCurrency(totalCOGS)}</span>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- GROSS PROFIT -->
                    <div class="bg-cyan-900/20 p-4 rounded-lg border border-cyan-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-bold text-xl text-cyan-400">LABA KOTOR (GROSS PROFIT)</span>
                                <p class="text-sm text-gray-300">Margin Kotor: ${grossMargin.toFixed(2)}%</p>
                            </div>
                            <span class="font-bold text-xl font-mono text-cyan-400">${formatCurrency(grossProfit)}</span>
                        </div>
                    </div>
                    
                    <!-- OPERATING EXPENSES -->
                    ${operatingExpenses.length > 0 ? `
                    <div class="bg-red-900/20 p-6 rounded-lg border-l-4 border-red-400">
                        <h4 class="font-bold text-xl mb-4 text-red-400">üíº BEBAN OPERASIONAL</h4>
                        ${operatingExpenses.map(acc => `
                            <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                <span class="text-gray-300">${acc.name}</span>
                                <span class="font-mono">${formatCurrency(acc.amount)}</span>
                            </div>
                        `).join('')}
                        <div class="bg-red-800/30 p-3 rounded border-t-2 border-red-400 mt-4">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">TOTAL BEBAN OPERASIONAL</span>
                                <span class="font-bold text-lg font-mono text-red-400">${formatCurrency(totalOperatingExpenses)}</span>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- OPERATING INCOME -->
                    <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-bold text-xl text-blue-400">LABA OPERASIONAL (EBIT)</span>
                                <p class="text-sm text-gray-300">Margin Operasional: ${operatingMargin.toFixed(2)}%</p>
                            </div>
                            <span class="font-bold text-xl font-mono text-blue-400">${formatCurrency(operatingIncome)}</span>
                        </div>
                    </div>
                    
                    <!-- NON-OPERATING INCOME/EXPENSES -->
                    ${(nonOperatingRevenue.length > 0 || nonOperatingExpenses.length > 0) ? `
                    <div class="bg-purple-900/20 p-6 rounded-lg border-l-4 border-purple-400">
                        <h4 class="font-bold text-xl mb-4 text-purple-400">üîß PENDAPATAN & BEBAN NON-OPERASIONAL</h4>
                        
                        ${nonOperatingRevenue.length > 0 ? `
                        <div class="mb-4">
                            <h6 class="font-medium text-purple-300 mb-2">Pendapatan Non-Operasional</h6>
                            ${nonOperatingRevenue.map(acc => `
                                <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                    <span class="text-gray-300">${acc.name}</span>
                                    <span class="font-mono text-green-400">${formatCurrency(acc.amount)}</span>
                                </div>
                            `).join('')}
                            <div class="flex justify-between py-1 px-3 text-sm border-t border-purple-400/30 mt-1">
                                <span class="text-purple-300">Subtotal Pendapatan Non-Operasional</span>
                                <span class="font-mono text-green-400">${formatCurrency(totalNonOperatingRevenue)}</span>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${nonOperatingExpenses.length > 0 ? `
                        <div class="mb-4">
                            <h6 class="font-medium text-purple-300 mb-2">Beban Non-Operasional</h6>
                            ${nonOperatingExpenses.map(acc => `
                                <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                    <span class="text-gray-300">${acc.name}</span>
                                    <span class="font-mono text-red-400">${formatCurrency(acc.amount)}</span>
                                </div>
                            `).join('')}
                            <div class="flex justify-between py-1 px-3 text-sm border-t border-purple-400/30 mt-1">
                                <span class="text-purple-300">Subtotal Beban Non-Operasional</span>
                                <span class="font-mono text-red-400">${formatCurrency(totalNonOperatingExpenses)}</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- INCOME BEFORE TAX -->
                    <div class="bg-indigo-900/20 p-4 rounded-lg border border-indigo-400">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-xl text-indigo-400">LABA SEBELUM PAJAK (EBT)</span>
                            <span class="font-bold text-xl font-mono text-indigo-400">${formatCurrency(incomeBeforeTax)}</span>
                        </div>
                    </div>
                    
                    <!-- TAX EXPENSE -->
                    ${taxExpense > 0 ? `
                    <div class="bg-gray-900/20 p-4 rounded-lg border border-gray-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-bold text-lg text-gray-400">BEBAN PAJAK PENGHASILAN</span>
                                <p class="text-sm text-gray-300">Tarif Pajak Efektif: ${taxRate.toFixed(2)}%</p>
                            </div>
                            <span class="font-bold text-lg font-mono text-gray-400">${formatCurrency(taxExpense)}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- NET INCOME -->
                    <div class="bg-gradient-to-r ${netIncome >= 0 ? 'from-green-900/40 to-green-800/40 border-green-400' : 'from-red-900/40 to-red-800/40 border-red-400'} p-6 rounded-lg border-2">
                        <div class="text-center">
                            <h4 class="font-bold text-2xl mb-2 ${netIncome >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${netIncome >= 0 ? 'üéâ LABA BERSIH SETELAH PAJAK' : 'üìâ RUGI BERSIH SETELAH PAJAK'}
                            </h4>
                            <div class="font-bold text-3xl font-mono ${netIncome >= 0 ? 'text-green-400' : 'text-red-400'} mb-2">
                                ${formatCurrency(Math.abs(netIncome))}
                            </div>
                            <div class="text-sm text-gray-300">
                                <p>Margin Bersih: ${netMargin.toFixed(2)}%</p>
                                <p class="text-xs mt-1">
                                    ${netIncome >= 0 ? 
                                        'Perusahaan menghasilkan keuntungan pada periode ini' : 
                                        'Perusahaan mengalami kerugian pada periode ini'
                                    }
                                </p>
                            </div>
                            
                            <!-- Integration Notice -->
                            <div class="mt-4 pt-4 border-t border-gray-600">
                                <p class="text-xs text-yellow-300">
                                    üí° Laba/Rugi bersih ini akan otomatis ditambahkan ke Laba Ditahan di Neraca
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comprehensive Financial Analysis -->
                    <div class="bg-gray-900/20 p-6 rounded-lg border border-gray-600">
                        <h5 class="font-semibold text-lg mb-4 text-gray-300">üìä Analisis Profitabilitas</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="bg-cyan-900/20 p-3 rounded border-l-2 border-cyan-400">
                                <p class="text-xs text-cyan-300 mb-1">Margin Kotor</p>
                                <p class="font-bold text-cyan-400">${grossMargin.toFixed(2)}%</p>
                                <p class="text-xs text-gray-400">${grossMargin >= 30 ? 'Sangat Baik' : grossMargin >= 20 ? 'Baik' : grossMargin >= 10 ? 'Cukup' : 'Rendah'}</p>
                            </div>
                            <div class="bg-blue-900/20 p-3 rounded border-l-2 border-blue-400">
                                <p class="text-xs text-blue-300 mb-1">Margin Operasional</p>
                                <p class="font-bold text-blue-400">${operatingMargin.toFixed(2)}%</p>
                                <p class="text-xs text-gray-400">${operatingMargin >= 15 ? 'Sangat Baik' : operatingMargin >= 10 ? 'Baik' : operatingMargin >= 5 ? 'Cukup' : 'Rendah'}</p>
                            </div>
                            <div class="bg-green-900/20 p-3 rounded border-l-2 border-green-400">
                                <p class="text-xs text-green-300 mb-1">Margin Bersih</p>
                                <p class="font-bold text-green-400">${netMargin.toFixed(2)}%</p>
                                <p class="text-xs text-gray-400">${netMargin >= 10 ? 'Sangat Baik' : netMargin >= 5 ? 'Baik' : netMargin >= 2 ? 'Cukup' : 'Rendah'}</p>
                            </div>
                            ${taxExpense > 0 ? `
                            <div class="bg-gray-900/20 p-3 rounded border-l-2 border-gray-400">
                                <p class="text-xs text-gray-300 mb-1">Tarif Pajak Efektif</p>
                                <p class="font-bold text-gray-400">${taxRate.toFixed(2)}%</p>
                                <p class="text-xs text-gray-400">Beban pajak terhadap laba</p>
                            </div>
                            ` : ''}
                            ${interestCoverage > 0 ? `
                            <div class="bg-purple-900/20 p-3 rounded border-l-2 border-purple-400">
                                <p class="text-xs text-purple-300 mb-1">Interest Coverage</p>
                                <p class="font-bold text-purple-400">${interestCoverage.toFixed(2)}x</p>
                                <p class="text-xs text-gray-400">${interestCoverage >= 5 ? 'Aman' : interestCoverage >= 2.5 ? 'Cukup' : 'Berisiko'}</p>
                            </div>
                            ` : ''}
                            <div class="bg-yellow-900/20 p-3 rounded border-l-2 border-yellow-400">
                                <p class="text-xs text-yellow-300 mb-1">EBITDA</p>
                                <p class="font-bold text-yellow-400">${formatCurrency(ebitda)}</p>
                                <p class="text-xs text-gray-400">Laba sebelum bunga, pajak, depresiasi</p>
                            </div>
                        </div>
                        <div class="mt-4 text-xs text-gray-400">
                            <p>üí° <strong>Catatan Profesional:</strong> Margin kotor menunjukkan efisiensi produksi, 
                            margin operasional mengukur efisiensi operasional, dan margin bersih mencerminkan profitabilitas keseluruhan. 
                            Analisis tren periode-ke-periode memberikan insight yang lebih mendalam.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateCashFlowStatement(container, startDate, endDate) {
            // Get cash transactions for the period
            const cashFlowData = calculateCashFlow(startDate, endDate);
            
            const operatingCashFlow = cashFlowData.operating;
            const investingCashFlow = cashFlowData.investing;
            const financingCashFlow = cashFlowData.financing;
            
            const totalOperating = operatingCashFlow.reduce((sum, item) => sum + item.amount, 0);
            const totalInvesting = investingCashFlow.reduce((sum, item) => sum + item.amount, 0);
            const totalFinancing = financingCashFlow.reduce((sum, item) => sum + item.amount, 0);
            
            const netCashFlow = totalOperating + totalInvesting + totalFinancing;
            const beginningCash = calculateBeginningCash(startDate);
            const endingCash = beginningCash + netCashFlow;
            
            // Store current report data for export
            currentReportData = {
                type: 'cash-flow',
                totalOperating,
                totalInvesting,
                totalFinancing,
                netCashFlow,
                beginningCash,
                endingCash
            };
            
            container.innerHTML = `
                <!-- Period Information Alert -->
                <div class="mb-6 p-4 rounded-lg border-l-4 border-blue-400 bg-blue-900/20">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üìÖ</span>
                        <div>
                            <h3 class="font-bold text-lg text-blue-400">PERIODE LAPORAN</h3>
                            <p class="text-sm text-gray-300">
                                ${startDate && endDate 
                                    ? `Arus kas periode ${formatDate(startDate)} - ${formatDate(endDate)}`
                                    : 'Arus kas dari semua transaksi yang tersedia'
                                }
                            </p>
                        </div>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- OPERATING ACTIVITIES -->
                    <div class="bg-blue-900/20 p-6 rounded-lg border-l-4 border-blue-400">
                        <h4 class="font-bold text-xl mb-4 text-blue-400">üè¢ AKTIVITAS OPERASI</h4>
                        ${operatingCashFlow.length > 0 ? operatingCashFlow.map(item => `
                            <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                <div>
                                    <span class="text-gray-300">${item.description}</span>
                                    <div class="text-xs text-gray-400 mt-1">
                                        ${formatDate(item.date)} | ${item.reference} | ${item.counterAccounts}
                                    </div>
                                </div>
                                <span class="font-mono ${item.amount >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${item.amount >= 0 ? '+' : ''}${formatCurrency(item.amount)}
                                </span>
                            </div>
                        `).join('') : `
                            <div class="text-center py-4 text-gray-400">
                                Tidak ada aktivitas operasi pada periode ini
                            </div>
                        `}
                        <div class="bg-blue-800/30 p-3 rounded border-t-2 border-blue-400 mt-4">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">Kas Bersih dari Aktivitas Operasi</span>
                                <span class="font-bold text-lg font-mono ${totalOperating >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${totalOperating >= 0 ? '+' : ''}${formatCurrency(totalOperating)}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- INVESTING ACTIVITIES -->
                    <div class="bg-purple-900/20 p-6 rounded-lg border-l-4 border-purple-400">
                        <h4 class="font-bold text-xl mb-4 text-purple-400">üèóÔ∏è AKTIVITAS INVESTASI</h4>
                        ${investingCashFlow.length > 0 ? investingCashFlow.map(item => `
                            <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                <div>
                                    <span class="text-gray-300">${item.description}</span>
                                    <div class="text-xs text-gray-400 mt-1">
                                        ${formatDate(item.date)} | ${item.reference} | ${item.counterAccounts}
                                    </div>
                                </div>
                                <span class="font-mono ${item.amount >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${item.amount >= 0 ? '+' : ''}${formatCurrency(item.amount)}
                                </span>
                            </div>
                        `).join('') : `
                            <div class="text-center py-4 text-gray-400">
                                Tidak ada aktivitas investasi pada periode ini
                            </div>
                        `}
                        <div class="bg-purple-800/30 p-3 rounded border-t-2 border-purple-400 mt-4">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">Kas Bersih dari Aktivitas Investasi</span>
                                <span class="font-bold text-lg font-mono ${totalInvesting >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${totalInvesting >= 0 ? '+' : ''}${formatCurrency(totalInvesting)}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FINANCING ACTIVITIES -->
                    <div class="bg-orange-900/20 p-6 rounded-lg border-l-4 border-orange-400">
                        <h4 class="font-bold text-xl mb-4 text-orange-400">üè¶ AKTIVITAS PENDANAAN</h4>
                        ${financingCashFlow.length > 0 ? financingCashFlow.map(item => `
                            <div class="flex justify-between py-2 px-3 hover:bg-dark-light/30 rounded">
                                <div>
                                    <span class="text-gray-300">${item.description}</span>
                                    <div class="text-xs text-gray-400 mt-1">
                                        ${formatDate(item.date)} | ${item.reference} | ${item.counterAccounts}
                                    </div>
                                </div>
                                <span class="font-mono ${item.amount >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${item.amount >= 0 ? '+' : ''}${formatCurrency(item.amount)}
                                </span>
                            </div>
                        `).join('') : `
                            <div class="text-center py-4 text-gray-400">
                                Tidak ada aktivitas pendanaan pada periode ini
                            </div>
                        `}
                        <div class="bg-orange-800/30 p-3 rounded border-t-2 border-orange-400 mt-4">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">Kas Bersih dari Aktivitas Pendanaan</span>
                                <span class="font-bold text-lg font-mono ${totalFinancing >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${totalFinancing >= 0 ? '+' : ''}${formatCurrency(totalFinancing)}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NET CASH FLOW SUMMARY -->
                    <div class="bg-gradient-to-r from-gray-900/40 to-gray-800/40 p-6 rounded-lg border-2 border-gray-400">
                        <h4 class="font-bold text-xl mb-4 text-gray-300 text-center">üí∞ RINGKASAN ARUS KAS</h4>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between py-2 border-b border-gray-600">
                                <span class="text-gray-300">Kas Awal Periode</span>
                                <span class="font-mono text-blue-400">${formatCurrency(beginningCash)}</span>
                            </div>
                            
                            <div class="flex justify-between py-2 border-b border-gray-600">
                                <span class="text-gray-300">Kas dari Aktivitas Operasi</span>
                                <span class="font-mono ${totalOperating >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${totalOperating >= 0 ? '+' : ''}${formatCurrency(totalOperating)}
                                </span>
                            </div>
                            
                            <div class="flex justify-between py-2 border-b border-gray-600">
                                <span class="text-gray-300">Kas dari Aktivitas Investasi</span>
                                <span class="font-mono ${totalInvesting >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${totalInvesting >= 0 ? '+' : ''}${formatCurrency(totalInvesting)}
                                </span>
                            </div>
                            
                            <div class="flex justify-between py-2 border-b border-gray-600">
                                <span class="text-gray-300">Kas dari Aktivitas Pendanaan</span>
                                <span class="font-mono ${totalFinancing >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${totalFinancing >= 0 ? '+' : ''}${formatCurrency(totalFinancing)}
                                </span>
                            </div>
                            
                            <div class="flex justify-between py-3 border-t-2 border-gray-400 font-bold text-lg">
                                <span>Perubahan Bersih Kas</span>
                                <span class="font-mono ${netCashFlow >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${netCashFlow >= 0 ? '+' : ''}${formatCurrency(netCashFlow)}
                                </span>
                            </div>
                            
                            <div class="flex justify-between py-3 border-t-2 border-yellow-400 font-bold text-xl">
                                <span class="text-yellow-400">Kas Akhir Periode</span>
                                <span class="font-mono text-yellow-400">${formatCurrency(endingCash)}</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-gray-800/50 rounded text-center">
                            <p class="text-sm text-gray-300">
                                ${netCashFlow >= 0 ? 
                                    '‚úÖ Arus kas positif menunjukkan kondisi keuangan yang sehat' : 
                                    '‚ö†Ô∏è Arus kas negatif memerlukan perhatian manajemen'
                                }
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateTrialBalance(container, startDate, endDate) {
            const periodBalances = calculatePeriodBalances(startDate, endDate);
            const nonZeroAccounts = accounts.filter(acc => periodBalances[acc.code] !== 0);
            
            const totalDebit = nonZeroAccounts.filter(acc => ['Aset', 'Beban'].includes(acc.type) && periodBalances[acc.code] > 0)
                                             .reduce((sum, acc) => sum + periodBalances[acc.code], 0);
            const totalCredit = nonZeroAccounts.filter(acc => ['Liabilitas', 'Modal', 'Pendapatan'].includes(acc.type) && periodBalances[acc.code] > 0)
                                              .reduce((sum, acc) => sum + periodBalances[acc.code], 0);
            
            const isBalanced = Math.abs(totalDebit - totalCredit) < 0.01;
            
            // Show balance alert for trial balance
            showBalanceAlert(isBalanced, totalDebit - totalCredit, totalDebit, totalCredit, 'trial-balance');
            
            // Store current report data for export
            currentReportData = {
                type: 'trial-balance',
                totalDebit,
                totalCredit,
                isBalanced,
                accounts: nonZeroAccounts.map(acc => ({
                    code: acc.code,
                    name: acc.name,
                    type: acc.type,
                    balance: periodBalances[acc.code]
                }))
            };
            
            container.innerHTML = `
                <!-- Period Information Alert -->
                <div class="mb-6 p-4 rounded-lg border-l-4 border-blue-400 bg-blue-900/20">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üìÖ</span>
                        <div>
                            <h3 class="font-bold text-lg text-blue-400">PERIODE LAPORAN</h3>
                            <p class="text-sm text-gray-300">
                                ${startDate && endDate 
                                    ? `Saldo akun berdasarkan transaksi periode ${formatDate(startDate)} - ${formatDate(endDate)}`
                                    : 'Saldo akun berdasarkan semua transaksi yang tersedia'
                                }
                            </p>
                        </div>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto">
                    <div class="overflow-x-auto">
                        <table class="w-full bg-dark-light/30 rounded-lg overflow-hidden">
                            <thead class="bg-primary/20">
                                <tr class="border-b-2 border-primary">
                                    <th class="text-left py-4 px-4 font-bold">Kode</th>
                                    <th class="text-left py-4 px-4 font-bold">Nama Akun</th>
                                    <th class="text-left py-4 px-4 font-bold">Jenis</th>
                                    <th class="text-right py-4 px-4 font-bold">Debit</th>
                                    <th class="text-right py-4 px-4 font-bold">Kredit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${nonZeroAccounts.map((acc, index) => {
                                    const isDebitBalance = ['Aset', 'Beban'].includes(acc.type);
                                    const balance = periodBalances[acc.code];
                                    return `
                                        <tr class="border-b border-gray-700 hover:bg-dark-light/50 ${index % 2 === 0 ? 'bg-dark-light/10' : ''}">
                                            <td class="py-3 px-4 font-mono text-sm">${acc.code}</td>
                                            <td class="py-3 px-4">${acc.name}</td>
                                            <td class="py-3 px-4">
                                                <span class="px-2 py-1 rounded text-xs ${
                                                    acc.type === 'Aset' ? 'bg-green-900/30 text-green-400' :
                                                    acc.type === 'Liabilitas' ? 'bg-red-900/30 text-red-400' :
                                                    acc.type === 'Modal' ? 'bg-blue-900/30 text-blue-400' :
                                                    acc.type === 'Pendapatan' ? 'bg-purple-900/30 text-purple-400' :
                                                    'bg-orange-900/30 text-orange-400'
                                                }">
                                                    ${acc.type}
                                                </span>
                                            </td>
                                            <td class="py-3 px-4 text-right font-mono">
                                                ${isDebitBalance && balance > 0 ? formatCurrency(balance) : ''}
                                            </td>
                                            <td class="py-3 px-4 text-right font-mono">
                                                ${!isDebitBalance && balance > 0 ? formatCurrency(balance) : ''}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                            <tfoot class="bg-gray-800/50">
                                <tr class="border-t-2 border-white">
                                    <td class="py-4 px-4 font-bold text-lg" colspan="3">TOTAL</td>
                                    <td class="py-4 px-4 text-right font-bold text-lg font-mono text-green-400">
                                        ${formatCurrency(totalDebit)}
                                    </td>
                                    <td class="py-4 px-4 text-right font-bold text-lg font-mono text-red-400">
                                        ${formatCurrency(totalCredit)}
                                    </td>
                                </tr>
                                <tr class="border-t border-gray-600">
                                    <td class="py-2 px-4 text-sm text-gray-400" colspan="3">
                                        Status: ${isBalanced ? '‚úÖ Seimbang' : '‚ö†Ô∏è Tidak Seimbang'}
                                    </td>
                                    <td class="py-2 px-4 text-right text-sm font-mono ${isBalanced ? 'text-green-400' : 'text-red-400'}" colspan="2">
                                        Selisih: ${formatCurrency(Math.abs(totalDebit - totalCredit))}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- Summary Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                        <div class="bg-green-900/20 p-4 rounded-lg border-l-4 border-green-400">
                            <h5 class="font-semibold text-green-400 mb-2">Total Debit</h5>
                            <p class="text-2xl font-mono font-bold text-green-400">${formatCurrency(totalDebit)}</p>
                            <p class="text-sm text-gray-400">${nonZeroAccounts.filter(acc => ['Aset', 'Beban'].includes(acc.type)).length} akun</p>
                        </div>
                        
                        <div class="bg-red-900/20 p-4 rounded-lg border-l-4 border-red-400">
                            <h5 class="font-semibold text-red-400 mb-2">Total Kredit</h5>
                            <p class="text-2xl font-mono font-bold text-red-400">${formatCurrency(totalCredit)}</p>
                            <p class="text-sm text-gray-400">${nonZeroAccounts.filter(acc => ['Liabilitas', 'Modal', 'Pendapatan'].includes(acc.type)).length} akun</p>
                        </div>
                        
                        <div class="bg-${isBalanced ? 'blue' : 'yellow'}-900/20 p-4 rounded-lg border-l-4 border-${isBalanced ? 'blue' : 'yellow'}-400">
                            <h5 class="font-semibold text-${isBalanced ? 'blue' : 'yellow'}-400 mb-2">Status Balance</h5>
                            <p class="text-2xl font-bold text-${isBalanced ? 'blue' : 'yellow'}-400">
                                ${isBalanced ? '‚úÖ Seimbang' : '‚ö†Ô∏è Tidak Seimbang'}
                            </p>
                            <p class="text-sm text-gray-400">Selisih: ${formatCurrency(Math.abs(totalDebit - totalCredit))}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper functions for period calculations
        function calculatePeriodBalances(startDate, endDate) {
            const balances = {};
            
            // Initialize all accounts with zero balance
            accounts.forEach(acc => {
                balances[acc.code] = 0;
            });
            
            // If no date range specified, use all transactions
            const filteredTransactions = transactions.filter(transaction => {
                if (!startDate && !endDate) return true;
                if (startDate && transaction.date < startDate) return false;
                if (endDate && transaction.date > endDate) return false;
                return true;
            });
            
            // Calculate balances based on filtered transactions
            filteredTransactions.forEach(transaction => {
                transaction.entries.forEach(entry => {
                    const account = accounts.find(acc => acc.code === entry.account);
                    if (account) {
                        if (['Aset', 'Beban'].includes(account.type)) {
                            balances[entry.account] += entry.debit - entry.credit;
                        } else {
                            balances[entry.account] += entry.credit - entry.debit;
                        }
                    }
                });
            });
            
            return balances;
        }

        function calculateComprehensiveIncome(startDate, endDate) {
            // Calculate detailed income statement components
            const revenue = calculatePeriodRevenue(startDate, endDate);
            const expenses = calculatePeriodExpenses(startDate, endDate);
            
            // Classify revenue streams
            const operatingRevenue = revenue.filter(r => 
                r.name.toLowerCase().includes('penjualan') ||
                r.name.toLowerCase().includes('pendapatan jasa') ||
                r.name.toLowerCase().includes('pendapatan utama')
            );
            
            const nonOperatingRevenue = revenue.filter(r => !operatingRevenue.includes(r));
            
            // Classify expense categories
            const cogs = expenses.filter(e => 
                e.name.toLowerCase().includes('harga pokok') ||
                e.name.toLowerCase().includes('hpp') ||
                e.name.toLowerCase().includes('cost of goods')
            );
            
            const operatingExpenses = expenses.filter(e => 
                (e.name.toLowerCase().includes('gaji') ||
                 e.name.toLowerCase().includes('sewa') ||
                 e.name.toLowerCase().includes('listrik') ||
                 e.name.toLowerCase().includes('telepon') ||
                 e.name.toLowerCase().includes('administrasi') ||
                 e.name.toLowerCase().includes('pemasaran') ||
                 e.name.toLowerCase().includes('penyusutan') ||
                 e.name.toLowerCase().includes('asuransi')) &&
                !cogs.includes(e) &&
                !e.name.toLowerCase().includes('pajak penghasilan')
            );
            
            const nonOperatingExpenses = expenses.filter(e => 
                !cogs.includes(e) && 
                !operatingExpenses.includes(e) &&
                !e.name.toLowerCase().includes('pajak penghasilan')
            );
            
            // Calculate comprehensive income components
            const totalOperatingRevenue = operatingRevenue.reduce((sum, r) => sum + r.amount, 0);
            const totalNonOperatingRevenue = nonOperatingRevenue.reduce((sum, r) => sum + r.amount, 0);
            const totalRevenue = totalOperatingRevenue + totalNonOperatingRevenue;
            
            const totalCOGS = cogs.reduce((sum, e) => sum + e.amount, 0);
            const grossProfit = totalOperatingRevenue - totalCOGS;
            
            const totalOperatingExpenses = operatingExpenses.reduce((sum, e) => sum + e.amount, 0);
            const operatingIncome = grossProfit - totalOperatingExpenses;
            
            const totalNonOperatingExpenses = nonOperatingExpenses.reduce((sum, e) => sum + e.amount, 0);
            const incomeBeforeTax = operatingIncome + totalNonOperatingRevenue - totalNonOperatingExpenses;
            
            // Calculate tax expense using tax settings
            const taxExpense = calculateTaxExpense(incomeBeforeTax, totalOperatingRevenue, grossProfit, operatingIncome);
            const netIncome = incomeBeforeTax - taxExpense;
            
            const totalExpenses = totalCOGS + totalOperatingExpenses + totalNonOperatingExpenses + taxExpense;
            
            return {
                totalRevenue,
                totalOperatingRevenue,
                totalNonOperatingRevenue,
                totalCOGS,
                grossProfit,
                totalOperatingExpenses,
                operatingIncome,
                totalNonOperatingExpenses,
                incomeBeforeTax,
                taxExpense,
                netIncome,
                totalExpenses,
                // Additional metrics
                grossMargin: totalOperatingRevenue > 0 ? (grossProfit / totalOperatingRevenue) * 100 : 0,
                operatingMargin: totalOperatingRevenue > 0 ? (operatingIncome / totalOperatingRevenue) * 100 : 0,
                netMargin: totalRevenue > 0 ? (netIncome / totalRevenue) * 100 : 0,
                // Component arrays for detailed reporting
                operatingRevenue,
                nonOperatingRevenue,
                cogs,
                operatingExpenses,
                nonOperatingExpenses
            };
        }

        // Tax Management Functions
        function getTaxSettings() {
            const defaultSettings = {
                enableIncomeTax: false,
                corporateTaxRate: 25,
                taxCalculationBasis: 'income-before-tax',
                minimumTaxableIncome: 0,
                roundTaxAmount: true,
                taxExpenseAccount: '5500',
                taxPayableAccount: '2300',
                autoCreateTaxEntry: false
            };
            
            const savedSettings = localStorage.getItem('taxSettings');
            return savedSettings ? { ...defaultSettings, ...JSON.parse(savedSettings) } : defaultSettings;
        }

        function saveTaxSettings() {
            const settings = {
                enableIncomeTax: document.getElementById('enableIncomeTax').checked,
                corporateTaxRate: parseFloat(document.getElementById('corporateTaxRate').value) || 25,
                taxCalculationBasis: document.getElementById('taxCalculationBasis').value,
                minimumTaxableIncome: parseFloat(document.getElementById('minimumTaxableIncome').value) || 0,
                roundTaxAmount: document.getElementById('roundTaxAmount').checked,
                taxExpenseAccount: document.getElementById('taxExpenseAccount').value,
                taxPayableAccount: document.getElementById('taxPayableAccount').value,
                autoCreateTaxEntry: document.getElementById('autoCreateTaxEntry').checked
            };
            
            // Validate settings
            if (settings.enableIncomeTax) {
                if (!settings.taxExpenseAccount || !settings.taxPayableAccount) {
                    alert('‚ö†Ô∏è Pilih akun beban pajak dan utang pajak terlebih dahulu');
                    return;
                }
                
                if (settings.corporateTaxRate < 0 || settings.corporateTaxRate > 100) {
                    alert('‚ö†Ô∏è Tarif pajak harus antara 0% - 100%');
                    return;
                }
            }
            
            localStorage.setItem('taxSettings', JSON.stringify(settings));
            
            // Update tax account selects
            updateTaxAccountSelects();
            
            alert(`‚úÖ Pengaturan pajak berhasil disimpan!\n\n` +
                  `Status: ${settings.enableIncomeTax ? 'Aktif' : 'Nonaktif'}\n` +
                  `Tarif: ${settings.corporateTaxRate}%\n` +
                  `Basis: ${getTaxBasisLabel(settings.taxCalculationBasis)}\n` +
                  `Minimum: ${formatCurrency(settings.minimumTaxableIncome)}`);
        }

        function loadTaxSettings() {
            const settings = getTaxSettings();
            
            document.getElementById('enableIncomeTax').checked = settings.enableIncomeTax;
            document.getElementById('corporateTaxRate').value = settings.corporateTaxRate;
            document.getElementById('taxCalculationBasis').value = settings.taxCalculationBasis;
            document.getElementById('minimumTaxableIncome').value = settings.minimumTaxableIncome;
            document.getElementById('roundTaxAmount').checked = settings.roundTaxAmount;
            document.getElementById('taxExpenseAccount').value = settings.taxExpenseAccount;
            document.getElementById('taxPayableAccount').value = settings.taxPayableAccount;
            document.getElementById('autoCreateTaxEntry').checked = settings.autoCreateTaxEntry;
            
            toggleTaxSettings();
            updateTaxPreview();
        }

        function resetTaxSettings() {
            if (confirm('Yakin ingin mereset pengaturan pajak ke default?')) {
                localStorage.removeItem('taxSettings');
                loadTaxSettings();
                alert('üîÑ Pengaturan pajak telah direset ke default!');
            }
        }

        function toggleTaxSettings() {
            const isEnabled = document.getElementById('enableIncomeTax').checked;
            const taxRateSettings = document.getElementById('taxRateSettings');
            const taxEnabledInfo = document.getElementById('taxEnabledInfo');
            const taxDisabledInfo = document.getElementById('taxDisabledInfo');
            
            if (isEnabled) {
                taxRateSettings.classList.remove('hidden');
                taxEnabledInfo.classList.remove('hidden');
                taxDisabledInfo.classList.add('hidden');
            } else {
                taxRateSettings.classList.add('hidden');
                taxEnabledInfo.classList.add('hidden');
                taxDisabledInfo.classList.remove('hidden');
            }
            
            updateTaxPreview();
        }

        function updateTaxAccountSelects() {
            const taxExpenseSelect = document.getElementById('taxExpenseAccount');
            const taxPayableSelect = document.getElementById('taxPayableAccount');
            
            if (taxExpenseSelect && taxPayableSelect) {
                // Update tax expense account options
                const currentTaxExpense = taxExpenseSelect.value;
                taxExpenseSelect.innerHTML = '<option value="">Pilih Akun Beban Pajak</option>';
                
                accounts.filter(acc => acc.type === 'Beban').forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.code;
                    option.textContent = `${account.code} - ${account.name}`;
                    taxExpenseSelect.appendChild(option);
                });
                
                taxExpenseSelect.value = currentTaxExpense;
                
                // Update tax payable account options
                const currentTaxPayable = taxPayableSelect.value;
                taxPayableSelect.innerHTML = '<option value="">Pilih Akun Utang Pajak</option>';
                
                accounts.filter(acc => acc.type === 'Liabilitas').forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.code;
                    option.textContent = `${account.code} - ${account.name}`;
                    taxPayableSelect.appendChild(option);
                });
                
                taxPayableSelect.value = currentTaxPayable;
            }
        }

        function updateTaxPreview() {
            const settings = {
                enableIncomeTax: document.getElementById('enableIncomeTax').checked,
                corporateTaxRate: parseFloat(document.getElementById('corporateTaxRate').value) || 25,
                taxCalculationBasis: document.getElementById('taxCalculationBasis').value,
                minimumTaxableIncome: parseFloat(document.getElementById('minimumTaxableIncome').value) || 0
            };
            
            if (!settings.enableIncomeTax) {
                document.getElementById('previewTaxBasis').textContent = 'Rp 0';
                document.getElementById('previewTaxRate').textContent = '0%';
                document.getElementById('previewTaxAmount').textContent = 'Rp 0';
                return;
            }
            
            // Calculate current period income for preview
            const incomeData = calculateComprehensiveIncome();
            let taxBasis = 0;
            
            switch (settings.taxCalculationBasis) {
                case 'income-before-tax':
                    taxBasis = incomeData.incomeBeforeTax;
                    break;
                case 'operating-income':
                    taxBasis = incomeData.operatingIncome;
                    break;
                case 'gross-profit':
                    taxBasis = incomeData.grossProfit;
                    break;
                case 'revenue':
                    taxBasis = incomeData.totalRevenue;
                    break;
            }
            
            const taxableIncome = Math.max(0, taxBasis - settings.minimumTaxableIncome);
            const taxAmount = taxableIncome * (settings.corporateTaxRate / 100);
            
            document.getElementById('previewTaxBasis').textContent = formatCurrency(taxBasis);
            document.getElementById('previewTaxRate').textContent = `${settings.corporateTaxRate}%`;
            document.getElementById('previewTaxAmount').textContent = formatCurrency(taxAmount);
        }

        function calculateTaxExpense(incomeBeforeTax, totalRevenue, grossProfit, operatingIncome) {
            const settings = getTaxSettings();
            
            if (!settings.enableIncomeTax) {
                return 0;
            }
            
            let taxBasis = 0;
            
            switch (settings.taxCalculationBasis) {
                case 'income-before-tax':
                    taxBasis = incomeBeforeTax;
                    break;
                case 'operating-income':
                    taxBasis = operatingIncome;
                    break;
                case 'gross-profit':
                    taxBasis = grossProfit;
                    break;
                case 'revenue':
                    taxBasis = totalRevenue;
                    break;
                default:
                    taxBasis = incomeBeforeTax;
            }
            
            // Apply minimum taxable income threshold
            const taxableIncome = Math.max(0, taxBasis - settings.minimumTaxableIncome);
            
            if (taxableIncome <= 0) {
                return 0;
            }
            
            // Calculate tax
            let taxAmount = taxableIncome * (settings.corporateTaxRate / 100);
            
            // Round if enabled
            if (settings.roundTaxAmount) {
                taxAmount = Math.round(taxAmount / 1000) * 1000;
            }
            
            return Math.max(0, taxAmount);
        }

        function getTaxBasisLabel(basis) {
            const labels = {
                'income-before-tax': 'Laba Sebelum Pajak (EBT)',
                'operating-income': 'Laba Operasional (EBIT)',
                'gross-profit': 'Laba Kotor',
                'revenue': 'Total Pendapatan'
            };
            return labels[basis] || basis;
        }

        function createTaxJournalEntry(taxAmount, taxExpenseAccount, taxPayableAccount, period) {
            if (taxAmount <= 0 || !taxExpenseAccount || !taxPayableAccount) {
                return null;
            }
            
            const transaction = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                ref: `TAX${Date.now()}`,
                desc: `Beban Pajak Penghasilan ${period || 'Periode Ini'}`,
                entries: [
                    {
                        account: taxExpenseAccount,
                        debit: taxAmount,
                        credit: 0
                    },
                    {
                        account: taxPayableAccount,
                        debit: 0,
                        credit: taxAmount
                    }
                ]
            };
            
            return transaction;
        }

        function calculateNetIncome(startDate, endDate) {
            const revenue = calculatePeriodRevenue(startDate, endDate);
            const expenses = calculatePeriodExpenses(startDate, endDate);
            
            const totalRevenue = revenue.reduce((sum, acc) => sum + acc.amount, 0);
            const totalExpenses = expenses.reduce((sum, acc) => sum + acc.amount, 0);
            
            return totalRevenue - totalExpenses;
        }

        function calculatePeriodRevenue(startDate, endDate) {
            const revenue = [];
            
            // Filter transactions by period
            const filteredTransactions = transactions.filter(transaction => {
                if (!startDate && !endDate) return true;
                if (startDate && transaction.date < startDate) return false;
                if (endDate && transaction.date > endDate) return false;
                return true;
            });
            
            filteredTransactions.forEach(transaction => {
                transaction.entries.forEach(entry => {
                    const account = accounts.find(acc => acc.code === entry.account);
                    if (account && account.type === 'Pendapatan' && entry.credit > 0) {
                        const existingRevenue = revenue.find(r => r.code === account.code);
                        if (existingRevenue) {
                            existingRevenue.amount += entry.credit;
                        } else {
                            revenue.push({
                                code: account.code,
                                name: account.name,
                                amount: entry.credit
                            });
                        }
                    }
                });
            });
            
            return revenue;
        }

        function calculatePeriodExpenses(startDate, endDate) {
            const expenses = [];
            
            // Filter transactions by period
            const filteredTransactions = transactions.filter(transaction => {
                if (!startDate && !endDate) return true;
                if (startDate && transaction.date < startDate) return false;
                if (endDate && transaction.date > endDate) return false;
                return true;
            });
            
            filteredTransactions.forEach(transaction => {
                transaction.entries.forEach(entry => {
                    const account = accounts.find(acc => acc.code === entry.account);
                    if (account && account.type === 'Beban' && entry.debit > 0) {
                        const existingExpense = expenses.find(e => e.code === account.code);
                        if (existingExpense) {
                            existingExpense.amount += entry.debit;
                        } else {
                            expenses.push({
                                code: account.code,
                                name: account.name,
                                amount: entry.debit
                            });
                        }
                    }
                });
            });
            
            return expenses;
        }

        function calculateCashFlow(startDate, endDate) {
            const operating = [];
            const investing = [];
            const financing = [];
            
            // Filter transactions by period
            const filteredTransactions = transactions.filter(transaction => {
                if (!startDate && !endDate) return true;
                if (startDate && transaction.date < startDate) return false;
                if (endDate && transaction.date > endDate) return false;
                return true;
            });
            
            filteredTransactions.forEach(transaction => {
                transaction.entries.forEach(entry => {
                    const account = accounts.find(acc => acc.code === entry.account);
                    if (!account) return;
                    
                    // Only process cash and bank accounts
                    if (!account.name.toLowerCase().includes('kas') && !account.name.toLowerCase().includes('bank')) {
                        return;
                    }
                    
                    const amount = entry.debit - entry.credit;
                    if (amount === 0) return;
                    
                    // Classify cash flow based on transaction description and counter account
                    const description = transaction.desc;
                    const isOperating = description.toLowerCase().includes('penjualan') ||
                                      description.toLowerCase().includes('pembelian') ||
                                      description.toLowerCase().includes('gaji') ||
                                      description.toLowerCase().includes('sewa') ||
                                      description.toLowerCase().includes('operasional');
                    
                    const isInvesting = description.toLowerCase().includes('peralatan') ||
                                      description.toLowerCase().includes('aset') ||
                                      description.toLowerCase().includes('investasi');
                    
                    const isFinancing = description.toLowerCase().includes('modal') ||
                                      description.toLowerCase().includes('pinjaman') ||
                                      description.toLowerCase().includes('utang bank');
                    
                    if (isOperating) {
                        operating.push({
                            description: description,
                            amount: amount
                        });
                    } else if (isInvesting) {
                        investing.push({
                            description: description,
                            amount: amount
                        });
                    } else if (isFinancing) {
                        financing.push({
                            description: description,
                            amount: amount
                        });
                    } else {
                        // Default to operating
                        operating.push({
                            description: description,
                            amount: amount
                        });
                    }
                });
            });
            
            return { operating, investing, financing };
        }

        function calculateBeginningCash(startDate) {
            if (!startDate) return 0;
            
            let beginningCash = 0;
            
            // Get all transactions before the start date
            const beforeStartTransactions = transactions.filter(transaction => 
                transaction.date < startDate
            );
            
            beforeStartTransactions.forEach(transaction => {
                transaction.entries.forEach(entry => {
                    const account = accounts.find(acc => acc.code === entry.account);
                    if (account && (account.name.toLowerCase().includes('kas') || account.name.toLowerCase().includes('bank'))) {
                        beginningCash += entry.debit - entry.credit;
                    }
                });
            });
            
            return beginningCash;
        }

        function showBalanceAlert(isBalanced, difference, leftSide, rightSide, reportType = 'balance-sheet') {
            const alert = document.getElementById('balanceAlert');
            const icon = document.getElementById('balanceIcon');
            const message = document.getElementById('balanceMessage');
            const detail = document.getElementById('balanceDetail');
            
            if (isBalanced) {
                alert.className = 'mb-4 p-4 rounded-lg border-l-4 border-green-400 bg-green-900/20';
                icon.textContent = '‚úÖ';
                
                if (reportType === 'balance-sheet') {
                    message.textContent = 'Neraca Seimbang';
                    detail.textContent = `Aset (${formatCurrency(leftSide)}) = Kewajiban + Ekuitas (${formatCurrency(rightSide)})`;
                } else {
                    message.textContent = 'Neraca Saldo Seimbang';
                    detail.textContent = `Total Debit (${formatCurrency(leftSide)}) = Total Kredit (${formatCurrency(rightSide)})`;
                }
            } else {
                alert.className = 'mb-4 p-4 rounded-lg border-l-4 border-red-400 bg-red-900/20';
                icon.textContent = '‚ö†Ô∏è';
                
                if (reportType === 'balance-sheet') {
                    message.textContent = 'Neraca Tidak Seimbang';
                    detail.textContent = `Selisih: ${formatCurrency(Math.abs(difference))} - Periksa pencatatan transaksi`;
                } else {
                    message.textContent = 'Neraca Saldo Tidak Seimbang';
                    detail.textContent = `Selisih: ${formatCurrency(Math.abs(difference))} - Ada kesalahan dalam jurnal`;
                }
            }
            
            alert.classList.remove('hidden');
        }

        function exportReport() {
            if (!currentReportData.type) {
                alert('Tidak ada laporan untuk diekspor');
                return;
            }
            
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const period = startDate && endDate ? `${startDate}_${endDate}` : 'all_time';
            
            let csvContent = '';
            let filename = '';
            
            switch (currentReportData.type) {
                case 'balance-sheet':
                    filename = `Neraca_${period}.csv`;
                    csvContent = generateBalanceSheetCSV();
                    break;
                case 'income-statement':
                    filename = `Laba_Rugi_${period}.csv`;
                    csvContent = generateIncomeStatementCSV();
                    break;
                case 'cash-flow':
                    filename = `Arus_Kas_${period}.csv`;
                    csvContent = generateCashFlowCSV();
                    break;
                case 'trial-balance':
                    filename = `Neraca_Saldo_${period}.csv`;
                    csvContent = generateTrialBalanceCSV();
                    break;
            }
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Laporan berhasil diekspor!\nFile: ${filename}`);
        }

        function generateBalanceSheetCSV() {
            let csv = 'NERACA (BALANCE SHEET)\n';
            csv += `Periode: ${document.getElementById('reportPeriod').textContent}\n`;
            csv += `Dibuat: ${new Date().toLocaleString('id-ID')}\n\n`;
            
            csv += 'Kategori,Nama Akun,Jumlah\n';
            csv += 'ASET,,\n';
            // Add asset data here based on current report
            csv += `TOTAL ASET,,${currentReportData.totalAssets}\n\n`;
            
            csv += 'KEWAJIBAN,,\n';
            csv += `TOTAL KEWAJIBAN,,${currentReportData.totalLiabilities}\n\n`;
            
            csv += 'EKUITAS,,\n';
            csv += `TOTAL EKUITAS,,${currentReportData.totalEquity}\n\n`;
            
            csv += `STATUS,${currentReportData.isBalanced ? 'SEIMBANG' : 'TIDAK SEIMBANG'},${currentReportData.balanceDifference}\n`;
            
            return csv;
        }

        function generateIncomeStatementCSV() {
            let csv = 'LAPORAN LABA RUGI (INCOME STATEMENT)\n';
            csv += `Periode: ${document.getElementById('reportPeriod').textContent}\n`;
            csv += `Dibuat: ${new Date().toLocaleString('id-ID')}\n\n`;
            
            csv += 'Kategori,Jumlah\n';
            csv += `Total Pendapatan,${currentReportData.totalRevenue}\n`;
            csv += `Laba Kotor,${currentReportData.grossProfit}\n`;
            csv += `Laba Operasional,${currentReportData.operatingIncome}\n`;
            csv += `Laba Bersih,${currentReportData.netIncome}\n`;
            csv += `Margin Kotor (%),${currentReportData.grossMargin.toFixed(2)}\n`;
            csv += `Margin Bersih (%),${currentReportData.netMargin.toFixed(2)}\n`;
            
            return csv;
        }

        function generateCashFlowCSV() {
            let csv = 'LAPORAN ARUS KAS (CASH FLOW STATEMENT)\n';
            csv += `Periode: ${document.getElementById('reportPeriod').textContent}\n`;
            csv += `Dibuat: ${new Date().toLocaleString('id-ID')}\n\n`;
            
            csv += 'Aktivitas,Jumlah\n';
            csv += `Kas dari Aktivitas Operasi,${currentReportData.totalOperating}\n`;
            csv += `Kas dari Aktivitas Investasi,${currentReportData.totalInvesting}\n`;
            csv += `Kas dari Aktivitas Pendanaan,${currentReportData.totalFinancing}\n`;
            csv += `Perubahan Bersih Kas,${currentReportData.netCashFlow}\n`;
            csv += `Kas Awal Periode,${currentReportData.beginningCash}\n`;
            csv += `Kas Akhir Periode,${currentReportData.endingCash}\n`;
            
            return csv;
        }

        function generateTrialBalanceCSV() {
            let csv = 'NERACA SALDO (TRIAL BALANCE)\n';
            csv += `Periode: ${document.getElementById('reportPeriod').textContent}\n`;
            csv += `Dibuat: ${new Date().toLocaleString('id-ID')}\n\n`;
            
            csv += 'Kode,Nama Akun,Jenis,Debit,Kredit\n';
            
            currentReportData.accounts.forEach(acc => {
                const isDebitBalance = ['Aset', 'Beban'].includes(acc.type);
                const debit = isDebitBalance && acc.balance > 0 ? acc.balance : '';
                const credit = !isDebitBalance && acc.balance > 0 ? acc.balance : '';
                csv += `${acc.code},"${acc.name}",${acc.type},${debit},${credit}\n`;
            });
            
            csv += `\nTOTAL,,,${currentReportData.totalDebit},${currentReportData.totalCredit}\n`;
            csv += `STATUS,${currentReportData.isBalanced ? 'SEIMBANG' : 'TIDAK SEIMBANG'},,${Math.abs(currentReportData.totalDebit - currentReportData.totalCredit)}\n`;
            
            return csv;
        }

        function printReport() {
            window.print();
        }

        // Dashboard functions
        function updateDashboard() {
            const totalAssets = accounts.filter(acc => acc.type === 'Aset').reduce((sum, acc) => sum + acc.balance, 0);
            const totalLiabilities = accounts.filter(acc => acc.type === 'Liabilitas').reduce((sum, acc) => sum + acc.balance, 0);
            const totalEquity = accounts.filter(acc => acc.type === 'Modal').reduce((sum, acc) => sum + acc.balance, 0);
            const totalRevenue = accounts.filter(acc => acc.type === 'Pendapatan').reduce((sum, acc) => sum + acc.balance, 0);
            const totalExpenses = accounts.filter(acc => acc.type === 'Beban').reduce((sum, acc) => sum + acc.balance, 0);
            const monthlyProfit = totalRevenue - totalExpenses;
            
            document.getElementById('totalAssets').textContent = formatCurrency(totalAssets);
            document.getElementById('totalLiabilities').textContent = formatCurrency(totalLiabilities);
            document.getElementById('totalEquity').textContent = formatCurrency(totalEquity);
            document.getElementById('monthlyProfit').textContent = formatCurrency(monthlyProfit);
        }

        // Settings functions
        function saveCompanySettings(event) {
            event.preventDefault();
            
            // Validate required fields
            const requiredFields = ['companyName', 'companyAddress', 'businessType', 'currency', 'taxYear', 'periodStart'];
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('border-red-500');
                    isValid = false;
                } else {
                    field.classList.remove('border-red-500');
                }
            });
            
            if (!isValid) {
                alert('Mohon lengkapi semua field yang wajib diisi (*)');
                return;
            }
            
            // Save settings to localStorage
            const companySettings = {
                name: document.getElementById('companyName').value,
                address: document.getElementById('companyAddress').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
                npwp: document.getElementById('companyNPWP').value,
                businessType: document.getElementById('businessType').value,
                currency: document.getElementById('currency').value,
                taxYear: document.getElementById('taxYear').value,
                periodStart: document.getElementById('periodStart').value,
                website: document.getElementById('companyWebsite').value,
                owner: document.getElementById('companyOwner').value,
                description: document.getElementById('businessDescription').value
            };
            
            localStorage.setItem('companySettings', JSON.stringify(companySettings));
            
            alert('‚úÖ Pengaturan perusahaan berhasil disimpan!');
        }

        function resetCompanySettings() {
            if (confirm('Yakin ingin mereset semua pengaturan ke default?')) {
                document.getElementById('companyName').value = 'PT. Contoh Bisnis';
                document.getElementById('companyAddress').value = 'Jl. Contoh No. 123, Jakarta Pusat 10110';
                document.getElementById('companyPhone').value = '';
                document.getElementById('companyEmail').value = '';
                document.getElementById('companyNPWP').value = '';
                document.getElementById('businessType').value = '';
                document.getElementById('currency').value = 'IDR';
                document.getElementById('taxYear').value = '2024';
                document.getElementById('periodStart').value = new Date().toISOString().split('T')[0];
                document.getElementById('companyWebsite').value = '';
                document.getElementById('companyOwner').value = '';
                document.getElementById('businessDescription').value = '';
                
                // Remove validation errors
                document.querySelectorAll('.border-red-500').forEach(field => {
                    field.classList.remove('border-red-500');
                });
                
                localStorage.removeItem('companySettings');
                alert('üîÑ Pengaturan telah direset ke default!');
            }
        }

        function loadCompanySettings() {
            const savedSettings = localStorage.getItem('companySettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                document.getElementById('companyName').value = settings.name || 'PT. Contoh Bisnis';
                document.getElementById('companyAddress').value = settings.address || 'Jl. Contoh No. 123, Jakarta Pusat 10110';
                document.getElementById('companyPhone').value = settings.phone || '';
                document.getElementById('companyEmail').value = settings.email || '';
                document.getElementById('companyNPWP').value = settings.npwp || '';
                document.getElementById('businessType').value = settings.businessType || '';
                document.getElementById('currency').value = settings.currency || 'IDR';
                document.getElementById('taxYear').value = settings.taxYear || '2024';
                document.getElementById('periodStart').value = settings.periodStart || new Date().toISOString().split('T')[0];
                document.getElementById('companyWebsite').value = settings.website || '';
                document.getElementById('companyOwner').value = settings.owner || '';
                document.getElementById('businessDescription').value = settings.description || '';
            }
        }

        // General Ledger functions
        function filterLedger() {
            const selectedAccount = document.getElementById('ledgerAccountSelect').value;
            const selectedType = document.getElementById('ledgerAccountType').value;
            const startDate = document.getElementById('ledgerStartDate').value;
            const endDate = document.getElementById('ledgerEndDate').value;
            const searchTerm = document.getElementById('ledgerSearchInput').value.toLowerCase();
            
            let filteredTransactions = [];
            let filteredAccounts = accounts;
            
            // Filter accounts by type and search term
            if (selectedType) {
                filteredAccounts = filteredAccounts.filter(acc => acc.type === selectedType);
            }
            
            if (searchTerm) {
                filteredAccounts = filteredAccounts.filter(acc => 
                    acc.name.toLowerCase().includes(searchTerm) || 
                    acc.code.toLowerCase().includes(searchTerm)
                );
            }
            
            // Get all transactions for filtered accounts
            transactions.forEach(transaction => {
                // Filter by date range
                if (startDate && transaction.date < startDate) return;
                if (endDate && transaction.date > endDate) return;
                
                transaction.entries.forEach(entry => {
                    const account = accounts.find(acc => acc.code === entry.account);
                    if (!account) return;
                    
                    // Filter by selected account
                    if (selectedAccount && entry.account !== selectedAccount) return;
                    
                    // Filter by account type and search term
                    const matchesFilter = filteredAccounts.some(acc => acc.code === entry.account);
                    if (!matchesFilter) return;
                    
                    filteredTransactions.push({
                        date: transaction.date,
                        ref: transaction.ref,
                        desc: transaction.desc,
                        account: entry.account,
                        accountName: account.name,
                        accountType: account.type,
                        debit: entry.debit,
                        credit: entry.credit
                    });
                });
            });
            
            // Sort by date and account
            filteredTransactions.sort((a, b) => {
                if (a.date !== b.date) return new Date(a.date) - new Date(b.date);
                return a.account.localeCompare(b.account);
            });
            
            displayLedgerData(filteredTransactions, selectedAccount);
        }

        function displayLedgerData(transactions, selectedAccount) {
            const tbody = document.getElementById('ledgerTableBody');
            const summary = document.getElementById('ledgerSummary');
            const info = document.getElementById('ledgerInfo');
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td class="py-8 px-4 text-center text-gray-400" colspan="7">
                            <div class="flex flex-col items-center">
                                <span class="text-4xl mb-2">üîç</span>
                                <span>Tidak ada transaksi ditemukan dengan filter yang dipilih</span>
                            </div>
                        </td>
                    </tr>
                `;
                summary.classList.add('hidden');
                info.textContent = 'Tidak ada data untuk ditampilkan';
                return;
            }
            
            // Calculate running balance for each account
            const accountBalances = {};
            let totalDebit = 0;
            let totalCredit = 0;
            
            // Initialize account balances with opening balance
            transactions.forEach(t => {
                if (!accountBalances[t.account]) {
                    const account = accounts.find(acc => acc.code === t.account);
                    const openingBalance = getOpeningBalance(t.account);
                    accountBalances[t.account] = {
                        balance: openingBalance,
                        type: account ? account.type : 'Unknown'
                    };
                }
            });
            
            tbody.innerHTML = '';
            let currentAccount = '';
            
            transactions.forEach(transaction => {
                // Add account header if account changes
                if (transaction.account !== currentAccount) {
                    currentAccount = transaction.account;
                    const account = accounts.find(acc => acc.code === transaction.account);
                    
                    if (!selectedAccount) {
                        const headerRow = document.createElement('tr');
                        headerRow.className = 'bg-primary/20 border-t-2 border-primary';
                        headerRow.innerHTML = `
                            <td class="py-3 px-4 font-semibold" colspan="7">
                                ${transaction.account} - ${transaction.accountName} (${transaction.accountType})
                            </td>
                        `;
                        tbody.appendChild(headerRow);
                    }
                }
                
                // Update running balance
                const accountInfo = accountBalances[transaction.account];
                if (['Aset', 'Beban'].includes(accountInfo.type)) {
                    accountInfo.balance += transaction.debit - transaction.credit;
                } else {
                    accountInfo.balance += transaction.credit - transaction.debit;
                }
                
                totalDebit += transaction.debit;
                totalCredit += transaction.credit;
                
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-dark-light/30';
                row.innerHTML = `
                    <td class="py-3 px-4">${formatDate(transaction.date)}</td>
                    <td class="py-3 px-4">${transaction.ref}</td>
                    <td class="py-3 px-4">${transaction.desc}</td>
                    <td class="py-3 px-4">${selectedAccount ? transaction.accountName : `${transaction.account} - ${transaction.accountName}`}</td>
                    <td class="py-3 px-4 text-right">${transaction.debit > 0 ? formatCurrency(transaction.debit) : ''}</td>
                    <td class="py-3 px-4 text-right">${transaction.credit > 0 ? formatCurrency(transaction.credit) : ''}</td>
                    <td class="py-3 px-4 text-right font-semibold ${accountInfo.balance >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${formatCurrency(Math.abs(accountInfo.balance))}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update summary
            document.getElementById('totalTransactions').textContent = transactions.length;
            document.getElementById('totalDebitAmount').textContent = formatCurrency(totalDebit);
            document.getElementById('totalCreditAmount').textContent = formatCurrency(totalCredit);
            
            // Calculate final balance
            let finalBalance = 0;
            if (selectedAccount) {
                const account = accounts.find(acc => acc.code === selectedAccount);
                finalBalance = account ? account.balance : 0;
                document.getElementById('finalBalance').textContent = formatCurrency(Math.abs(finalBalance));
                info.textContent = `Menampilkan ${transactions.length} transaksi untuk akun ${selectedAccount}`;
            } else {
                const netChange = totalDebit - totalCredit;
                document.getElementById('finalBalance').textContent = formatCurrency(Math.abs(netChange));
                info.textContent = `Menampilkan ${transactions.length} transaksi dari ${Object.keys(accountBalances).length} akun`;
            }
            
            summary.classList.remove('hidden');
        }

        function getOpeningBalance(accountCode) {
            const account = accounts.find(acc => acc.code === accountCode);
            if (!account) return 0;
            
            // Calculate balance from all transactions before the filtered period
            const startDate = document.getElementById('ledgerStartDate').value;
            if (!startDate) return 0;
            
            let openingBalance = 0;
            transactions.forEach(transaction => {
                if (transaction.date >= startDate) return;
                
                transaction.entries.forEach(entry => {
                    if (entry.account !== accountCode) return;
                    
                    if (['Aset', 'Beban'].includes(account.type)) {
                        openingBalance += entry.debit - entry.credit;
                    } else {
                        openingBalance += entry.credit - entry.debit;
                    }
                });
            });
            
            return openingBalance;
        }

        function resetLedgerFilter() {
            document.getElementById('ledgerAccountSelect').value = '';
            document.getElementById('ledgerAccountType').value = '';
            document.getElementById('ledgerStartDate').value = '';
            document.getElementById('ledgerEndDate').value = '';
            document.getElementById('ledgerSearchInput').value = '';
            
            const tbody = document.getElementById('ledgerTableBody');
            tbody.innerHTML = `
                <tr>
                    <td class="py-8 px-4 text-center text-gray-400" colspan="7">
                        <div class="flex flex-col items-center">
                            <span class="text-4xl mb-2">üìö</span>
                            <span>Pilih akun atau gunakan filter untuk melihat buku besar</span>
                        </div>
                    </td>
                </tr>
            `;
            
            document.getElementById('ledgerSummary').classList.add('hidden');
            document.getElementById('ledgerInfo').textContent = 'Pilih akun untuk melihat riwayat transaksi';
        }

        function exportLedger() {
            const selectedAccount = document.getElementById('ledgerAccountSelect').value;
            const selectedType = document.getElementById('ledgerAccountType').value;
            const startDate = document.getElementById('ledgerStartDate').value;
            const endDate = document.getElementById('ledgerEndDate').value;
            const searchTerm = document.getElementById('ledgerSearchInput').value;
            
            // Get current filtered data
            let exportData = [];
            let filteredAccounts = accounts;
            
            // Apply filters
            if (selectedType) {
                filteredAccounts = filteredAccounts.filter(acc => acc.type === selectedType);
            }
            
            if (searchTerm) {
                filteredAccounts = filteredAccounts.filter(acc => 
                    acc.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    acc.code.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Collect transaction data
            transactions.forEach(transaction => {
                if (startDate && transaction.date < startDate) return;
                if (endDate && transaction.date > endDate) return;
                
                transaction.entries.forEach(entry => {
                    const account = accounts.find(acc => acc.code === entry.account);
                    if (!account) return;
                    
                    if (selectedAccount && entry.account !== selectedAccount) return;
                    
                    const matchesFilter = filteredAccounts.some(acc => acc.code === entry.account);
                    if (!matchesFilter) return;
                    
                    exportData.push({
                        Tanggal: transaction.date,
                        Referensi: transaction.ref,
                        Deskripsi: transaction.desc,
                        'Kode Akun': entry.account,
                        'Nama Akun': account.name,
                        'Jenis Akun': account.type,
                        Debit: entry.debit,
                        Kredit: entry.credit
                    });
                });
            });
            
            if (exportData.length === 0) {
                alert('Tidak ada data untuk diekspor dengan filter yang dipilih');
                return;
            }
            
            // Create CSV content
            const headers = Object.keys(exportData[0]);
            let csvContent = headers.join(',') + '\n';
            
            exportData.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header];
                    if (typeof value === 'string' && value.includes(',')) {
                        value = `"${value}"`;
                    }
                    return value;
                });
                csvContent += values.join(',') + '\n';
            });
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            // Generate filename
            let filename = 'buku_besar';
            if (selectedAccount) {
                const account = accounts.find(acc => acc.code === selectedAccount);
                filename += `_${selectedAccount}_${account ? account.name.replace(/[^a-zA-Z0-9]/g, '_') : ''}`;
            } else if (selectedType) {
                filename += `_${selectedType}`;
            }
            if (startDate) filename += `_${startDate}`;
            if (endDate) filename += `_${endDate}`;
            filename += '.csv';
            
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Data buku besar berhasil diekspor!\nFile: ${filename}\nTotal: ${exportData.length} transaksi`);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Bank Reconciliation Functions
        function downloadBankTemplate() {
            const selectedBank = document.getElementById('reconciliationBankSelect').value;
            if (!selectedBank) {
                alert('Pilih akun bank terlebih dahulu');
                return;
            }
            
            const bankAccount = accounts.find(acc => acc.code === selectedBank);
            const bankName = bankAccount ? bankAccount.name : 'Bank';
            
            // Create CSV template
            const headers = [
                'Tanggal',
                'Deskripsi',
                'Referensi',
                'Debit',
                'Kredit',
                'Saldo'
            ];
            
            const sampleData = [
                ['2024-01-01', 'Saldo Awal', 'OPENING', '', '', '10000000'],
                ['2024-01-02', 'Transfer Masuk dari PT ABC', 'TRF001', '5000000', '', '15000000'],
                ['2024-01-03', 'Pembayaran Listrik', 'PLN001', '', '500000', '14500000'],
                ['2024-01-04', 'Penjualan Tunai', 'CASH001', '2000000', '', '16500000'],
                ['2024-01-05', 'Biaya Admin Bank', 'ADM001', '', '15000', '16485000']
            ];
            
            let csvContent = headers.join(',') + '\n';
            sampleData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });
            
            // Add instructions as comments
            const instructions = `
# INSTRUKSI PENGGUNAAN TEMPLATE MUTASI BANK
# 1. Isi data sesuai format yang telah disediakan
# 2. Tanggal format: YYYY-MM-DD (contoh: 2024-01-01)
# 3. Debit: Uang masuk ke rekening bank
# 4. Kredit: Uang keluar dari rekening bank
# 5. Saldo: Saldo setelah transaksi (opsional, akan dihitung otomatis)
# 6. Hapus baris instruksi ini sebelum import
# 7. Simpan file dalam format CSV atau Excel
#
# CONTOH DATA:
${csvContent}`;
            
            const blob = new Blob([instructions], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Template_Mutasi_${bankName.replace(/[^a-zA-Z0-9]/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Template berhasil diunduh!\nFile: Template_Mutasi_${bankName.replace(/[^a-zA-Z0-9]/g, '_')}.csv\n\nSilakan isi data mutasi bank sesuai format yang disediakan.`);
        }

        function importBankStatement() {
            const fileInput = document.getElementById('bankStatementFile');
            const selectedBank = document.getElementById('reconciliationBankSelect').value;
            
            if (!selectedBank) {
                alert('Pilih akun bank terlebih dahulu');
                return;
            }
            
            if (!fileInput.files.length) {
                alert('Pilih file untuk diimport');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let data = [];
                    
                    if (file.name.endsWith('.csv')) {
                        data = parseCSV(content);
                    } else {
                        alert('Format file tidak didukung. Gunakan file CSV.');
                        return;
                    }
                    
                    processBankStatementData(data, selectedBank);
                } catch (error) {
                    alert('Error membaca file: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        function parseCSV(content) {
            const lines = content.split('\n').filter(line => line.trim() && !line.startsWith('#'));
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length >= 4) { // Minimum required columns
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }

        function processBankStatementData(data, bankCode) {
            const statements = [];
            
            data.forEach((row, index) => {
                const date = row['Tanggal'] || row['Date'];
                const description = row['Deskripsi'] || row['Description'] || row['Keterangan'];
                const reference = row['Referensi'] || row['Reference'] || row['Ref'] || `BANK${String(index + 1).padStart(3, '0')}`;
                const debit = parseFloat(row['Debit'] || 0);
                const credit = parseFloat(row['Kredit'] || row['Credit'] || 0);
                
                if (date && description && (debit > 0 || credit > 0)) {
                    statements.push({
                        id: Date.now() + index,
                        date: date,
                        description: description,
                        reference: reference,
                        debit: debit,
                        credit: credit,
                        amount: debit - credit,
                        matched: false,
                        bankCode: bankCode
                    });
                }
            });
            
            bankStatements = statements;
            displayBankStatements();
            loadBankTransactions();
            
            document.getElementById('bankStatementInfo').textContent = `${statements.length} transaksi berhasil diimport`;
            alert(`‚úÖ Berhasil import ${statements.length} transaksi mutasi bank!`);
        }

        function displayBankStatements() {
            const tbody = document.getElementById('bankStatementList');
            
            if (bankStatements.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td class="py-4 px-2 text-center text-gray-400" colspan="5">
                            Import file mutasi bank untuk memulai rekonsiliasi
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            bankStatements.forEach(statement => {
                const row = document.createElement('tr');
                row.className = `border-b border-gray-700 ${statement.matched ? 'bg-green-900/20' : 'hover:bg-dark-light/30'}`;
                row.innerHTML = `
                    <td class="py-2 px-2 text-center">
                        <input type="checkbox" ${statement.matched ? 'checked disabled' : ''} 
                               onchange="toggleBankStatementMatch(${statement.id})"
                               class="w-4 h-4 text-primary bg-dark border-gray-600 rounded">
                    </td>
                    <td class="py-2 px-2">${formatDate(statement.date)}</td>
                    <td class="py-2 px-2">${statement.description}</td>
                    <td class="py-2 px-2 text-right ${statement.amount >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${formatCurrency(Math.abs(statement.amount))}
                    </td>
                    <td class="py-2 px-2 text-center">
                        ${!statement.matched ? `
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="createTransactionFromBank(${statement.id})" 
                                        class="text-blue-400 hover:text-blue-300 text-xs px-2 py-1 bg-blue-900/20 rounded">
                                    Jurnal Cepat
                                </button>
                                <button onclick="openQuickCreateFromBank(${statement.id})" 
                                        class="text-green-400 hover:text-green-300 text-xs px-2 py-1 bg-green-900/20 rounded">
                                    + Catat
                                </button>
                            </div>
                        ` : `
                            <span class="text-green-400 text-xs">‚úì Matched</span>
                        `}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadBankTransactions() {
            const selectedBank = document.getElementById('reconciliationBankSelect').value;
            const startDate = document.getElementById('reconciliationStartDate').value;
            const endDate = document.getElementById('reconciliationEndDate').value;
            
            if (!selectedBank) {
                document.getElementById('bookTransactionsList').innerHTML = `
                    <tr>
                        <td class="py-4 px-2 text-center text-gray-400" colspan="4">
                            Pilih akun bank untuk melihat transaksi
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Get transactions for selected bank account
            let bankTransactions = [];
            transactions.forEach(transaction => {
                // Filter by date range
                if (startDate && transaction.date < startDate) return;
                if (endDate && transaction.date > endDate) return;
                
                transaction.entries.forEach(entry => {
                    if (entry.account === selectedBank) {
                        bankTransactions.push({
                            id: `${transaction.id}_${entry.account}`,
                            date: transaction.date,
                            description: transaction.desc,
                            reference: transaction.ref,
                            debit: entry.debit,
                            credit: entry.credit,
                            amount: entry.debit - entry.credit,
                            matched: false
                        });
                    }
                });
            });
            
            // Store for reconciliation
            reconciliationData.bookTransactions = bankTransactions;
            
            displayBookTransactions(bankTransactions);
            updateReconciliationSummary();
        }

        function displayBookTransactions(transactions) {
            const tbody = document.getElementById('bookTransactionsList');
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td class="py-4 px-2 text-center text-gray-400" colspan="4">
                            Tidak ada transaksi untuk periode yang dipilih
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = `border-b border-gray-700 ${transaction.matched ? 'bg-green-900/20' : 'hover:bg-dark-light/30'}`;
                row.innerHTML = `
                    <td class="py-2 px-2 text-center">
                        <input type="checkbox" ${transaction.matched ? 'checked disabled' : ''} 
                               onchange="toggleBookTransactionMatch('${transaction.id}')"
                               class="w-4 h-4 text-primary bg-dark border-gray-600 rounded">
                    </td>
                    <td class="py-2 px-2">${formatDate(transaction.date)}</td>
                    <td class="py-2 px-2">${transaction.description}</td>
                    <td class="py-2 px-2 text-right ${transaction.amount >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${formatCurrency(Math.abs(transaction.amount))}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateReconciliationSummary() {
            const selectedBank = document.getElementById('reconciliationBankSelect').value;
            if (!selectedBank) return;
            
            const bankAccount = accounts.find(acc => acc.code === selectedBank);
            const bookBalance = bankAccount ? bankAccount.balance : 0;
            
            const bankBalance = bankStatements.reduce((sum, stmt) => sum + stmt.amount, 0);
            const difference = bookBalance - bankBalance;
            
            document.getElementById('bookBalance').textContent = formatCurrency(bookBalance);
            document.getElementById('bankBalance').textContent = formatCurrency(bankBalance);
            document.getElementById('balanceDifference').textContent = formatCurrency(Math.abs(difference));
            
            const statusElement = document.getElementById('reconciliationStatus');
            if (Math.abs(difference) < 0.01) {
                statusElement.textContent = 'Seimbang ‚úì';
                statusElement.className = 'text-lg font-bold text-green-400';
            } else {
                statusElement.textContent = 'Belum Seimbang';
                statusElement.className = 'text-lg font-bold text-red-400';
            }
            
            document.getElementById('reconciliationSummary').classList.remove('hidden');
            document.getElementById('reconciliationActions').classList.remove('hidden');
        }

        function showManualTransactionForm() {
            const selectedBank = document.getElementById('reconciliationBankSelect').value;
            if (!selectedBank) {
                alert('Pilih akun bank terlebih dahulu');
                return;
            }
            
            document.getElementById('manualTransactionForm').classList.remove('hidden');
            document.getElementById('manualTransactionDate').value = new Date().toISOString().split('T')[0];
        }

        function hideManualTransactionForm() {
            document.getElementById('manualTransactionForm').classList.add('hidden');
            document.getElementById('manualTransactionForm').querySelector('form').reset();
        }

        function addManualTransaction(event) {
            event.preventDefault();
            
            const selectedBank = document.getElementById('reconciliationBankSelect').value;
            const date = document.getElementById('manualTransactionDate').value;
            const ref = document.getElementById('manualTransactionRef').value || `MAN${Date.now()}`;
            const desc = document.getElementById('manualTransactionDesc').value;
            const amount = parseFloat(document.getElementById('manualTransactionAmount').value);
            const type = document.getElementById('manualTransactionType').value;
            const counterAccount = document.getElementById('manualTransactionAccount').value;
            
            if (!selectedBank || !counterAccount) {
                alert('Pilih akun bank dan akun lawan');
                return;
            }
            
            // Create journal entries
            const entries = [];
            if (type === 'debit') {
                entries.push({account: selectedBank, debit: amount, credit: 0});
                entries.push({account: counterAccount, debit: 0, credit: amount});
            } else {
                entries.push({account: selectedBank, debit: 0, credit: amount});
                entries.push({account: counterAccount, debit: amount, credit: 0});
            }
            
            const transaction = {
                id: Date.now(),
                date,
                ref,
                desc,
                entries
            };
            
            transactions.push(transaction);
            updateAccountBalances(entries);
            updateTransactionList();
            updateDashboard();
            loadBankTransactions();
            hideManualTransactionForm();
            
            alert('Transaksi manual berhasil ditambahkan!');
        }

        function createTransactionFromBank(statementId) {
            const statement = bankStatements.find(s => s.id === statementId);
            if (!statement) return;
            
            // Pre-fill manual transaction form (opsi cepat)
            document.getElementById('manualTransactionDate').value = statement.date;
            document.getElementById('manualTransactionRef').value = statement.reference;
            document.getElementById('manualTransactionDesc').value = `${statement.description} (dari mutasi bank)`;
            document.getElementById('manualTransactionAmount').value = Math.abs(statement.amount);
            document.getElementById('manualTransactionType').value = statement.amount >= 0 ? 'debit' : 'credit';
            
            showManualTransactionForm();
        }

        // Quick Create From Bank Modal controls
        let qcbActiveStatementId = null;
        function openQuickCreateFromBank(statementId) {
            const statement = bankStatements.find(s => s.id === statementId);
            if (!statement) return;
            qcbActiveStatementId = statementId;

            const modal = document.getElementById('quickCreateFromBank');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Fill fields
            document.getElementById('qcbDate').value = statement.date;
            document.getElementById('qcbRef').value = statement.reference || `BANK${Date.now()}`;
            document.getElementById('qcbAmount').value = Math.abs(statement.amount);
            document.getElementById('qcbDesc').value = statement.description;
            document.getElementById('qcbType').value = statement.amount >= 0 ? 'debit' : 'credit';

            // Populate selects
            const bankSel = document.getElementById('qcbBank');
            const counterSel = document.getElementById('qcbCounter');
            bankSel.innerHTML = '';
            counterSel.innerHTML = '<option value="">Pilih Akun</option>';

            // Bank only: akun yang mengandung "bank" atau kode 12xx
            accounts.filter(a => a.name.toLowerCase().includes('bank') || a.code.startsWith('12')).forEach(acc => {
                const opt = document.createElement('option');
                opt.value = acc.code;
                opt.textContent = `${acc.code} - ${acc.name}`;
                bankSel.appendChild(opt);
            });

            // Semua akun sebagai akun lawan
            accounts.forEach(acc => {
                const opt = document.createElement('option');
                opt.value = acc.code;
                opt.textContent = `${acc.code} - ${acc.name}`;
                counterSel.appendChild(opt);
            });

            // Preselect bank dari filter rekonsiliasi jika ada
            const selectedBank = document.getElementById('reconciliationBankSelect').value;
            if (selectedBank) bankSel.value = selectedBank;
        }
        function closeQuickCreateFromBank() {
            const modal = document.getElementById('quickCreateFromBank');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            qcbActiveStatementId = null;
        }
        function toggleQcbAdvanced() {
            const adv = document.getElementById('qcbAdvanced');
            adv.classList.toggle('hidden');
        }
        function saveQcbAsDraft() {
            if (!qcbActiveStatementId) return;
            const statement = bankStatements.find(s => s.id === qcbActiveStatementId);
            if (!statement) return;
            statement.matched = false;
            alert('Draft disimpan. Anda bisa lanjutkan nanti dari daftar mutasi.');
            closeQuickCreateFromBank();
        }
        function createJournalFromQcb() {
            const date = document.getElementById('qcbDate').value;
            const ref = document.getElementById('qcbRef').value || `BANK${Date.now()}`;
            const desc = document.getElementById('qcbDesc').value || 'Transaksi dari mutasi bank';
            const type = document.getElementById('qcbType').value;
            const bankCode = document.getElementById('qcbBank').value;
            const counterCode = document.getElementById('qcbManualCode').value || document.getElementById('qcbCounter').value;
            const amount = parseFloat(document.getElementById('qcbManualAmount').value) || parseFloat(document.getElementById('qcbAmount').value) || 0;

            if (!date || !bankCode || !counterCode || amount <= 0) {
                alert('Lengkapi tanggal, akun bank, akun lawan, dan jumlah yang valid.');
                return;
            }

            const entries = [];
            if (type === 'debit') {
                entries.push({ account: bankCode, debit: amount, credit: 0 });
                entries.push({ account: counterCode, debit: 0, credit: amount });
            } else {
                entries.push({ account: bankCode, debit: 0, credit: amount });
                entries.push({ account: counterCode, debit: amount, credit: 0 });
            }

            const transaction = { id: Date.now(), date, ref, desc: `${desc} (dari mutasi bank)`, entries };
            transactions.push(transaction);
            updateAccountBalances(entries);
            updateTransactionList();
            updateDashboard();
            loadBankTransactions();
            saveDataToLocalStorage();

            // Tandai sebagai matched agar tidak dobel
            if (qcbActiveStatementId) {
                const stmt = bankStatements.find(s => s.id === qcbActiveStatementId);
                if (stmt) stmt.matched = true;
            }
            displayBankStatements();
            updateReconciliationSummary();
            alert('‚úÖ Jurnal berhasil dibuat dari mutasi bank!');
            closeQuickCreateFromBank();
        }

        function toggleBankStatementMatch(statementId) {
            const statement = bankStatements.find(s => s.id === statementId);
            if (statement) {
                statement.matched = !statement.matched;
                displayBankStatements();
                updateReconciliationSummary();
            }
        }

        function toggleBookTransactionMatch(transactionId) {
            if (reconciliationData.bookTransactions) {
                const transaction = reconciliationData.bookTransactions.find(t => t.id === transactionId);
                if (transaction) {
                    transaction.matched = !transaction.matched;
                    displayBookTransactions(reconciliationData.bookTransactions);
                    updateReconciliationSummary();
                }
            }
        }

        function autoMatchTransactions() {
            if (!reconciliationData.bookTransactions || bankStatements.length === 0) {
                alert('Tidak ada data untuk di-match');
                return;
            }
            
            let matchCount = 0;
            
            // Simple matching by amount and date (within 3 days)
            reconciliationData.bookTransactions.forEach(bookTx => {
                if (bookTx.matched) return;
                
                const matchingStatement = bankStatements.find(bankTx => {
                    if (bankTx.matched) return false;
                    
                    const amountMatch = Math.abs(bookTx.amount - bankTx.amount) < 0.01;
                    const dateMatch = Math.abs(new Date(bookTx.date) - new Date(bankTx.date)) <= 3 * 24 * 60 * 60 * 1000; // 3 days
                    
                    return amountMatch && dateMatch;
                });
                
                if (matchingStatement) {
                    bookTx.matched = true;
                    matchingStatement.matched = true;
                    matchCount++;
                }
            });
            
            displayBookTransactions(reconciliationData.bookTransactions);
            displayBankStatements();
            updateReconciliationSummary();
            
            alert(`‚úÖ Auto match selesai!\n${matchCount} transaksi berhasil di-match.`);
        }

        function completeReconciliation() {
            const selectedBank = document.getElementById('reconciliationBankSelect').value;
            const startDate = document.getElementById('reconciliationStartDate').value;
            const endDate = document.getElementById('reconciliationEndDate').value;
            
            if (!selectedBank) {
                alert('Pilih akun bank terlebih dahulu');
                return;
            }
            
            const bankAccount = accounts.find(acc => acc.code === selectedBank);
            const bookBalance = bankAccount ? bankAccount.balance : 0;
            const bankBalance = bankStatements.reduce((sum, stmt) => sum + stmt.amount, 0);
            const difference = Math.abs(bookBalance - bankBalance);
            
            if (difference > 0.01) {
                const proceed = confirm(`Masih ada selisih sebesar ${formatCurrency(difference)}.\nApakah Anda yakin ingin menyelesaikan rekonsiliasi?`);
                if (!proceed) return;
            }
            
            // Save reconciliation record
            const reconciliationRecord = {
                id: Date.now(),
                bankCode: selectedBank,
                bankName: bankAccount ? bankAccount.name : selectedBank,
                startDate: startDate,
                endDate: endDate,
                bookBalance: bookBalance,
                bankBalance: bankBalance,
                difference: bookBalance - bankBalance,
                completedDate: new Date().toISOString().split('T')[0],
                bookTransactions: reconciliationData.bookTransactions ? reconciliationData.bookTransactions.length : 0,
                bankTransactions: bankStatements.length,
                matchedTransactions: bankStatements.filter(s => s.matched).length
            };
            
            // Store in localStorage for history
            const reconciliationHistory = JSON.parse(localStorage.getItem('reconciliationHistory') || '[]');
            reconciliationHistory.push(reconciliationRecord);
            localStorage.setItem('reconciliationHistory', JSON.stringify(reconciliationHistory));
            
            alert(`‚úÖ Rekonsiliasi bank berhasil diselesaikan!\n\nRingkasan:\n- Saldo Buku: ${formatCurrency(bookBalance)}\n- Saldo Bank: ${formatCurrency(bankBalance)}\n- Selisih: ${formatCurrency(Math.abs(bookBalance - bankBalance))}\n- Transaksi Matched: ${bankStatements.filter(s => s.matched).length}/${bankStatements.length}`);
        }

        function exportReconciliation() {
            const selectedBank = document.getElementById('reconciliationBankSelect').value;
            if (!selectedBank || (!reconciliationData.bookTransactions && bankStatements.length === 0)) {
                alert('Tidak ada data untuk diekspor');
                return;
            }
            
            const bankAccount = accounts.find(acc => acc.code === selectedBank);
            const bankName = bankAccount ? bankAccount.name : selectedBank;
            
            // Prepare export data
            let csvContent = 'LAPORAN REKONSILIASI BANK\n';
            csvContent += `Bank: ${bankName}\n`;
            csvContent += `Tanggal: ${new Date().toLocaleDateString('id-ID')}\n\n`;
            
            // Summary
            const bookBalance = bankAccount ? bankAccount.balance : 0;
            const bankBalance = bankStatements.reduce((sum, stmt) => sum + stmt.amount, 0);
            csvContent += 'RINGKASAN\n';
            csvContent += `Saldo Buku,${bookBalance}\n`;
            csvContent += `Saldo Bank,${bankBalance}\n`;
            csvContent += `Selisih,${bookBalance - bankBalance}\n\n`;
            
            // Book transactions
            csvContent += 'TRANSAKSI BUKU\n';
            csvContent += 'Tanggal,Deskripsi,Referensi,Jumlah,Status\n';
            if (reconciliationData.bookTransactions) {
                reconciliationData.bookTransactions.forEach(tx => {
                    csvContent += `${tx.date},"${tx.description}",${tx.reference},${tx.amount},${tx.matched ? 'Matched' : 'Unmatched'}\n`;
                });
            }
            
            csvContent += '\nMUTASI BANK\n';
            csvContent += 'Tanggal,Deskripsi,Referensi,Jumlah,Status\n';
            bankStatements.forEach(stmt => {
                csvContent += `${stmt.date},"${stmt.description}",${stmt.reference},${stmt.amount},${stmt.matched ? 'Matched' : 'Unmatched'}\n`;
            });
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            const today = new Date().toISOString().split('T')[0];
            const filename = `Rekonsiliasi_${bankName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.csv`;
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Laporan rekonsiliasi berhasil diekspor!\nFile: ${filename}`);
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Data Management Functions
        function updateDataStatistics() {
            document.getElementById('transactionCount').textContent = transactions.length;
            document.getElementById('accountCount').textContent = accounts.length;
            document.getElementById('assetCount').textContent = assets.length;
            
            document.getElementById('totalTransactionsStat').textContent = transactions.length;
            document.getElementById('totalAccountsStat').textContent = accounts.length;
            document.getElementById('totalAssetsStat').textContent = assets.length;
            
            // Calculate data size
            const allData = {
                transactions,
                accounts,
                assets,
                bankStatements,
                companySettings: JSON.parse(localStorage.getItem('companySettings') || '{}'),
                reconciliationHistory: JSON.parse(localStorage.getItem('reconciliationHistory') || '[]')
            };
            
            const dataSize = new Blob([JSON.stringify(allData)]).size;
            document.getElementById('dataSize').textContent = formatBytes(dataSize);
            
            // Update last backup info
            const lastBackup = localStorage.getItem('lastBackupDate');
            if (lastBackup) {
                document.getElementById('lastBackupInfo').textContent = `Backup terakhir: ${new Date(lastBackup).toLocaleString('id-ID')}`;
            } else {
                document.getElementById('lastBackupInfo').textContent = 'Belum pernah backup';
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function createBackup() {
            const backupData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                companyInfo: JSON.parse(localStorage.getItem('companySettings') || '{}'),
                data: {}
            };
            
            // Check what to backup
            if (document.getElementById('backupTransactions').checked) {
                backupData.data.transactions = transactions;
            }
            
            if (document.getElementById('backupAccounts').checked) {
                backupData.data.accounts = accounts;
            }
            
            if (document.getElementById('backupAssets').checked) {
                backupData.data.assets = assets;
            }
            
            if (document.getElementById('backupSettings').checked) {
                backupData.data.companySettings = JSON.parse(localStorage.getItem('companySettings') || '{}');
            }
            
            if (document.getElementById('backupReconciliation').checked) {
                backupData.data.reconciliationHistory = JSON.parse(localStorage.getItem('reconciliationHistory') || '[]');
                backupData.data.bankStatements = bankStatements;
            }
            
            // Create filename with timestamp
            const now = new Date();
            const timestamp = now.toISOString().split('T')[0] + '_' + 
                            now.toTimeString().split(' ')[0].replace(/:/g, '-');
            const companyName = backupData.companyInfo.name || 'FinanceFlow';
            const filename = `${companyName.replace(/[^a-zA-Z0-9]/g, '_')}_Backup_${timestamp}.json`;
            
            // Download backup file
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Save backup info
            localStorage.setItem('lastBackupDate', now.toISOString());
            updateDataStatistics();
            
            // Show success message
            const itemCount = Object.keys(backupData.data).length;
            const dataSize = formatBytes(blob.size);
            
            alert(`‚úÖ Backup berhasil dibuat!\n\nFile: ${filename}\nUkuran: ${dataSize}\nKategori data: ${itemCount}\n\nFile telah diunduh ke folder Downloads Anda.`);
        }

        function createAutoBackup() {
            // Set all checkboxes to true for complete backup
            document.getElementById('backupTransactions').checked = true;
            document.getElementById('backupAccounts').checked = true;
            document.getElementById('backupAssets').checked = true;
            document.getElementById('backupSettings').checked = true;
            document.getElementById('backupReconciliation').checked = true;
            
            createBackup();
        }

        function restoreData() {
            const fileInput = document.getElementById('restoreFile');
            const restoreMode = document.querySelector('input[name="restoreMode"]:checked').value;
            
            if (!fileInput.files.length) {
                alert('Pilih file backup terlebih dahulu');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file type
            if (!file.name.endsWith('.json') && !file.name.endsWith('.bak')) {
                alert('Format file tidak valid. Gunakan file .json atau .bak');
                return;
            }
            
            // Confirm restore action
            const confirmMessage = restoreMode === 'replace' 
                ? '‚ö†Ô∏è PERINGATAN: Semua data existing akan dihapus dan diganti dengan data dari backup.\n\nApakah Anda yakin ingin melanjutkan?'
                : 'Data dari backup akan digabung dengan data existing.\n\nApakah Anda yakin ingin melanjutkan?';
                
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validate backup file structure
                    if (!backupData.version || !backupData.data) {
                        throw new Error('Format file backup tidak valid');
                    }
                    
                    processRestore(backupData, restoreMode);
                    
                } catch (error) {
                    alert(`‚ùå Error membaca file backup:\n${error.message}\n\nPastikan file backup valid dan tidak corrupt.`);
                }
            };
            
            reader.readAsText(file);
        }

        function processRestore(backupData, mode) {
            let restoredItems = [];
            
            try {
                // Backup current data if replacing
                if (mode === 'replace') {
                    const currentBackup = {
                        transactions: [...transactions],
                        accounts: [...accounts],
                        assets: [...assets],
                        bankStatements: [...bankStatements]
                    };
                    sessionStorage.setItem('preRestoreBackup', JSON.stringify(currentBackup));
                }
                
                // Restore transactions
                if (backupData.data.transactions) {
                    if (mode === 'replace') {
                        transactions.length = 0;
                    }
                    
                    backupData.data.transactions.forEach(transaction => {
                        if (mode === 'merge') {
                            // Check if transaction already exists
                            const exists = transactions.some(t => t.id === transaction.id);
                            if (!exists) {
                                transactions.push(transaction);
                            }
                        } else {
                            transactions.push(transaction);
                        }
                    });
                    
                    restoredItems.push(`${backupData.data.transactions.length} transaksi`);
                }
                
                // Restore accounts
                if (backupData.data.accounts) {
                    if (mode === 'replace') {
                        accounts.length = 0;
                    }
                    
                    backupData.data.accounts.forEach(account => {
                        if (mode === 'merge') {
                            const existingIndex = accounts.findIndex(a => a.code === account.code);
                            if (existingIndex >= 0) {
                                accounts[existingIndex] = account; // Update existing
                            } else {
                                accounts.push(account); // Add new
                            }
                        } else {
                            accounts.push(account);
                        }
                    });
                    
                    restoredItems.push(`${backupData.data.accounts.length} akun`);
                }
                
                // Restore assets
                if (backupData.data.assets) {
                    if (mode === 'replace') {
                        assets.length = 0;
                    }
                    
                    backupData.data.assets.forEach(asset => {
                        if (mode === 'merge') {
                            const exists = assets.some(a => a.id === asset.id);
                            if (!exists) {
                                assets.push(asset);
                            }
                        } else {
                            assets.push(asset);
                        }
                    });
                    
                    restoredItems.push(`${backupData.data.assets.length} aset`);
                }
                
                // Restore company settings
                if (backupData.data.companySettings) {
                    if (mode === 'replace' || !localStorage.getItem('companySettings')) {
                        localStorage.setItem('companySettings', JSON.stringify(backupData.data.companySettings));
                        loadCompanySettings();
                        restoredItems.push('pengaturan perusahaan');
                    }
                }
                
                // Restore reconciliation data
                if (backupData.data.reconciliationHistory) {
                    const currentHistory = JSON.parse(localStorage.getItem('reconciliationHistory') || '[]');
                    
                    if (mode === 'replace') {
                        localStorage.setItem('reconciliationHistory', JSON.stringify(backupData.data.reconciliationHistory));
                    } else {
                        // Merge reconciliation history
                        const mergedHistory = [...currentHistory];
                        backupData.data.reconciliationHistory.forEach(record => {
                            const exists = mergedHistory.some(r => r.id === record.id);
                            if (!exists) {
                                mergedHistory.push(record);
                            }
                        });
                        localStorage.setItem('reconciliationHistory', JSON.stringify(mergedHistory));
                    }
                    
                    restoredItems.push('riwayat rekonsiliasi');
                }
                
                if (backupData.data.bankStatements) {
                    if (mode === 'replace') {
                        bankStatements.length = 0;
                    }
                    
                    backupData.data.bankStatements.forEach(statement => {
                        if (mode === 'merge') {
                            const exists = bankStatements.some(s => s.id === statement.id);
                            if (!exists) {
                                bankStatements.push(statement);
                            }
                        } else {
                            bankStatements.push(statement);
                        }
                    });
                }
                
                // Update all UI components
                updateAccountList();
                updateAccountSelects();
                updateTransactionList();
                updateAssetList();
                updateDashboard();
                updateDataStatistics();
                
                // Clear file input
                document.getElementById('restoreFile').value = '';
                
                // Show success message
                const backupDate = new Date(backupData.timestamp).toLocaleString('id-ID');
                const companyName = backupData.companyInfo.name || 'Unknown';
                
                alert(`‚úÖ Restore berhasil!\n\nData yang dipulihkan:\n- ${restoredItems.join('\n- ')}\n\nSumber backup:\n- Perusahaan: ${companyName}\n- Tanggal: ${backupDate}\n- Mode: ${mode === 'replace' ? 'Replace' : 'Merge'}\n\nSemua data telah diperbarui.`);
                
            } catch (error) {
                alert(`‚ùå Error saat restore:\n${error.message}\n\nRestore dibatalkan.`);
                
                // Restore from session backup if replace mode failed
                if (mode === 'replace') {
                    const preRestoreBackup = sessionStorage.getItem('preRestoreBackup');
                    if (preRestoreBackup) {
                        const backup = JSON.parse(preRestoreBackup);
                        transactions.length = 0;
                        accounts.length = 0;
                        assets.length = 0;
                        bankStatements.length = 0;
                        
                        transactions.push(...backup.transactions);
                        accounts.push(...backup.accounts);
                        assets.push(...backup.assets);
                        bankStatements.push(...backup.bankStatements);
                        
                        updateAccountList();
                        updateAccountSelects();
                        updateTransactionList();
                        updateAssetList();
                        updateDashboard();
                    }
                }
            } finally {
                // Clean up session backup
                sessionStorage.removeItem('preRestoreBackup');
            }
        }

        function validateBackupFile(backupData) {
            const requiredFields = ['version', 'timestamp', 'data'];
            
            for (const field of requiredFields) {
                if (!backupData.hasOwnProperty(field)) {
                    throw new Error(`Field '${field}' tidak ditemukan dalam file backup`);
                }
            }
            
            // Validate data structure
            if (backupData.data.transactions && !Array.isArray(backupData.data.transactions)) {
                throw new Error('Format data transaksi tidak valid');
            }
            
            if (backupData.data.accounts && !Array.isArray(backupData.data.accounts)) {
                throw new Error('Format data akun tidak valid');
            }
            
            if (backupData.data.assets && !Array.isArray(backupData.data.assets)) {
                throw new Error('Format data aset tidak valid');
            }
            
            return true;
        }

        // Enhanced data persistence
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('financeflow_transactions', JSON.stringify(transactions));
                localStorage.setItem('financeflow_accounts', JSON.stringify(accounts));
                localStorage.setItem('financeflow_assets', JSON.stringify(assets));
                localStorage.setItem('financeflow_bankStatements', JSON.stringify(bankStatements));
                localStorage.setItem('financeflow_lastSave', new Date().toISOString());
            } catch (error) {
                console.warn('Failed to save data to localStorage:', error);
            }
        }

        function loadDataFromLocalStorage() {
            try {
                const savedTransactions = localStorage.getItem('financeflow_transactions');
                const savedAccounts = localStorage.getItem('financeflow_accounts');
                const savedAssets = localStorage.getItem('financeflow_assets');
                const savedBankStatements = localStorage.getItem('financeflow_bankStatements');
                
                if (savedTransactions) {
                    transactions.push(...JSON.parse(savedTransactions));
                }
                
                if (savedAccounts) {
                    const loadedAccounts = JSON.parse(savedAccounts);
                    // Merge with default accounts, prioritizing saved data
                    const defaultCodes = accounts.map(acc => acc.code);
                    loadedAccounts.forEach(acc => {
                        const existingIndex = accounts.findIndex(a => a.code === acc.code);
                        if (existingIndex >= 0) {
                            accounts[existingIndex] = acc;
                        } else {
                            accounts.push(acc);
                        }
                    });
                }
                
                if (savedAssets) {
                    assets.push(...JSON.parse(savedAssets));
                }
                
                if (savedBankStatements) {
                    bankStatements.push(...JSON.parse(savedBankStatements));
                }
                
            } catch (error) {
                console.warn('Failed to load data from localStorage:', error);
            }
        }

        // Auto-save functionality
        function enableAutoSave() {
            // Save data every 30 seconds
            setInterval(saveDataToLocalStorage, 30000);
            
            // Save on page unload
            window.addEventListener('beforeunload', saveDataToLocalStorage);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeDefaultAccounts();
            loadDataFromLocalStorage(); // Load saved data first
            attachAmountListeners();
            updateDashboard();
            loadCompanySettings();
            loadTaxSettings(); // Load tax settings
            updateTaxAccountSelects(); // Update tax account dropdowns
            updateDataStatistics();
            enableAutoSave();
            
            // Set default date if not loaded from settings
            const today = new Date().toISOString().split('T')[0];
            if (!document.getElementById('periodStart').value) {
                document.getElementById('periodStart').value = today;
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97168f60c4d4a6d7',t:'MTc1NTU3NDA5OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
        .role-admin { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .role-user { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .role-viewer { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white">
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="glass-effect p-8 rounded-2xl w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-primary to-secondary rounded-xl flex items-center justify-center mx-auto mb-4">
                    <span class="text-white font-bold text-2xl">‚Çπ</span>
                </div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent mb-2">
                    FinanceFlow Pro
                </h1>
                <p class="text-gray-400">Sistem Akuntansi Bisnis</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" id="loginUsername" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                </div>
                <button type="submit" class="w-full py-3 bg-gradient-to-r from-primary to-secondary rounded-lg font-semibold hover:shadow-lg transition-all">
                    Masuk
                </button>
            </form>
            
            <div class="mt-6 p-4 bg-white/5 rounded-lg">
                <h4 class="text-sm font-semibold mb-2">Akun Demo:</h4>
                <div class="text-xs space-y-1 text-gray-400">
                    <div><strong>Admin:</strong> admin / admin123</div>
                    <div><strong>User:</strong> user / user123</div>
                    <div><strong>Viewer:</strong> viewer / viewer123</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
    <!-- Navigation -->
    <nav class="glass-effect p-4 mb-4 md:mb-8">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2 md:space-x-3">
                    <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-lg md:text-xl">‚Çπ</span>
                    </div>
                    <h1 class="text-lg md:text-2xl font-bold bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">
                        FinanceFlow Pro
                    </h1>
                </div>
                <div class="hidden md:flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm font-medium" id="currentUserName">Admin</div>
                        <div class="text-xs text-gray-400">
                            <span id="currentUserRole" class="role-badge role-admin">Admin</span>
                        </div>
                    </div>
                    <button onclick="logout()" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
                <button onclick="toggleMobileMenu()" class="md:hidden p-2 rounded-lg hover:bg-white/10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Desktop Navigation -->
            <div class="hidden md:flex space-x-6 mt-4">
                <button onclick="showSection('dashboard')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/10 transition-all active">Dashboard</button>
                <button onclick="showSection('transactions')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/10 transition-all">Transaksi</button>
                <button onclick="showSection('assets')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/10 transition-all">Aset</button>
                <button onclick="showSection('reports')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/10 transition-all">Laporan</button>
                <button onclick="showSection('settings')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/10 transition-all">Pengaturan</button>
            </div>
            
            <!-- Mobile Navigation -->
            <div id="mobileMenu" class="md:hidden mt-4 space-y-2 hidden">
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg mb-4">
                    <div>
                        <div class="text-sm font-medium" id="mobileUserName">Admin</div>
                        <div class="text-xs text-gray-400">
                            <span id="mobileUserRole" class="role-badge role-admin">Admin</span>
                        </div>
                    </div>
                    <button onclick="logout()" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
                <button onclick="showSection('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 transition-all active">Dashboard</button>
                <button onclick="showSection('transactions')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 transition-all">Transaksi</button>
                <button onclick="showSection('assets')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 transition-all">Aset</button>
                <button onclick="showSection('reports')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 transition-all">Laporan</button>
                <button onclick="showSection('settings')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 transition-all">Pengaturan</button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-2 sm:px-4">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
                <!-- Summary Cards -->
                <div class="glass-effect p-6 rounded-xl card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Total Aset</p>
                            <p class="text-2xl font-bold text-green-400" id="totalAssets">Rp 0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                            <span class="text-green-400 text-xl">üìä</span>
                        </div>
                    </div>
                </div>

                <div class="glass-effect p-6 rounded-xl card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Total Liabilitas</p>
                            <p class="text-2xl font-bold text-red-400" id="totalLiabilities">Rp 0</p>
                        </div>
                        <div class="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center">
                            <span class="text-red-400 text-xl">üìâ</span>
                        </div>
                    </div>
                </div>

                <div class="glass-effect p-6 rounded-xl card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Modal</p>
                            <p class="text-2xl font-bold text-blue-400" id="totalEquity">Rp 0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                            <span class="text-blue-400 text-xl">üí∞</span>
                        </div>
                    </div>
                </div>

                <div class="glass-effect p-6 rounded-xl card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Laba Bulan Ini</p>
                            <p class="text-2xl font-bold text-purple-400" id="monthlyProfit">Rp 0</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                            <span class="text-purple-400 text-xl">üìà</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="glass-effect p-4 md:p-6 rounded-xl mb-6 md:mb-8">
                <h3 class="text-lg md:text-xl font-semibold mb-4">Transaksi Terbaru</h3>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[600px]">
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="text-left py-2 md:py-3 text-gray-300 text-sm md:text-base">Tanggal</th>
                                <th class="text-left py-2 md:py-3 text-gray-300 text-sm md:text-base">Deskripsi</th>
                                <th class="text-left py-2 md:py-3 text-gray-300 text-sm md:text-base">Akun</th>
                                <th class="text-right py-2 md:py-3 text-gray-300 text-sm md:text-base">Debit</th>
                                <th class="text-right py-2 md:py-3 text-gray-300 text-sm md:text-base">Kredit</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactions">
                            <tr class="border-b border-gray-700">
                                <td class="py-2 md:py-3 text-gray-300 text-sm md:text-base">Belum ada transaksi</td>
                                <td class="py-2 md:py-3"></td>
                                <td class="py-2 md:py-3"></td>
                                <td class="py-2 md:py-3"></td>
                                <td class="py-2 md:py-3"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div id="transactions" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Pencatatan Transaksi</h2>
                <button onclick="showTransactionForm()" class="bg-gradient-to-r from-primary to-secondary px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                    + Tambah Transaksi
                </button>
            </div>

            <!-- Transaction Form -->
            <div id="transactionForm" class="glass-effect p-4 md:p-6 rounded-xl mb-6 md:mb-8 hidden">
                <h3 class="text-lg md:text-xl font-semibold mb-4">Form Transaksi Baru</h3>
                <form onsubmit="addTransaction(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Tanggal</label>
                        <input type="date" id="transactionDate" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Nomor Referensi</label>
                        <input type="text" id="transactionRef" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" placeholder="REF-001">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-2">Deskripsi</label>
                        <input type="text" id="transactionDesc" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" placeholder="Deskripsi transaksi" required>
                    </div>
                    
                    <div id="journalEntries">
                        <div class="journal-entry grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-4 bg-white/5 rounded-lg">
                            <div class="sm:col-span-2 lg:col-span-1">
                                <label class="block text-sm font-medium mb-2">Akun</label>
                                <select class="account-select w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                                    <option value="">Pilih Akun</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Debit</label>
                                <input type="number" class="debit-amount w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" placeholder="0" min="0" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Kredit</label>
                                <input type="number" class="credit-amount w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" placeholder="0" min="0" step="0.01">
                            </div>
                            <div class="flex items-end">
                                <button type="button" onclick="removeJournalEntry(this)" class="w-full p-3 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-all text-sm">Hapus</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                        <button type="button" onclick="addJournalEntry()" class="px-4 py-2 bg-accent/20 text-accent rounded-lg hover:bg-accent/30 transition-all text-sm">+ Tambah Baris</button>
                        <button type="submit" class="px-6 py-2 bg-gradient-to-r from-primary to-secondary rounded-lg font-semibold hover:shadow-lg transition-all text-sm">Simpan Transaksi</button>
                        <button type="button" onclick="hideTransactionForm()" class="px-6 py-2 bg-gray-600 rounded-lg hover:bg-gray-700 transition-all text-sm">Batal</button>
                    </div>
                </form>
            </div>

            <!-- Transaction List -->
            <div class="glass-effect p-4 md:p-6 rounded-xl">
                <h3 class="text-lg md:text-xl font-semibold mb-4">Daftar Transaksi</h3>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[700px]">
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="text-left py-2 md:py-3 text-gray-300 text-sm md:text-base">Tanggal</th>
                                <th class="text-left py-2 md:py-3 text-gray-300 text-sm md:text-base">Ref</th>
                                <th class="text-left py-2 md:py-3 text-gray-300 text-sm md:text-base">Deskripsi</th>
                                <th class="text-right py-2 md:py-3 text-gray-300 text-sm md:text-base">Total</th>
                                <th class="text-center py-2 md:py-3 text-gray-300 text-sm md:text-base">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="transactionList">
                            <tr class="border-b border-gray-700">
                                <td class="py-2 md:py-3 text-gray-300 text-sm md:text-base" colspan="5">Belum ada transaksi</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Assets Section -->
        <div id="assets" class="section hidden">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 space-y-4 sm:space-y-0">
                <h2 class="text-2xl md:text-3xl font-bold">Manajemen Aset</h2>
                <button onclick="showAssetForm()" class="bg-gradient-to-r from-primary to-secondary px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold hover:shadow-lg transition-all text-sm md:text-base">
                    + Tambah Aset
                </button>
            </div>

            <!-- Asset Form -->
            <div id="assetForm" class="glass-effect p-4 md:p-6 rounded-xl mb-6 md:mb-8 hidden">
                <h3 class="text-xl font-semibold mb-4">Form Aset Baru</h3>
                <form onsubmit="addAsset(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Nama Aset</label>
                        <input type="text" id="assetName" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Kategori</label>
                        <select id="assetCategory" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                            <option value="">Pilih Kategori</option>
                            <option value="building">Bangunan</option>
                            <option value="equipment">Peralatan</option>
                            <option value="vehicle">Kendaraan</option>
                            <option value="furniture">Furniture</option>
                            <option value="computer">Komputer & IT</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Harga Perolehan</label>
                        <input type="number" id="assetCost" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required min="0" step="0.01">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tanggal Perolehan</label>
                        <input type="date" id="assetDate" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Umur Ekonomis (Tahun)</label>
                        <input type="number" id="assetLife" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required min="1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Nilai Residu</label>
                        <input type="number" id="assetResidual" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" min="0" step="0.01" value="0">
                    </div>
                    <div class="md:col-span-2 flex space-x-4">
                        <button type="submit" class="px-6 py-2 bg-gradient-to-r from-primary to-secondary rounded-lg font-semibold hover:shadow-lg transition-all">Simpan Aset</button>
                        <button type="button" onclick="hideAssetForm()" class="px-6 py-2 bg-gray-600 rounded-lg hover:bg-gray-700 transition-all">Batal</button>
                    </div>
                </form>
            </div>

            <!-- Asset List -->
            <div class="glass-effect p-4 md:p-6 rounded-xl">
                <h3 class="text-lg md:text-xl font-semibold mb-4">Daftar Aset</h3>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[800px]">
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="text-left py-2 md:py-3 text-gray-300 text-sm md:text-base">Nama Aset</th>
                                <th class="text-left py-2 md:py-3 text-gray-300 text-sm md:text-base">Kategori</th>
                                <th class="text-right py-2 md:py-3 text-gray-300 text-sm md:text-base">Harga Perolehan</th>
                                <th class="text-right py-2 md:py-3 text-gray-300 text-sm md:text-base">Akumulasi Penyusutan</th>
                                <th class="text-right py-2 md:py-3 text-gray-300 text-sm md:text-base">Nilai Buku</th>
                                <th class="text-center py-2 md:py-3 text-gray-300 text-sm md:text-base">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="assetList">
                            <tr class="border-b border-gray-700">
                                <td class="py-2 md:py-3 text-gray-300 text-sm md:text-base" colspan="6">Belum ada aset</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="section hidden">
            <h2 class="text-2xl md:text-3xl font-bold mb-6">Laporan Keuangan</h2>
            
            <!-- Report Period Filter -->
            <div class="glass-effect p-4 md:p-6 rounded-xl mb-6">
                <h3 class="text-lg font-semibold mb-4">Filter Periode Laporan</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Tanggal Mulai</label>
                        <input type="date" id="reportStartDate" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tanggal Akhir</label>
                        <input type="date" id="reportEndDate" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none">
                    </div>
                    <div class="flex items-end">
                        <button onclick="clearReportDates()" class="w-full px-4 py-3 bg-gray-600/20 text-gray-300 rounded-lg hover:bg-gray-600/30 transition-all">Reset Filter</button>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8">
                <button onclick="generateReport('balance-sheet')" class="glass-effect p-6 rounded-xl card-hover text-left">
                    <h3 class="text-xl font-semibold mb-2">Neraca</h3>
                    <p class="text-gray-300">Laporan posisi keuangan perusahaan</p>
                </button>
                <button onclick="generateReport('income-statement')" class="glass-effect p-6 rounded-xl card-hover text-left">
                    <h3 class="text-xl font-semibold mb-2">Laba Rugi</h3>
                    <p class="text-gray-300">Laporan pendapatan dan beban</p>
                </button>
                <button onclick="generateReport('cash-flow')" class="glass-effect p-6 rounded-xl card-hover text-left">
                    <h3 class="text-xl font-semibold mb-2">Arus Kas</h3>
                    <p class="text-gray-300">Laporan pergerakan kas</p>
                </button>
                <button onclick="generateReport('trial-balance')" class="glass-effect p-6 rounded-xl card-hover text-left">
                    <h3 class="text-xl font-semibold mb-2">Neraca Saldo</h3>
                    <p class="text-gray-300">Daftar saldo semua akun</p>
                </button>
                <button onclick="generateReport('general-ledger')" class="glass-effect p-6 rounded-xl card-hover text-left">
                    <h3 class="text-xl font-semibold mb-2">Buku Besar</h3>
                    <p class="text-gray-300">Detail transaksi per akun</p>
                </button>
            </div>

            <div id="reportContent" class="glass-effect p-6 rounded-xl hidden">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
                    <div>
                        <h3 id="reportTitle" class="text-xl font-semibold"></h3>
                        <p id="reportPeriod" class="text-sm text-gray-400"></p>
                    </div>
                    <button onclick="printReport()" class="px-4 py-2 bg-accent/20 text-accent rounded-lg hover:bg-accent/30 transition-all">Print</button>
                </div>
                <div id="reportData"></div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section hidden">
            <h2 class="text-2xl md:text-3xl font-bold mb-6">Pengaturan</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                <!-- Chart of Accounts -->
                <div class="glass-effect p-6 rounded-xl">
                    <h3 class="text-xl font-semibold mb-4">Chart of Accounts</h3>
                    <button onclick="showAccountForm()" class="mb-4 px-4 py-2 bg-primary/20 text-primary rounded-lg hover:bg-primary/30 transition-all">+ Tambah Akun</button>
                    
                    <div id="accountForm" class="mb-4 p-4 bg-white/5 rounded-lg hidden">
                        <form onsubmit="addAccount(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Kode Akun</label>
                                <input type="text" id="accountCode" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Nama Akun</label>
                                <input type="text" id="accountName" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Tipe Akun</label>
                                <select id="accountType" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                                    <option value="">Pilih Tipe</option>
                                    <option value="asset">Aset</option>
                                    <option value="liability">Liabilitas</option>
                                    <option value="equity">Modal</option>
                                    <option value="revenue">Pendapatan</option>
                                    <option value="expense">Beban</option>
                                </select>
                            </div>
                            <div class="flex space-x-4">
                                <button type="submit" class="px-4 py-2 bg-primary rounded-lg hover:bg-primary/80 transition-all">Simpan</button>
                                <button type="button" onclick="hideAccountForm()" class="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-700 transition-all">Batal</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="max-h-64 overflow-y-auto">
                        <div id="accountList"></div>
                    </div>
                    
                    <!-- Edit Account Form -->
                    <div id="editAccountForm" class="mt-4 p-4 bg-white/5 rounded-lg hidden">
                        <h4 class="text-lg font-semibold mb-4">Edit Akun</h4>
                        <form onsubmit="updateAccount(event)" class="space-y-4">
                            <input type="hidden" id="editAccountOriginalCode">
                            <div>
                                <label class="block text-sm font-medium mb-2">Kode Akun</label>
                                <input type="text" id="editAccountCode" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Nama Akun</label>
                                <input type="text" id="editAccountName" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Tipe Akun</label>
                                <select id="editAccountType" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                                    <option value="">Pilih Tipe</option>
                                    <option value="asset">Aset</option>
                                    <option value="liability">Liabilitas</option>
                                    <option value="equity">Modal</option>
                                    <option value="revenue">Pendapatan</option>
                                    <option value="expense">Beban</option>
                                </select>
                            </div>
                            <div class="flex space-x-4">
                                <button type="submit" class="px-4 py-2 bg-primary rounded-lg hover:bg-primary/80 transition-all">Update</button>
                                <button type="button" onclick="hideEditAccountForm()" class="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-700 transition-all">Batal</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Depreciation Settings -->
                <div class="glass-effect p-6 rounded-xl">
                    <h3 class="text-xl font-semibold mb-4">Pengaturan Penyusutan</h3>
                    <form onsubmit="saveDepreciationSettings(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Metode Penyusutan Default</label>
                                <select id="depreciationMethod" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none">
                                    <option value="straight-line">Garis Lurus</option>
                                    <option value="declining-balance">Saldo Menurun</option>
                                    <option value="sum-of-years">Jumlah Angka Tahun</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Periode Penyusutan</label>
                                <select id="depreciationPeriod" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none">
                                    <option value="monthly">Bulanan</option>
                                    <option value="yearly">Tahunan</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full px-4 py-2 bg-primary rounded-lg hover:bg-primary/80 transition-all">Simpan Pengaturan</button>
                        </div>
                    </form>
                </div>

                <!-- User Management -->
                <div class="glass-effect p-6 rounded-xl" id="userManagement">
                    <h3 class="text-xl font-semibold mb-4">Manajemen User</h3>
                    <button onclick="showUserForm()" class="mb-4 px-4 py-2 bg-primary/20 text-primary rounded-lg hover:bg-primary/30 transition-all">+ Tambah User</button>
                    
                    <div id="userForm" class="mb-4 p-4 bg-white/5 rounded-lg hidden">
                        <form onsubmit="addUser(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Username</label>
                                <input type="text" id="newUsername" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Password</label>
                                <input type="password" id="newPassword" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Nama Lengkap</label>
                                <input type="text" id="newFullName" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Role</label>
                                <select id="newUserRole" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                                    <option value="">Pilih Role</option>
                                    <option value="admin">Admin - Akses penuh</option>
                                    <option value="user">User - Dapat input dan edit data</option>
                                    <option value="viewer">Viewer - Hanya dapat melihat</option>
                                </select>
                            </div>
                            <div class="flex space-x-4">
                                <button type="submit" class="px-4 py-2 bg-primary rounded-lg hover:bg-primary/80 transition-all">Simpan</button>
                                <button type="button" onclick="hideUserForm()" class="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-700 transition-all">Batal</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="max-h-64 overflow-y-auto">
                        <div id="userList"></div>
                    </div>
                    
                    <!-- Edit User Form -->
                    <div id="editUserForm" class="mt-4 p-4 bg-white/5 rounded-lg hidden">
                        <h4 class="text-lg font-semibold mb-4">Edit User</h4>
                        <form onsubmit="updateUser(event)" class="space-y-4">
                            <input type="hidden" id="editUserOriginalUsername">
                            <div>
                                <label class="block text-sm font-medium mb-2">Username</label>
                                <input type="text" id="editUsername" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Password Baru (kosongkan jika tidak diubah)</label>
                                <input type="password" id="editPassword" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Nama Lengkap</label>
                                <input type="text" id="editFullName" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Role</label>
                                <select id="editUserRole" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                                    <option value="admin">Admin - Akses penuh</option>
                                    <option value="user">User - Dapat input dan edit data</option>
                                    <option value="viewer">Viewer - Hanya dapat melihat</option>
                                </select>
                            </div>
                            <div class="flex space-x-4">
                                <button type="submit" class="px-4 py-2 bg-primary rounded-lg hover:bg-primary/80 transition-all">Update</button>
                                <button type="button" onclick="hideEditUserForm()" class="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-700 transition-all">Batal</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Initial Settings -->
                <!-- Database Configuration -->
                <div class="glass-effect p-6 rounded-xl">
                    <h3 class="text-xl font-semibold mb-4">Konfigurasi Database</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                            <span>Status Koneksi:</span>
                            <span id="connectionStatus" class="px-3 py-1 rounded-full text-sm bg-red-500/20 text-red-400">Tidak Terhubung</span>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Google Apps Script Web App URL</label>
                            <input type="url" id="gasWebAppUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none">
                        </div>
                        
                        <div class="flex space-x-4">
                            <button onclick="connectToGoogleSheets()" class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30 transition-all">Hubungkan</button>
                            <button onclick="syncAllData()" class="px-4 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 transition-all">Sinkronkan Data</button>
                            <button onclick="loadAllData()" class="px-4 py-2 bg-purple-500/20 text-purple-400 rounded-lg hover:bg-purple-500/30 transition-all">Muat Data</button>
                        </div>
                        
                        <div class="text-sm text-gray-400">
                            <p class="mb-2"><strong>Langkah Setup Google Apps Script:</strong></p>
                            <ol class="list-decimal list-inside space-y-1 text-xs">
                                <li>Buka <a href="https://script.google.com" target="_blank" class="text-blue-400 hover:underline">script.google.com</a></li>
                                <li>Buat project baru dan salin kode Apps Script yang disediakan</li>
                                <li>Deploy sebagai Web App dengan akses "Anyone"</li>
                                <li>Salin URL Web App dan masukkan di atas</li>
                                <li>Klik "Hubungkan" untuk menghubungkan aplikasi</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div class="glass-effect p-6 rounded-xl">
                    <h3 class="text-xl font-semibold mb-4">Pengaturan Awal</h3>
                    <form onsubmit="saveInitialSettings(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Tanggal Mulai Periode</label>
                            <input type="date" id="startDate" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Nama Perusahaan</label>
                            <input type="text" id="companyName" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Saldo Awal Kas</label>
                            <input type="number" id="initialCash" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" min="0" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Mata Uang</label>
                            <select id="currency" class="w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none">
                                <option value="IDR">Rupiah (IDR)</option>
                                <option value="USD">US Dollar (USD)</option>
                                <option value="EUR">Euro (EUR)</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="px-6 py-2 bg-gradient-to-r from-primary to-secondary rounded-lg font-semibold hover:shadow-lg transition-all">Simpan Pengaturan Awal</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End of mainApp -->

    <script>
        // Global variables
        let accounts = [];
        let transactions = [];
        let assets = [];
        let users = [];
        let currentUser = null;
        let settings = {
            depreciationMethod: 'straight-line',
            depreciationPeriod: 'monthly',
            startDate: '',
            companyName: '',
            initialCash: 0,
            currency: 'IDR'
        };

        // Google Apps Script Configuration
        const GAS_CONFIG = {
            webAppUrl: '', // Will be set after deployment
            isConnected: false
        };

        // Authentication and User Management
        function initializeDefaultUsers() {
            if (users.length === 0) {
                users = [
                    {
                        username: 'admin',
                        password: 'admin123',
                        fullName: 'Administrator',
                        role: 'admin'
                    },
                    {
                        username: 'user',
                        password: 'user123',
                        fullName: 'User Biasa',
                        role: 'user'
                    },
                    {
                        username: 'viewer',
                        password: 'viewer123',
                        fullName: 'Viewer Only',
                        role: 'viewer'
                    }
                ];
                updateUserList();
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // Show main app and hide login
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Update user info in navigation
                updateUserInfo();
                
                // Apply role-based access control
                applyRoleBasedAccess();
                
                showNotification(`Selamat datang, ${user.fullName}!`, 'success');
            } else {
                showNotification('Username atau password salah!', 'error');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            
            // Hide main app and show login
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Reset form
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            showNotification('Anda telah logout', 'info');
        }

        function updateUserInfo() {
            if (!currentUser) return;
            
            const roleClass = `role-${currentUser.role}`;
            const roleName = {
                'admin': 'Admin',
                'user': 'User',
                'viewer': 'Viewer'
            }[currentUser.role];
            
            // Update desktop user info
            document.getElementById('currentUserName').textContent = currentUser.fullName;
            document.getElementById('currentUserRole').textContent = roleName;
            document.getElementById('currentUserRole').className = `role-badge ${roleClass}`;
            
            // Update mobile user info
            document.getElementById('mobileUserName').textContent = currentUser.fullName;
            document.getElementById('mobileUserRole').textContent = roleName;
            document.getElementById('mobileUserRole').className = `role-badge ${roleClass}`;
        }

        function applyRoleBasedAccess() {
            if (!currentUser) return;
            
            const isAdmin = currentUser.role === 'admin';
            const isUser = currentUser.role === 'user';
            const isViewer = currentUser.role === 'viewer';
            
            // Hide/show elements based on role
            const adminOnlyElements = document.querySelectorAll('#userManagement, #accountForm, #editAccountForm');
            const userElements = document.querySelectorAll('#transactionForm, #assetForm');
            const editButtons = document.querySelectorAll('button[onclick*="edit"], button[onclick*="delete"], button[onclick*="remove"]');
            const addButtons = document.querySelectorAll('button[onclick*="show"][onclick*="Form"], button[onclick*="add"]');
            
            // Admin can see everything
            if (isAdmin) {
                adminOnlyElements.forEach(el => el.style.display = 'block');
                userElements.forEach(el => el.style.display = 'block');
                editButtons.forEach(el => el.style.display = 'inline-block');
                addButtons.forEach(el => el.style.display = 'inline-block');
            }
            // User can input and edit data but not manage users/accounts
            else if (isUser) {
                adminOnlyElements.forEach(el => el.style.display = 'none');
                userElements.forEach(el => el.style.display = 'block');
                editButtons.forEach(el => {
                    // Allow edit/delete for transactions and assets only
                    if (el.onclick && (el.onclick.toString().includes('Transaction') || el.onclick.toString().includes('Asset'))) {
                        el.style.display = 'inline-block';
                    } else {
                        el.style.display = 'none';
                    }
                });
                addButtons.forEach(el => {
                    // Allow add for transactions and assets only
                    if (el.onclick && (el.onclick.toString().includes('Transaction') || el.onclick.toString().includes('Asset'))) {
                        el.style.display = 'inline-block';
                    } else {
                        el.style.display = 'none';
                    }
                });
            }
            // Viewer can only see data
            else if (isViewer) {
                adminOnlyElements.forEach(el => el.style.display = 'none');
                userElements.forEach(el => el.style.display = 'none');
                editButtons.forEach(el => el.style.display = 'none');
                addButtons.forEach(el => el.style.display = 'none');
            }
        }

        // User Management Functions
        function showUserForm() {
            if (currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat mengelola user!', 'error');
                return;
            }
            document.getElementById('userForm').classList.remove('hidden');
        }

        function hideUserForm() {
            document.getElementById('userForm').classList.add('hidden');
            document.getElementById('userForm').querySelector('form').reset();
        }

        async function addUser(event) {
            event.preventDefault();
            
            if (currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat menambah user!', 'error');
                return;
            }
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const fullName = document.getElementById('newFullName').value;
            const role = document.getElementById('newUserRole').value;
            
            if (users.find(u => u.username === username)) {
                showNotification('Username sudah ada!', 'error');
                return;
            }
            
            const newUser = { username, password, fullName, role };
            users.push(newUser);
            
            updateUserList();
            hideUserForm();
            
            // Auto-sync to Google Sheets if connected
            if (GAS_CONFIG.isConnected) {
                await saveToGoogleSheets('Users', users);
            }
            
            showNotification('User berhasil ditambahkan!', 'success');
        }

        function updateUserList() {
            const container = document.getElementById('userList');
            if (!container) return;
            
            container.innerHTML = users.map(user => `
                <div class="flex justify-between items-center p-3 bg-white/5 rounded-lg mb-2">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <span class="font-medium text-sm md:text-base">${user.fullName}</span>
                            <span class="role-badge role-${user.role}">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span>
                        </div>
                        <div class="text-xs text-gray-400">@${user.username}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editUser('${user.username}')" class="text-blue-400 hover:text-blue-300 text-xs md:text-sm">Edit</button>
                        <button onclick="deleteUser('${user.username}')" class="text-red-400 hover:text-red-300 text-xs md:text-sm ${user.username === 'admin' ? 'opacity-50 cursor-not-allowed' : ''}">Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        function editUser(username) {
            if (currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat mengedit user!', 'error');
                return;
            }
            
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            // Fill edit form
            document.getElementById('editUserOriginalUsername').value = username;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editPassword').value = '';
            document.getElementById('editFullName').value = user.fullName;
            document.getElementById('editUserRole').value = user.role;
            
            // Show edit form and hide add form
            hideUserForm();
            document.getElementById('editUserForm').classList.remove('hidden');
        }

        function hideEditUserForm() {
            document.getElementById('editUserForm').classList.add('hidden');
            document.getElementById('editUserForm').querySelector('form').reset();
        }

        async function updateUser(event) {
            event.preventDefault();
            
            if (currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat mengupdate user!', 'error');
                return;
            }
            
            const originalUsername = document.getElementById('editUserOriginalUsername').value;
            const newUsername = document.getElementById('editUsername').value;
            const newPassword = document.getElementById('editPassword').value;
            const fullName = document.getElementById('editFullName').value;
            const role = document.getElementById('editUserRole').value;
            
            // Check if new username already exists (and it's not the same user)
            if (newUsername !== originalUsername && users.find(u => u.username === newUsername)) {
                showNotification('Username sudah ada!', 'error');
                return;
            }
            
            // Update user
            const userIndex = users.findIndex(u => u.username === originalUsername);
            if (userIndex !== -1) {
                users[userIndex].username = newUsername;
                users[userIndex].fullName = fullName;
                users[userIndex].role = role;
                
                // Update password only if provided
                if (newPassword.trim()) {
                    users[userIndex].password = newPassword;
                }
                
                // Update current user if editing self
                if (currentUser.username === originalUsername) {
                    currentUser = users[userIndex];
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateUserInfo();
                }
                
                updateUserList();
                hideEditUserForm();
                
                // Auto-sync to Google Sheets if connected
                if (GAS_CONFIG.isConnected) {
                    await saveToGoogleSheets('Users', users);
                }
                
                showNotification('User berhasil diupdate!', 'success');
            }
        }

        async function deleteUser(username) {
            if (currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat menghapus user!', 'error');
                return;
            }
            
            if (username === 'admin') {
                showNotification('User admin tidak dapat dihapus!', 'error');
                return;
            }
            
            if (username === currentUser.username) {
                showNotification('Anda tidak dapat menghapus akun sendiri!', 'error');
                return;
            }
            
            if (confirm('Yakin ingin menghapus user ini?')) {
                users = users.filter(u => u.username !== username);
                updateUserList();
                
                // Auto-sync to Google Sheets if connected
                if (GAS_CONFIG.isConnected) {
                    await saveToGoogleSheets('Users', users);
                }
                
                showNotification('User berhasil dihapus!', 'success');
            }
        }

        // Google Apps Script Integration Functions
        async function callGoogleScript(functionName, data = {}) {
            if (!GAS_CONFIG.webAppUrl) {
                console.warn('Google Apps Script URL not configured');
                return null;
            }

            try {
                const response = await fetch(GAS_CONFIG.webAppUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        function: functionName,
                        data: data
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error calling Google Apps Script:', error);
                showNotification('Error koneksi ke database', 'error');
                return null;
            }
        }

        async function saveToGoogleSheets(sheetName, data) {
            return await callGoogleScript('saveData', { sheetName, data });
        }

        async function loadFromGoogleSheets(sheetName) {
            return await callGoogleScript('loadData', { sheetName });
        }

        async function syncAllData() {
            showNotification('Menyinkronkan data...', 'info');
            
            try {
                // Save all data to Google Sheets
                await Promise.all([
                    saveToGoogleSheets('Accounts', accounts),
                    saveToGoogleSheets('Transactions', transactions),
                    saveToGoogleSheets('Assets', assets),
                    saveToGoogleSheets('Users', users),
                    saveToGoogleSheets('Settings', [settings])
                ]);
                
                GAS_CONFIG.isConnected = true;
                updateConnectionStatus();
                showNotification('Data berhasil disinkronkan!', 'success');
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('Gagal menyinkronkan data', 'error');
            }
        }

        async function loadAllData() {
            if (!GAS_CONFIG.webAppUrl) return;
            
            showNotification('Memuat data dari database...', 'info');
            
            try {
                const [accountsData, transactionsData, assetsData, usersData, settingsData] = await Promise.all([
                    loadFromGoogleSheets('Accounts'),
                    loadFromGoogleSheets('Transactions'),
                    loadFromGoogleSheets('Assets'),
                    loadFromGoogleSheets('Users'),
                    loadFromGoogleSheets('Settings')
                ]);

                if (accountsData && accountsData.length > 0) {
                    accounts = accountsData;
                    updateAccountList();
                    updateAccountSelects();
                }

                if (transactionsData && transactionsData.length > 0) {
                    transactions = transactionsData;
                    updateTransactionList();
                }

                if (assetsData && assetsData.length > 0) {
                    assets = assetsData;
                    updateAssetList();
                }

                if (usersData && usersData.length > 0) {
                    users = usersData;
                    updateUserList();
                }

                if (settingsData && settingsData.length > 0) {
                    settings = { ...settings, ...settingsData[0] };
                    loadSettingsToForm();
                }

                updateDashboard();
                GAS_CONFIG.isConnected = true;
                updateConnectionStatus();
                showNotification('Data berhasil dimuat dari database!', 'success');
            } catch (error) {
                console.error('Load error:', error);
                showNotification('Gagal memuat data dari database', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            } text-white`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.className = `px-3 py-1 rounded-full text-sm ${
                    GAS_CONFIG.isConnected ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
                }`;
                statusElement.textContent = GAS_CONFIG.isConnected ? 'Terhubung' : 'Tidak Terhubung';
            }
        }

        function loadSettingsToForm() {
            document.getElementById('depreciationMethod').value = settings.depreciationMethod;
            document.getElementById('depreciationPeriod').value = settings.depreciationPeriod;
            document.getElementById('startDate').value = settings.startDate;
            document.getElementById('companyName').value = settings.companyName;
            document.getElementById('initialCash').value = settings.initialCash;
            document.getElementById('currency').value = settings.currency;
        }

        // Initialize default accounts
        function initializeDefaultAccounts() {
            const defaultAccounts = [
                { code: '1100', name: 'Kas', type: 'asset' },
                { code: '1200', name: 'Piutang Usaha', type: 'asset' },
                { code: '1300', name: 'Persediaan', type: 'asset' },
                { code: '1400', name: 'Peralatan', type: 'asset' },
                { code: '1500', name: 'Akumulasi Penyusutan Peralatan', type: 'asset' },
                { code: '2100', name: 'Utang Usaha', type: 'liability' },
                { code: '2200', name: 'Utang Bank', type: 'liability' },
                { code: '3100', name: 'Modal Pemilik', type: 'equity' },
                { code: '4100', name: 'Pendapatan Penjualan', type: 'revenue' },
                { code: '5100', name: 'Beban Gaji', type: 'expense' },
                { code: '5200', name: 'Beban Sewa', type: 'expense' },
                { code: '5300', name: 'Beban Penyusutan', type: 'expense' }
            ];
            
            if (accounts.length === 0) {
                accounts = defaultAccounts;
                updateAccountList();
                updateAccountSelects();
            }
        }

        // Navigation functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('hidden');
        }

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionName).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-white/20');
            });
            event.target.classList.add('active', 'bg-white/20');
            
            // Hide mobile menu after selection
            const mobileMenu = document.getElementById('mobileMenu');
            if (!mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
            }
        }

        // Transaction functions
        function showTransactionForm() {
            document.getElementById('transactionForm').classList.remove('hidden');
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
        }

        function hideTransactionForm() {
            document.getElementById('transactionForm').classList.add('hidden');
            document.getElementById('transactionForm').querySelector('form').reset();
        }

        function addJournalEntry() {
            const entriesContainer = document.getElementById('journalEntries');
            const newEntry = document.createElement('div');
            newEntry.className = 'journal-entry grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-4 bg-white/5 rounded-lg';
            newEntry.innerHTML = `
                <div class="sm:col-span-2 lg:col-span-1">
                    <label class="block text-sm font-medium mb-2">Akun</label>
                    <select class="account-select w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" required>
                        <option value="">Pilih Akun</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Debit</label>
                    <input type="number" class="debit-amount w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" placeholder="0" min="0" step="0.01">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Kredit</label>
                    <input type="number" class="credit-amount w-full p-3 bg-white/10 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" placeholder="0" min="0" step="0.01">
                </div>
                <div class="flex items-end">
                    <button type="button" onclick="removeJournalEntry(this)" class="w-full p-3 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-all text-sm">Hapus</button>
                </div>
            `;
            entriesContainer.appendChild(newEntry);
            updateAccountSelects();
        }

        function removeJournalEntry(button) {
            const entries = document.querySelectorAll('.journal-entry');
            if (entries.length > 1) {
                button.closest('.journal-entry').remove();
            }
        }

        async function addTransaction(event) {
            event.preventDefault();
            
            if (currentUser.role === 'viewer') {
                showNotification('Anda tidak memiliki akses untuk menambah transaksi!', 'error');
                return;
            }
            
            const date = document.getElementById('transactionDate').value;
            const ref = document.getElementById('transactionRef').value;
            const desc = document.getElementById('transactionDesc').value;
            
            const entries = [];
            let totalDebit = 0, totalCredit = 0;
            
            document.querySelectorAll('.journal-entry').forEach(entry => {
                const account = entry.querySelector('.account-select').value;
                const debit = parseFloat(entry.querySelector('.debit-amount').value) || 0;
                const credit = parseFloat(entry.querySelector('.credit-amount').value) || 0;
                
                if (account && (debit > 0 || credit > 0)) {
                    entries.push({ account, debit, credit });
                    totalDebit += debit;
                    totalCredit += credit;
                }
            });
            
            if (Math.abs(totalDebit - totalCredit) > 0.01) {
                alert('Total debit dan kredit harus seimbang!');
                return;
            }
            
            const transaction = {
                id: Date.now(),
                date,
                ref: ref || `TRX-${Date.now()}`,
                description: desc,
                entries,
                total: totalDebit
            };
            
            transactions.push(transaction);
            updateAllData();
            hideTransactionForm();
            
            // Auto-sync to Google Sheets if connected
            if (GAS_CONFIG.isConnected) {
                await saveToGoogleSheets('Transactions', transactions);
            }
            
            showNotification('Transaksi berhasil disimpan!', 'success');
        }

        function connectToGoogleSheets() {
            const url = document.getElementById('gasWebAppUrl').value.trim();
            if (!url) {
                showNotification('Masukkan URL Google Apps Script terlebih dahulu', 'error');
                return;
            }
            
            GAS_CONFIG.webAppUrl = url;
            localStorage.setItem('gasWebAppUrl', url);
            
            // Test connection
            loadAllData();
        }

        function updateTransactionList() {
            const tbody = document.getElementById('transactionList');
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr class="border-b border-gray-700"><td class="py-2 md:py-3 text-gray-300 text-sm md:text-base" colspan="5">Belum ada transaksi</td></tr>';
                return;
            }
            
            tbody.innerHTML = transactions.map(transaction => `
                <tr class="border-b border-gray-700 hover:bg-white/5">
                    <td class="py-2 md:py-3 text-sm md:text-base">${new Date(transaction.date).toLocaleDateString('id-ID')}</td>
                    <td class="py-2 md:py-3 text-sm md:text-base">${transaction.ref}</td>
                    <td class="py-2 md:py-3 text-sm md:text-base">${transaction.description}</td>
                    <td class="py-2 md:py-3 text-right text-sm md:text-base">${formatCurrency(transaction.total)}</td>
                    <td class="py-2 md:py-3 text-center">
                        <div class="flex flex-col sm:flex-row justify-center space-y-1 sm:space-y-0 sm:space-x-2">
                            <button onclick="editTransaction(${transaction.id})" class="text-blue-400 hover:text-blue-300 text-xs md:text-sm">Edit</button>
                            <button onclick="deleteTransaction(${transaction.id})" class="text-red-400 hover:text-red-300 text-xs md:text-sm">Hapus</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;
            
            // Fill form with transaction data
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('transactionRef').value = transaction.ref;
            document.getElementById('transactionDesc').value = transaction.description;
            
            // Clear existing journal entries
            const entriesContainer = document.getElementById('journalEntries');
            entriesContainer.innerHTML = '';
            
            // Add journal entries from transaction
            transaction.entries.forEach((entry, index) => {
                if (index === 0) {
                    // Use existing first entry
                    addJournalEntry();
                } else {
                    addJournalEntry();
                }
                
                const entryElements = entriesContainer.querySelectorAll('.journal-entry');
                const currentEntry = entryElements[index];
                
                currentEntry.querySelector('.account-select').value = entry.account;
                currentEntry.querySelector('.debit-amount').value = entry.debit || '';
                currentEntry.querySelector('.credit-amount').value = entry.credit || '';
            });
            
            // Show form and change submit behavior
            showTransactionForm();
            const form = document.getElementById('transactionForm').querySelector('form');
            form.onsubmit = function(event) {
                updateTransaction(event, id);
            };
            
            // Change form title
            document.querySelector('#transactionForm h3').textContent = 'Edit Transaksi';
            
            // Change button text
            document.querySelector('#transactionForm button[type="submit"]').textContent = 'Update Transaksi';
        }

        async function updateTransaction(event, id) {
            event.preventDefault();
            
            const date = document.getElementById('transactionDate').value;
            const ref = document.getElementById('transactionRef').value;
            const desc = document.getElementById('transactionDesc').value;
            
            const entries = [];
            let totalDebit = 0, totalCredit = 0;
            
            document.querySelectorAll('.journal-entry').forEach(entry => {
                const account = entry.querySelector('.account-select').value;
                const debit = parseFloat(entry.querySelector('.debit-amount').value) || 0;
                const credit = parseFloat(entry.querySelector('.credit-amount').value) || 0;
                
                if (account && (debit > 0 || credit > 0)) {
                    entries.push({ account, debit, credit });
                    totalDebit += debit;
                    totalCredit += credit;
                }
            });
            
            if (Math.abs(totalDebit - totalCredit) > 0.01) {
                alert('Total debit dan kredit harus seimbang!');
                return;
            }
            
            // Update transaction
            const transactionIndex = transactions.findIndex(t => t.id === id);
            if (transactionIndex !== -1) {
                transactions[transactionIndex] = {
                    id,
                    date,
                    ref: ref || `TRX-${id}`,
                    description: desc,
                    entries,
                    total: totalDebit
                };
                
                updateAllData();
                hideTransactionForm();
                
                // Reset form
                const form = document.getElementById('transactionForm').querySelector('form');
                form.onsubmit = function(event) {
                    addTransaction(event);
                };
                document.querySelector('#transactionForm h3').textContent = 'Form Transaksi Baru';
                document.querySelector('#transactionForm button[type="submit"]').textContent = 'Simpan Transaksi';
                
                // Auto-sync to Google Sheets if connected
                if (GAS_CONFIG.isConnected) {
                    await saveToGoogleSheets('Transactions', transactions);
                }
                
                showNotification('Transaksi berhasil diupdate!', 'success');
            }
        }

        async function deleteTransaction(id) {
            if (confirm('Yakin ingin menghapus transaksi ini?')) {
                transactions = transactions.filter(t => t.id !== id);
                updateAllData();
                
                // Auto-sync to Google Sheets if connected
                if (GAS_CONFIG.isConnected) {
                    await saveToGoogleSheets('Transactions', transactions);
                }
                
                showNotification('Transaksi berhasil dihapus!', 'success');
            }
        }

        // Asset functions
        function showAssetForm() {
            document.getElementById('assetForm').classList.remove('hidden');
            document.getElementById('assetDate').value = new Date().toISOString().split('T')[0];
        }

        function hideAssetForm() {
            document.getElementById('assetForm').classList.add('hidden');
            document.getElementById('assetForm').querySelector('form').reset();
        }

        async function addAsset(event) {
            event.preventDefault();
            
            if (currentUser.role === 'viewer') {
                showNotification('Anda tidak memiliki akses untuk menambah aset!', 'error');
                return;
            }
            
            const asset = {
                id: Date.now(),
                name: document.getElementById('assetName').value,
                category: document.getElementById('assetCategory').value,
                cost: parseFloat(document.getElementById('assetCost').value),
                date: document.getElementById('assetDate').value,
                life: parseInt(document.getElementById('assetLife').value),
                residual: parseFloat(document.getElementById('assetResidual').value) || 0
            };
            
            assets.push(asset);
            updateAllData();
            hideAssetForm();
            
            // Auto-sync to Google Sheets if connected
            if (GAS_CONFIG.isConnected) {
                await saveToGoogleSheets('Assets', assets);
            }
            
            showNotification('Aset berhasil ditambahkan!', 'success');
        }

        function calculateDepreciation(asset) {
            const today = new Date();
            const assetDate = new Date(asset.date);
            const monthsElapsed = (today.getFullYear() - assetDate.getFullYear()) * 12 + (today.getMonth() - assetDate.getMonth());
            
            const depreciableAmount = asset.cost - asset.residual;
            const totalMonths = asset.life * 12;
            
            let accumulatedDepreciation = 0;
            
            if (settings.depreciationMethod === 'straight-line') {
                const monthlyDepreciation = depreciableAmount / totalMonths;
                accumulatedDepreciation = Math.min(monthlyDepreciation * monthsElapsed, depreciableAmount);
            }
            
            return accumulatedDepreciation;
        }

        function updateAssetList() {
            const tbody = document.getElementById('assetList');
            if (assets.length === 0) {
                tbody.innerHTML = '<tr class="border-b border-gray-700"><td class="py-3 text-gray-300" colspan="6">Belum ada aset</td></tr>';
                return;
            }
            
            tbody.innerHTML = assets.map(asset => {
                const accumulatedDepreciation = calculateDepreciation(asset);
                const bookValue = asset.cost - accumulatedDepreciation;
                
                return `
                    <tr class="border-b border-gray-700 hover:bg-white/5">
                        <td class="py-3">${asset.name}</td>
                        <td class="py-3 capitalize">${asset.category}</td>
                        <td class="py-3 text-right">${formatCurrency(asset.cost)}</td>
                        <td class="py-3 text-right">${formatCurrency(accumulatedDepreciation)}</td>
                        <td class="py-3 text-right">${formatCurrency(bookValue)}</td>
                        <td class="py-3 text-center">
                            <button onclick="deleteAsset(${asset.id})" class="text-red-400 hover:text-red-300">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function deleteAsset(id) {
            if (confirm('Yakin ingin menghapus aset ini?')) {
                assets = assets.filter(a => a.id !== id);
                updateAllData();
                
                // Auto-sync to Google Sheets if connected
                if (GAS_CONFIG.isConnected) {
                    await saveToGoogleSheets('Assets', assets);
                }
                
                showNotification('Aset berhasil dihapus!', 'success');
            }
        }

        // Account functions
        function showAccountForm() {
            document.getElementById('accountForm').classList.remove('hidden');
        }

        function hideAccountForm() {
            document.getElementById('accountForm').classList.add('hidden');
            document.getElementById('accountForm').querySelector('form').reset();
        }

        async function addAccount(event) {
            event.preventDefault();
            
            if (currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat menambah akun!', 'error');
                return;
            }
            
            const account = {
                code: document.getElementById('accountCode').value,
                name: document.getElementById('accountName').value,
                type: document.getElementById('accountType').value
            };
            
            if (accounts.find(a => a.code === account.code)) {
                showNotification('Kode akun sudah ada!', 'error');
                return;
            }
            
            accounts.push(account);
            updateAllData();
            hideAccountForm();
            
            // Auto-sync to Google Sheets if connected
            if (GAS_CONFIG.isConnected) {
                await saveToGoogleSheets('Accounts', accounts);
            }
            
            showNotification('Akun berhasil ditambahkan!', 'success');
        }

        function updateAccountList() {
            const container = document.getElementById('accountList');
            container.innerHTML = accounts.map(account => `
                <div class="flex justify-between items-center p-3 bg-white/5 rounded-lg mb-2">
                    <div class="flex-1">
                        <span class="font-medium text-sm md:text-base">${account.code} - ${account.name}</span>
                        <span class="text-xs md:text-sm text-gray-400 ml-2 capitalize">(${account.type})</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editAccount('${account.code}')" class="text-blue-400 hover:text-blue-300 text-xs md:text-sm">Edit</button>
                        <button onclick="deleteAccount('${account.code}')" class="text-red-400 hover:text-red-300 text-xs md:text-sm">Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        function editAccount(code) {
            const account = accounts.find(a => a.code === code);
            if (!account) return;
            
            // Fill edit form
            document.getElementById('editAccountOriginalCode').value = code;
            document.getElementById('editAccountCode').value = account.code;
            document.getElementById('editAccountName').value = account.name;
            document.getElementById('editAccountType').value = account.type;
            
            // Show edit form and hide add form
            hideAccountForm();
            document.getElementById('editAccountForm').classList.remove('hidden');
        }

        function hideEditAccountForm() {
            document.getElementById('editAccountForm').classList.add('hidden');
            document.getElementById('editAccountForm').querySelector('form').reset();
        }

        async function updateAccount(event) {
            event.preventDefault();
            
            const originalCode = document.getElementById('editAccountOriginalCode').value;
            const newCode = document.getElementById('editAccountCode').value;
            const name = document.getElementById('editAccountName').value;
            const type = document.getElementById('editAccountType').value;
            
            // Check if new code already exists (and it's not the same account)
            if (newCode !== originalCode && accounts.find(a => a.code === newCode)) {
                showNotification('Kode akun sudah ada!', 'error');
                return;
            }
            
            // Update account
            const accountIndex = accounts.findIndex(a => a.code === originalCode);
            if (accountIndex !== -1) {
                accounts[accountIndex] = { code: newCode, name, type };
                
                // Update any transactions that use this account
                transactions.forEach(transaction => {
                    transaction.entries.forEach(entry => {
                        if (entry.account === originalCode) {
                            entry.account = newCode;
                        }
                    });
                });
                
                updateAllData();
                hideEditAccountForm();
                
                // Auto-sync to Google Sheets if connected
                if (GAS_CONFIG.isConnected) {
                    await Promise.all([
                        saveToGoogleSheets('Accounts', accounts),
                        saveToGoogleSheets('Transactions', transactions)
                    ]);
                }
                
                showNotification('Akun berhasil diupdate!', 'success');
            }
        }

        async function deleteAccount(code) {
            if (confirm('Yakin ingin menghapus akun ini?')) {
                // Check if account is used in transactions
                const isUsed = transactions.some(transaction => 
                    transaction.entries.some(entry => entry.account === code)
                );
                
                if (isUsed) {
                    showNotification('Akun tidak dapat dihapus karena sudah digunakan dalam transaksi!', 'error');
                    return;
                }
                
                accounts = accounts.filter(a => a.code !== code);
                updateAllData();
                
                // Auto-sync to Google Sheets if connected
                if (GAS_CONFIG.isConnected) {
                    await saveToGoogleSheets('Accounts', accounts);
                }
                
                showNotification('Akun berhasil dihapus!', 'success');
            }
        }

        function updateAccountSelects() {
            const selects = document.querySelectorAll('.account-select');
            const options = accounts.map(account => 
                `<option value="${account.code}">${account.code} - ${account.name}</option>`
            ).join('');
            
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Pilih Akun</option>' + options;
                select.value = currentValue;
            });
        }

        // Settings functions
        async function saveDepreciationSettings(event) {
            event.preventDefault();
            
            settings.depreciationMethod = document.getElementById('depreciationMethod').value;
            settings.depreciationPeriod = document.getElementById('depreciationPeriod').value;
            
            updateAllData();
            
            // Auto-sync to Google Sheets if connected
            if (GAS_CONFIG.isConnected) {
                await saveToGoogleSheets('Settings', [settings]);
            }
            
            showNotification('Pengaturan penyusutan berhasil disimpan!', 'success');
        }

        async function saveInitialSettings(event) {
            event.preventDefault();
            
            settings.startDate = document.getElementById('startDate').value;
            settings.companyName = document.getElementById('companyName').value;
            settings.initialCash = parseFloat(document.getElementById('initialCash').value) || 0;
            settings.currency = document.getElementById('currency').value;
            
            updateAllData();
            
            // Auto-sync to Google Sheets if connected
            if (GAS_CONFIG.isConnected) {
                await saveToGoogleSheets('Settings', [settings]);
            }
            
            showNotification('Pengaturan awal berhasil disimpan!', 'success');
        }

        // Report functions
        function generateReport(reportType) {
            const reportContent = document.getElementById('reportContent');
            const reportTitle = document.getElementById('reportTitle');
            const reportPeriod = document.getElementById('reportPeriod');
            const reportData = document.getElementById('reportData');
            
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            // Set period text
            let periodText = 'Semua Periode';
            if (startDate && endDate) {
                periodText = `Periode: ${new Date(startDate).toLocaleDateString('id-ID')} - ${new Date(endDate).toLocaleDateString('id-ID')}`;
            } else if (startDate) {
                periodText = `Mulai: ${new Date(startDate).toLocaleDateString('id-ID')}`;
            } else if (endDate) {
                periodText = `Sampai: ${new Date(endDate).toLocaleDateString('id-ID')}`;
            }
            
            reportContent.classList.remove('hidden');
            reportPeriod.textContent = periodText;
            
            switch (reportType) {
                case 'balance-sheet':
                    reportTitle.textContent = 'Neraca';
                    reportData.innerHTML = generateBalanceSheet(startDate, endDate);
                    break;
                case 'income-statement':
                    reportTitle.textContent = 'Laporan Laba Rugi';
                    reportData.innerHTML = generateIncomeStatement(startDate, endDate);
                    break;
                case 'cash-flow':
                    reportTitle.textContent = 'Laporan Arus Kas';
                    reportData.innerHTML = generateCashFlow(startDate, endDate);
                    break;
                case 'trial-balance':
                    reportTitle.textContent = 'Neraca Saldo';
                    reportData.innerHTML = generateTrialBalance(startDate, endDate);
                    break;
                case 'general-ledger':
                    reportTitle.textContent = 'Buku Besar';
                    reportData.innerHTML = generateGeneralLedger(startDate, endDate);
                    break;
            }
        }

        function clearReportDates() {
            document.getElementById('reportStartDate').value = '';
            document.getElementById('reportEndDate').value = '';
        }

        function generateBalanceSheet(startDate = null, endDate = null) {
            const balances = calculateAccountBalances(startDate, endDate);
            const assetAccounts = accounts.filter(a => a.type === 'asset');
            const liabilityAccounts = accounts.filter(a => a.type === 'liability');
            const equityAccounts = accounts.filter(a => a.type === 'equity');
            
            let totalAssets = 0;
            let totalLiabilities = 0;
            let totalEquity = 0;
            
            // Calculate revenue and expense for retained earnings
            const revenueAccounts = accounts.filter(a => a.type === 'revenue');
            const expenseAccounts = accounts.filter(a => a.type === 'expense');
            let totalRevenue = 0;
            let totalExpense = 0;
            
            revenueAccounts.forEach(account => {
                totalRevenue += balances[account.code] || 0;
            });
            
            expenseAccounts.forEach(account => {
                totalExpense += balances[account.code] || 0;
            });
            
            const retainedEarnings = totalRevenue - totalExpense;
            
            return `
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-green-400">ASET</h4>
                        <div class="space-y-2">
                            ${assetAccounts.map(account => {
                                const balance = balances[account.code] || 0;
                                totalAssets += balance;
                                return balance !== 0 ? `<div class="flex justify-between">
                                    <span>${account.name}</span>
                                    <span>${formatCurrency(balance)}</span>
                                </div>` : '';
                            }).filter(item => item).join('')}
                            
                            ${assets.map(asset => {
                                const bookValue = asset.cost - calculateDepreciation(asset);
                                totalAssets += bookValue;
                                return `<div class="flex justify-between">
                                    <span>${asset.name} (Nilai Buku)</span>
                                    <span>${formatCurrency(bookValue)}</span>
                                </div>`;
                            }).join('')}
                            
                            ${!balances['1100'] && settings.initialCash > 0 ? `<div class="flex justify-between">
                                <span>Kas Awal</span>
                                <span>${formatCurrency(settings.initialCash)}</span>
                            </div>` : ''}
                            
                            <div class="border-t border-gray-600 pt-2 flex justify-between font-semibold">
                                <span>Total Aset</span>
                                <span>${formatCurrency(totalAssets + (!balances['1100'] ? settings.initialCash : 0))}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-red-400">LIABILITAS</h4>
                        <div class="space-y-2">
                            ${liabilityAccounts.map(account => {
                                const balance = balances[account.code] || 0;
                                totalLiabilities += balance;
                                return balance !== 0 ? `<div class="flex justify-between">
                                    <span>${account.name}</span>
                                    <span>${formatCurrency(balance)}</span>
                                </div>` : '';
                            }).filter(item => item).join('')}
                            
                            ${totalLiabilities === 0 ? '<div class="flex justify-between"><span>Tidak ada liabilitas</span><span>Rp 0</span></div>' : ''}
                            
                            <div class="border-t border-gray-600 pt-2 flex justify-between font-semibold">
                                <span>Total Liabilitas</span>
                                <span>${formatCurrency(totalLiabilities)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-blue-400">MODAL</h4>
                        <div class="space-y-2">
                            ${equityAccounts.map(account => {
                                const balance = balances[account.code] || 0;
                                totalEquity += balance;
                                return balance !== 0 ? `<div class="flex justify-between">
                                    <span>${account.name}</span>
                                    <span>${formatCurrency(balance)}</span>
                                </div>` : '';
                            }).filter(item => item).join('')}
                            
                            ${retainedEarnings !== 0 ? `<div class="flex justify-between">
                                <span>Laba Ditahan</span>
                                <span>${formatCurrency(retainedEarnings)}</span>
                            </div>` : ''}
                            
                            <div class="border-t border-gray-600 pt-2 flex justify-between font-semibold">
                                <span>Total Modal</span>
                                <span>${formatCurrency(totalEquity + retainedEarnings)}</span>
                            </div>
                            
                            <div class="border-t border-gray-600 pt-2 flex justify-between font-bold text-lg">
                                <span>Total Liabilitas + Modal</span>
                                <span>${formatCurrency(totalLiabilities + totalEquity + retainedEarnings)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateIncomeStatement(startDate = null, endDate = null) {
            const balances = calculateAccountBalances(startDate, endDate);
            const revenueAccounts = accounts.filter(a => a.type === 'revenue');
            const expenseAccounts = accounts.filter(a => a.type === 'expense');
            
            let totalRevenue = 0;
            let totalExpense = 0;
            
            return `
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-green-400">PENDAPATAN</h4>
                        <div class="space-y-2">
                            ${revenueAccounts.map(account => {
                                const balance = balances[account.code] || 0;
                                totalRevenue += balance;
                                return balance !== 0 ? `<div class="flex justify-between">
                                    <span>${account.name}</span>
                                    <span>${formatCurrency(balance)}</span>
                                </div>` : '';
                            }).filter(item => item).join('')}
                            
                            ${totalRevenue === 0 ? '<div class="flex justify-between"><span>Belum ada pendapatan</span><span>Rp 0</span></div>' : ''}
                            
                            <div class="border-t border-gray-600 pt-2 flex justify-between font-semibold">
                                <span>Total Pendapatan</span>
                                <span>${formatCurrency(totalRevenue)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-red-400">BEBAN</h4>
                        <div class="space-y-2">
                            ${expenseAccounts.map(account => {
                                const balance = balances[account.code] || 0;
                                totalExpense += balance;
                                return balance !== 0 ? `<div class="flex justify-between">
                                    <span>${account.name}</span>
                                    <span>${formatCurrency(balance)}</span>
                                </div>` : '';
                            }).filter(item => item).join('')}
                            
                            ${totalExpense === 0 ? '<div class="flex justify-between"><span>Belum ada beban</span><span>Rp 0</span></div>' : ''}
                            
                            <div class="border-t border-gray-600 pt-2 flex justify-between font-semibold">
                                <span>Total Beban</span>
                                <span>${formatCurrency(totalExpense)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-600 pt-4">
                        <div class="flex justify-between font-bold text-lg">
                            <span>Laba Bersih</span>
                            <span class="${(totalRevenue - totalExpense) >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(totalRevenue - totalExpense)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateCashFlow(startDate = null, endDate = null) {
            const balances = calculateAccountBalances(startDate, endDate);
            const cashAccount = accounts.find(a => a.code === '1100');
            const cashBalance = balances['1100'] || 0;
            
            // Filter transactions for the period
            const filteredTransactions = transactions.filter(transaction => {
                if (!startDate && !endDate) return true;
                const transactionDate = new Date(transaction.date);
                const start = startDate ? new Date(startDate) : new Date('1900-01-01');
                const end = endDate ? new Date(endDate) : new Date('2100-12-31');
                return transactionDate >= start && transactionDate <= end;
            });
            
            let operatingCashFlow = 0;
            let investingCashFlow = 0;
            let financingCashFlow = 0;
            
            // Analyze cash flows from transactions
            filteredTransactions.forEach(transaction => {
                transaction.entries.forEach(entry => {
                    if (entry.account === '1100') { // Cash account
                        const amount = (entry.debit || 0) - (entry.credit || 0);
                        const otherEntry = transaction.entries.find(e => e.account !== '1100');
                        if (otherEntry) {
                            const otherAccount = accounts.find(a => a.code === otherEntry.account);
                            if (otherAccount) {
                                if (otherAccount.type === 'revenue' || otherAccount.type === 'expense') {
                                    operatingCashFlow += amount;
                                } else if (otherAccount.type === 'asset' && otherAccount.code !== '1100') {
                                    investingCashFlow += amount;
                                } else {
                                    financingCashFlow += amount;
                                }
                            }
                        }
                    }
                });
            });
            
            const netCashFlow = operatingCashFlow + investingCashFlow + financingCashFlow;
            
            return `
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-blue-400">ARUS KAS OPERASI</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Arus Kas dari Aktivitas Operasi</span>
                                <span class="${operatingCashFlow >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(operatingCashFlow)}</span>
                            </div>
                            <div class="border-t border-gray-600 pt-2 flex justify-between font-semibold">
                                <span>Arus Kas Bersih dari Operasi</span>
                                <span class="${operatingCashFlow >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(operatingCashFlow)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-purple-400">ARUS KAS INVESTASI</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Arus Kas dari Aktivitas Investasi</span>
                                <span class="${investingCashFlow >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(investingCashFlow)}</span>
                            </div>
                            <div class="border-t border-gray-600 pt-2 flex justify-between font-semibold">
                                <span>Arus Kas Bersih dari Investasi</span>
                                <span class="${investingCashFlow >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(investingCashFlow)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-yellow-400">ARUS KAS PENDANAAN</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Arus Kas dari Aktivitas Pendanaan</span>
                                <span class="${financingCashFlow >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(financingCashFlow)}</span>
                            </div>
                            <div class="border-t border-gray-600 pt-2 flex justify-between font-semibold">
                                <span>Arus Kas Bersih dari Pendanaan</span>
                                <span class="${financingCashFlow >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(financingCashFlow)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-600 pt-4">
                        <div class="flex justify-between font-bold text-lg">
                            <span>Kenaikan (Penurunan) Kas Bersih</span>
                            <span class="${netCashFlow >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(netCashFlow)}</span>
                        </div>
                        <div class="flex justify-between mt-2">
                            <span>Saldo Kas Akhir Periode</span>
                            <span>${formatCurrency(cashBalance + (!balances['1100'] ? settings.initialCash : 0))}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateTrialBalance(startDate = null, endDate = null) {
            const balances = calculateAccountBalances(startDate, endDate);
            let totalDebit = 0;
            let totalCredit = 0;
            
            return `
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[600px]">
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="text-left py-3">Kode</th>
                                <th class="text-left py-3">Nama Akun</th>
                                <th class="text-right py-3">Debit</th>
                                <th class="text-right py-3">Kredit</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${accounts.map(account => {
                                const balance = balances[account.code] || 0;
                                let debitAmount = 0;
                                let creditAmount = 0;
                                
                                if (balance > 0) {
                                    if (account.type === 'asset' || account.type === 'expense') {
                                        debitAmount = balance;
                                        totalDebit += balance;
                                    } else {
                                        creditAmount = balance;
                                        totalCredit += balance;
                                    }
                                } else if (balance < 0) {
                                    if (account.type === 'asset' || account.type === 'expense') {
                                        creditAmount = Math.abs(balance);
                                        totalCredit += Math.abs(balance);
                                    } else {
                                        debitAmount = Math.abs(balance);
                                        totalDebit += Math.abs(balance);
                                    }
                                }
                                
                                return (debitAmount !== 0 || creditAmount !== 0) ? `
                                    <tr class="border-b border-gray-700">
                                        <td class="py-2">${account.code}</td>
                                        <td class="py-2">${account.name}</td>
                                        <td class="py-2 text-right">${debitAmount > 0 ? formatCurrency(debitAmount) : '-'}</td>
                                        <td class="py-2 text-right">${creditAmount > 0 ? formatCurrency(creditAmount) : '-'}</td>
                                    </tr>
                                ` : '';
                            }).filter(item => item).join('')}
                            
                            <tr class="border-t-2 border-gray-500 font-bold">
                                <td class="py-3" colspan="2">TOTAL</td>
                                <td class="py-3 text-right">${formatCurrency(totalDebit)}</td>
                                <td class="py-3 text-right">${formatCurrency(totalCredit)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generateGeneralLedger(startDate = null, endDate = null) {
            // Filter transactions by date
            const filteredTransactions = transactions.filter(transaction => {
                if (!startDate && !endDate) return true;
                const transactionDate = new Date(transaction.date);
                const start = startDate ? new Date(startDate) : new Date('1900-01-01');
                const end = endDate ? new Date(endDate) : new Date('2100-12-31');
                return transactionDate >= start && transactionDate <= end;
            });
            
            return `
                <div class="space-y-6">
                    ${accounts.map(account => {
                        const accountTransactions = [];
                        let runningBalance = 0;
                        
                        filteredTransactions.forEach(transaction => {
                            transaction.entries.forEach(entry => {
                                if (entry.account === account.code) {
                                    const debit = entry.debit || 0;
                                    const credit = entry.credit || 0;
                                    
                                    // Calculate running balance based on account type
                                    if (account.type === 'asset' || account.type === 'expense') {
                                        runningBalance += debit - credit;
                                    } else {
                                        runningBalance += credit - debit;
                                    }
                                    
                                    accountTransactions.push({
                                        date: transaction.date,
                                        ref: transaction.ref,
                                        description: transaction.description,
                                        debit,
                                        credit,
                                        balance: runningBalance
                                    });
                                }
                            });
                        });
                        
                        return accountTransactions.length > 0 ? `
                            <div class="glass-effect p-4 rounded-lg">
                                <h5 class="font-semibold mb-3">${account.code} - ${account.name}</h5>
                                <div class="overflow-x-auto">
                                    <table class="w-full min-w-[700px] text-sm">
                                        <thead>
                                            <tr class="border-b border-gray-600">
                                                <th class="text-left py-2">Tanggal</th>
                                                <th class="text-left py-2">Ref</th>
                                                <th class="text-left py-2">Deskripsi</th>
                                                <th class="text-right py-2">Debit</th>
                                                <th class="text-right py-2">Kredit</th>
                                                <th class="text-right py-2">Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${accountTransactions.map(trans => `
                                                <tr class="border-b border-gray-700">
                                                    <td class="py-1">${new Date(trans.date).toLocaleDateString('id-ID')}</td>
                                                    <td class="py-1">${trans.ref}</td>
                                                    <td class="py-1">${trans.description}</td>
                                                    <td class="py-1 text-right">${trans.debit > 0 ? formatCurrency(trans.debit) : '-'}</td>
                                                    <td class="py-1 text-right">${trans.credit > 0 ? formatCurrency(trans.credit) : '-'}</td>
                                                    <td class="py-1 text-right font-medium">${formatCurrency(trans.balance)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : '';
                    }).filter(item => item).join('')}
                    
                    ${accounts.every(account => {
                        return !filteredTransactions.some(transaction => 
                            transaction.entries.some(entry => entry.account === account.code)
                        );
                    }) ? '<div class="text-center text-gray-400 py-8">Tidak ada transaksi untuk periode yang dipilih</div>' : ''}
                </div>
            `;
        }

        function printReport() {
            window.print();
        }

        // Dashboard functions
        function updateDashboard() {
            const balances = calculateAccountBalances();
            
            let totalAssets = 0;
            let totalLiabilities = 0;
            let totalEquity = 0;
            let totalRevenue = 0;
            let totalExpense = 0;
            
            // Calculate totals from account balances
            accounts.forEach(account => {
                const balance = balances[account.code] || 0;
                switch (account.type) {
                    case 'asset':
                        totalAssets += balance;
                        break;
                    case 'liability':
                        totalLiabilities += balance;
                        break;
                    case 'equity':
                        totalEquity += balance;
                        break;
                    case 'revenue':
                        totalRevenue += balance;
                        break;
                    case 'expense':
                        totalExpense += balance;
                        break;
                }
            });
            
            // Add asset book values
            assets.forEach(asset => {
                const bookValue = asset.cost - calculateDepreciation(asset);
                totalAssets += bookValue;
            });
            
            // Add initial cash if not already in transactions
            if (!balances['1100']) {
                totalAssets += settings.initialCash;
            }
            
            const monthlyProfit = totalRevenue - totalExpense;
            totalEquity += monthlyProfit; // Add retained earnings
            
            document.getElementById('totalAssets').textContent = formatCurrency(totalAssets);
            document.getElementById('totalLiabilities').textContent = formatCurrency(totalLiabilities);
            document.getElementById('totalEquity').textContent = formatCurrency(totalEquity);
            document.getElementById('monthlyProfit').textContent = formatCurrency(monthlyProfit);
            
            // Update recent transactions
            const recentTransactions = document.getElementById('recentTransactions');
            if (transactions.length === 0) {
                recentTransactions.innerHTML = '<tr class="border-b border-gray-700"><td class="py-3 text-gray-300" colspan="5">Belum ada transaksi</td></tr>';
            } else {
                const recent = transactions.slice(-5).reverse();
                recentTransactions.innerHTML = recent.map(transaction => {
                    const firstEntry = transaction.entries[0];
                    return `
                        <tr class="border-b border-gray-700">
                            <td class="py-3">${new Date(transaction.date).toLocaleDateString('id-ID')}</td>
                            <td class="py-3">${transaction.description}</td>
                            <td class="py-3">${accounts.find(a => a.code === firstEntry.account)?.name || firstEntry.account}</td>
                            <td class="py-3 text-right">${firstEntry.debit > 0 ? formatCurrency(firstEntry.debit) : '-'}</td>
                            <td class="py-3 text-right">${firstEntry.credit > 0 ? formatCurrency(firstEntry.credit) : '-'}</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Calculate account balances from all transactions
        function calculateAccountBalances(startDate = null, endDate = null) {
            const balances = {};
            
            // Initialize all accounts with zero balance
            accounts.forEach(account => {
                balances[account.code] = 0;
            });
            
            // Filter transactions by date if specified
            const filteredTransactions = transactions.filter(transaction => {
                if (!startDate && !endDate) return true;
                const transactionDate = new Date(transaction.date);
                const start = startDate ? new Date(startDate) : new Date('1900-01-01');
                const end = endDate ? new Date(endDate) : new Date('2100-12-31');
                return transactionDate >= start && transactionDate <= end;
            });
            
            // Calculate balances
            filteredTransactions.forEach(transaction => {
                transaction.entries.forEach(entry => {
                    const account = accounts.find(a => a.code === entry.account);
                    if (account) {
                        // For assets, expenses: debit increases balance
                        // For liabilities, equity, revenue: credit increases balance
                        if (account.type === 'asset' || account.type === 'expense') {
                            balances[entry.account] += (entry.debit || 0) - (entry.credit || 0);
                        } else {
                            balances[entry.account] += (entry.credit || 0) - (entry.debit || 0);
                        }
                    }
                });
            });
            
            return balances;
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: settings.currency
            }).format(amount);
        }

        // Update all related data when changes occur
        function updateAllData() {
            updateDashboard();
            updateTransactionList();
            updateAssetList();
            updateAccountList();
            updateAccountSelects();
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize default data
            initializeDefaultUsers();
            initializeDefaultAccounts();
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    // Verify user still exists in users array
                    const userExists = users.find(u => u.username === currentUser.username);
                    if (userExists) {
                        // Show main app
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');
                        updateUserInfo();
                        applyRoleBasedAccess();
                    } else {
                        // User no longer exists, logout
                        logout();
                    }
                } catch (error) {
                    // Invalid saved user data, logout
                    logout();
                }
            }
            
            updateAllData();
            updateConnectionStatus();
            
            // Load saved Google Apps Script URL
            const savedUrl = localStorage.getItem('gasWebAppUrl');
            if (savedUrl) {
                const urlInput = document.getElementById('gasWebAppUrl');
                if (urlInput) {
                    urlInput.value = savedUrl;
                    GAS_CONFIG.webAppUrl = savedUrl;
                    // Auto-load data if URL is saved and user is logged in
                    if (currentUser) {
                        setTimeout(() => {
                            loadAllData();
                        }, 1000);
                    }
                }
            }
            
            // Set default values
            const startDateInput = document.getElementById('startDate');
            const companyNameInput = document.getElementById('companyName');
            const initialCashInput = document.getElementById('initialCash');
            
            if (startDateInput) startDateInput.value = new Date().toISOString().split('T')[0];
            if (companyNameInput) companyNameInput.value = 'PT. Contoh Perusahaan';
            if (initialCashInput) initialCashInput.value = '10000000';
            
            // Set default report dates to current month
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            const reportStartInput = document.getElementById('reportStartDate');
            const reportEndInput = document.getElementById('reportEndDate');
            
            if (reportStartInput) reportStartInput.value = firstDay.toISOString().split('T')[0];
            if (reportEndInput) reportEndInput.value = lastDay.toISOString().split('T')[0];
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96f5b0d744a0fd33',t:'MTc1NTIyOTQzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
